{"patch": "diff --git a/src/hash.c b/src/hash.c\nindex 289f02a91..c932160c9 100644\n--- a/src/hash.c\n+++ b/src/hash.c\n@@ -608,6 +608,15 @@ ib_it_init(mrb_state *mrb, index_buckets_iter *it, struct RHash *h, mrb_value ke\n   it->step = 0;\n }\n \n+static uint32_t\n+ib_ary_size_for(uint32_t ib_bit)\n+{\n+  uint32_t ary_size = IB_INIT_BIT == 4 ?\n+    ib_bit_to_capa(ib_bit) * 2 / IB_TYPE_BIT * ib_bit / 2 :\n+    ib_bit_to_capa(ib_bit) / IB_TYPE_BIT * ib_bit;\n+  return ary_size;\n+}\n+\n static void\n ib_it_next(index_buckets_iter *it)\n {\n@@ -635,9 +644,15 @@ ib_it_next(index_buckets_iter *it)\n   uint32_t slid_bit_pos = it->bit * (slid_pos + 1) - 1;\n   uint32_t slid_ary_index = slid_bit_pos / IB_TYPE_BIT;\n   it->ary_index = slid_ary_index + it->pos / IB_TYPE_BIT * it->bit;\n+  \n+  /* Bounds check to prevent buffer overflow */\n+  uint32_t max_ary_index = ib_ary_size_for(ib_bit(it->h));\n+  if (it->ary_index >= max_ary_index) return;\n+  \n   it->shift2 = (slid_ary_index + 1) * IB_TYPE_BIT - slid_bit_pos - 1;\n   it->ea_index = (ht_ib(it->h)[it->ary_index] >> it->shift2) & it->mask;\n   if (IB_TYPE_BIT - it->bit < it->shift2) {\n+    if (it->ary_index == 0) return; /* Prevent underflow */\n     it->shift1 = IB_TYPE_BIT - it->shift2;\n     it->ea_index |= (ht_ib(it->h)[it->ary_index - 1] << it->shift1) & it->mask;\n   }\n@@ -656,14 +671,17 @@ ib_it_get(const index_buckets_iter *it)\n static void\n ib_it_set(index_buckets_iter *it, uint32_t ea_index)\n {\n+  uint32_t max_ary_index = ib_ary_size_for(ib_bit(it->h));\n   uint32_t mask, i;\n   it->ea_index = ea_index;\n   if (it->shift1) {\n     i = it->ary_index - 1;\n+    if (i >= max_ary_index) return; /* Bounds check */\n     mask = it->mask >> it->shift1;\n     ht_ib(it->h)[i] = (ht_ib(it->h)[i] & ~mask) | (ea_index >> it->shift1);\n   }\n   i = it->ary_index;\n+  if (i >= max_ary_index) return; /* Bounds check */\n   mask = it->mask << it->shift2;\n   ht_ib(it->h)[i] = (ht_ib(it->h)[i] & ~mask) | (ea_index << it->shift2);\n }\n", "result": false, "error": "Timeout"}