{"patch": "--- a/src/hash.c\n+++ b/src/hash.c\n@@ -633,16 +633,28 @@\n   /* Slide to handle as `capa == 32` to avoid 64-bit operations */\n   uint32_t slid_pos = it->pos & (IB_TYPE_BIT - 1);\n   uint32_t slid_bit_pos = it->bit * (slid_pos + 1) - 1;\n   uint32_t slid_ary_index = slid_bit_pos / IB_TYPE_BIT;\n   it->ary_index = slid_ary_index + it->pos / IB_TYPE_BIT * it->bit;\n   it->shift2 = (slid_ary_index + 1) * IB_TYPE_BIT - slid_bit_pos - 1;\n-  it->ea_index = (ht_ib(it->h)[it->ary_index] >> it->shift2) & it->mask;\n-  if (IB_TYPE_BIT - it->bit < it->shift2) {\n-    it->shift1 = IB_TYPE_BIT - it->shift2;\n-    it->ea_index |= (ht_ib(it->h)[it->ary_index - 1] << it->shift1) & it->mask;\n-  }\n-  else {\n-    it->shift1 = 0;\n-  }\n+  size_t ib_capa = ib_bit_to_capa(it->bit);\n+  size_t ib_ary_size = ib_capa / IB_TYPE_BIT * it->bit;\n+  if (it->ary_index >= ib_ary_size) {\n+    it->ea_index = ib_it_deleted_value(it);\n+    it->shift1 = 0;\n+    it->pos = ib_it_pos_for(it, it->pos + (++it->step));\n+    return;\n+  }\n+  it->ea_index = (ht_ib(it->h)[it->ary_index] >> it->shift2) & it->mask;\n+  if (IB_TYPE_BIT - it->bit < it->shift2) {\n+    it->shift1 = IB_TYPE_BIT - it->shift2;\n+    if (it->ary_index == 0) {\n+      it->ea_index = ib_it_deleted_value(it);\n+    } else {\n+      it->ea_index |= (ht_ib(it->h)[it->ary_index - 1] << it->shift1) & it->mask;\n+    }\n+  }\n+  else {\n+    it->shift1 = 0;\n+  }\n   it->pos = ib_it_pos_for(it, it->pos + (++it->step));\n }\n@@ -659,11 +659,19 @@\n   uint32_t mask, i;\n-  it->ea_index = ea_index;\n-  if (it->shift1) {\n-    i = it->ary_index - 1;\n-    mask = it->mask >> it->shift1;\n-    ht_ib(it->h)[i] = (ht_ib(it->h)[i] & ~mask) | (ea_index >> it->shift1);\n-  }\n-  i = it->ary_index;\n-  mask = it->mask << it->shift2;\n-  ht_ib(it->h)[i] = (ht_ib(it->h)[i] & ~mask) | (ea_index << it->shift2);\n+  it->ea_index = ea_index;\n+  size_t ib_capa = ib_bit_to_capa(it->bit);\n+  size_t ib_ary_size = ib_capa / IB_TYPE_BIT * it->bit;\n+  if (it->ary_index >= ib_ary_size)\n+    return;\n+  if (it->shift1) {\n+    i = it->ary_index - 1;\n+    if (i < ib_ary_size) {\n+      mask = it->mask >> it->shift1;\n+      ht_ib(it->h)[i] = (ht_ib(it->h)[i] & ~mask) | (ea_index >> it->shift1);\n+    }\n+  }\n+  i = it->ary_index;\n+  if (i < ib_ary_size) {\n+    mask = it->mask << it->shift2;\n+    ht_ib(it->h)[i] = (ht_ib(it->h)[i] & ~mask) | (ea_index << it->shift2);\n+  }\n }\n", "result": true}