{"patch": "--- a/src/hash.c\n+++ b/src/hash.c\n@@ -633,16 +633,25 @@\n   /* Slide to handle as `capa == 32` to avoid 64-bit operations */\n   uint32_t slid_pos = it->pos & (IB_TYPE_BIT - 1);\n   uint32_t slid_bit_pos = it->bit * (slid_pos + 1) - 1;\n   uint32_t slid_ary_index = slid_bit_pos / IB_TYPE_BIT;\n   it->ary_index = slid_ary_index + it->pos / IB_TYPE_BIT * it->bit;\n   it->shift2 = (slid_ary_index + 1) * IB_TYPE_BIT - slid_bit_pos - 1;\n-  it->ea_index = (ht_ib(it->h)[it->ary_index] >> it->shift2) & it->mask;\n-  if (IB_TYPE_BIT - it->bit < it->shift2) {\n-    it->shift1 = IB_TYPE_BIT - it->shift2;\n-    it->ea_index |= (ht_ib(it->h)[it->ary_index - 1] << it->shift1) & it->mask;\n-  }\n-  else {\n-    it->shift1 = 0;\n-  }\n+  uint32_t ib_ary_size = ib_bit_to_capa(it->bit) / IB_TYPE_BIT * it->bit;\n+  if (it->ary_index >= ib_ary_size) {\n+    /* Out of bounds, set to empty value and bail out */\n+    it->ea_index = it->mask;\n+    it->shift1 = 0;\n+  } else {\n+    it->ea_index = (ht_ib(it->h)[it->ary_index] >> it->shift2) & it->mask;\n+    if (IB_TYPE_BIT - it->bit < it->shift2) {\n+      it->shift1 = IB_TYPE_BIT - it->shift2;\n+      if (it->ary_index > 0 && it->ary_index - 1 < ib_ary_size) {\n+        it->ea_index |= (ht_ib(it->h)[it->ary_index - 1] << it->shift1) & it->mask;\n+      }\n+    }\n+    else {\n+      it->shift1 = 0;\n+    }\n+  }\n   it->pos = ib_it_pos_for(it, it->pos + (++it->step));\n }\n@@ -656,14 +656,19 @@\n static void\n ib_it_set(index_buckets_iter *it, uint32_t ea_index)\n {\n   uint32_t mask, i;\n   it->ea_index = ea_index;\n-  if (it->shift1) {\n-    i = it->ary_index - 1;\n-    mask = it->mask >> it->shift1;\n-    ht_ib(it->h)[i] = (ht_ib(it->h)[i] & ~mask) | (ea_index >> it->shift1);\n-  }\n-  i = it->ary_index;\n-  mask = it->mask << it->shift2;\n-  ht_ib(it->h)[i] = (ht_ib(it->h)[i] & ~mask) | (ea_index << it->shift2);\n+  uint32_t ib_ary_size = ib_bit_to_capa(it->bit) / IB_TYPE_BIT * it->bit;\n+  if (it->shift1) {\n+    i = it->ary_index - 1;\n+    mask = it->mask >> it->shift1;\n+    if (i < ib_ary_size) {\n+      ht_ib(it->h)[i] = (ht_ib(it->h)[i] & ~mask) | (ea_index >> it->shift1);\n+    }\n+  }\n+  i = it->ary_index;\n+  mask = it->mask << it->shift2;\n+  if (i < ib_ary_size) {\n+    ht_ib(it->h)[i] = (ht_ib(it->h)[i] & ~mask) | (ea_index << it->shift2);\n+  }\n }\n", "result": true}