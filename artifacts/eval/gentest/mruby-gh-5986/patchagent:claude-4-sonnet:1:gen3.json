{"patch": "diff --git a/src/string.c b/src/string.c\nindex 1bd3f6f8f..7ec1c1707 100644\n--- a/src/string.c\n+++ b/src/string.c\n@@ -2950,10 +2950,16 @@ str_bytesplice(mrb_state *mrb, mrb_value str, mrb_int idx1, mrb_int len1, mrb_va\n   if (RSTR_LEN(s) < idx1 || RSTRING_LEN(replace) < idx2) {\n     mrb_raise(mrb, E_INDEX_ERROR, \"index out of string\");\n   }\n-  if (RSTR_LEN(s) <= idx1+len1) {\n+  if (len1 > 0 && idx1 > MRB_INT_MAX - len1) {\n     len1 = RSTR_LEN(s) - idx1;\n   }\n-  if (RSTRING_LEN(replace) <= idx2+len2) {\n+  else if (RSTR_LEN(s) <= idx1+len1) {\n+    len1 = RSTR_LEN(s) - idx1;\n+  }\n+  if (len2 > 0 && idx2 > MRB_INT_MAX - len2) {\n+    len2 = RSTRING_LEN(replace) - idx2;\n+  }\n+  else if (RSTRING_LEN(replace) <= idx2+len2) {\n     len2 = RSTRING_LEN(replace) - idx2;\n   }\n   if (len2 == 0) return str;\n@@ -2961,14 +2967,16 @@ str_bytesplice(mrb_state *mrb, mrb_value str, mrb_int idx1, mrb_int len1, mrb_va\n   if (len1 >= len2) {\n     memmove(RSTR_PTR(s)+idx1, RSTRING_PTR(replace)+idx2, len2);\n     if (len1 > len2) {\n-      memmove(RSTR_PTR(s)+idx1+len2, RSTR_PTR(s)+idx1+len1, RSTR_LEN(s)-(idx1+len1));\n+      mrb_int end_pos = (len1 > MRB_INT_MAX - idx1) ? RSTR_LEN(s) : idx1 + len1;\n+      memmove(RSTR_PTR(s)+idx1+len2, RSTR_PTR(s)+idx1+len1, RSTR_LEN(s)-end_pos);\n       RSTR_SET_LEN(s, RSTR_LEN(s)-(len1-len2));\n     }\n   }\n   else { /* len1 < len2 */\n     mrb_int slen = RSTR_LEN(s);\n+    mrb_int end_pos = (len1 > MRB_INT_MAX - idx1) ? slen : idx1 + len1;\n     mrb_str_resize(mrb, str, slen+len2-len1);\n-    memmove(RSTR_PTR(s)+idx1+len2, RSTR_PTR(s)+idx1+len1, slen-(idx1+len1));\n+    memmove(RSTR_PTR(s)+idx1+len2, RSTR_PTR(s)+idx1+len1, slen-end_pos);\n     memmove(RSTR_PTR(s)+idx1, RSTRING_PTR(replace)+idx2, len2);\n   }\n   return str;\n", "result": false, "error": "/gentest-mruby/mruby-gh-5986/generated_3.rb:49: negative len1 insertion test failed: RuntimeError: negative len1 should act as zero (insertion only) (RuntimeError)\n"}