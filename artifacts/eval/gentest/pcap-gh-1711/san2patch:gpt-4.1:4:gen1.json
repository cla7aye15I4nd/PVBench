{"patch": "diff --git a/Packet++/src/GtpLayer.cpp b/Packet++/src/GtpLayer.cpp\nindex 2e935cf5..8f1f289e 100644\n--- a/Packet++/src/GtpLayer.cpp\n+++ b/Packet++/src/GtpLayer.cpp\n@@ -398,7 +398,8 @@ namespace pcpp\n \t\t\t// add ext total length to offset\n \t\t\toffsetForNewExtension += lastExt.getTotalLength();\n \t\t}\n-\n+// FIXME: Crash CWE-416: Use After Free\n+ \n \t\t// allocate extension space in layer (assuming extension length can only be 4 bytes)\n \t\tif (!extendLayer(offsetForNewExtension, 4 * sizeof(uint8_t)))\n \t\t{\n@@ -406,20 +407,30 @@ namespace pcpp\n \t\t\treturn {};\n \t\t}\n \n-\t\t// lastExt != null means layer contains 1 or more extensions\n+\t\t// Re-acquire header and headerExtra after extendLayer\n+\t\theader = getHeader();\n+\t\theaderExtra = getHeaderExtra();\n+\n+\t\t// Re-calculate lastExt after extendLayer\n+\t\tGtpV1Layer::GtpExtension tempExt = getNextExtension();\n+\t\twhile (!tempExt.getNextExtension().isNull()) {\n+\t\t\tlastExt = tempExt;\n+\t\t\ttempExt = tempExt.getNextExtension();\n+\t\t}\n+\t\tif (!tempExt.isNull()) {\n+\t\t\tlastExt = tempExt;\n+\t\t}\n+\n \t\tif (!lastExt.isNull())\n \t\t{\n-\t\t\t// set the next header type in the last extension\n \t\t\tlastExt.setNextHeaderType(extensionType);\n \t\t}\n \t\telse\n \t\t{\n-\t\t\t// mark extension flags in the layer\n \t\t\theader->extensionHeaderFlag = 1;\n \t\t\theaderExtra->nextExtensionHeader = extensionType;\n \t\t}\n \n-\t\t// create the extension data and return the extension object to the user\n \t\treturn GtpV1Layer::GtpExtension::createGtpExtension(\n \t\t    m_Data + offsetForNewExtension, m_DataLen - offsetForNewExtension, extensionType, extensionContent);\n \t}\n", "result": true}