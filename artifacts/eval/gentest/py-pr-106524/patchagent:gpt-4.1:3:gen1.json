{"patch": "diff --git a/Modules/_sre/sre.c b/Modules/_sre/sre.c\nindex 3f11916f9e1..d8c35f7d7c5 100644\n--- a/Modules/_sre/sre.c\n+++ b/Modules/_sre/sre.c\n@@ -1544,11 +1544,24 @@ _sre_template_impl(PyObject *module, PyObject *pattern, PyObject *template)\n     for (Py_ssize_t i = 0; i < n; i++) {\n         Py_ssize_t index = PyLong_AsSsize_t(PyList_GET_ITEM(template, 2*i+1));\n         if (index == -1 && PyErr_Occurred()) {\n+            /* Clean up only initialized items */\n+            for (Py_ssize_t j = 0; j < i; j++) {\n+                Py_CLEAR(self->items[j].literal);\n+            }\n+            Py_CLEAR(self->literal);\n+            Py_SET_SIZE(self, i);\n             Py_DECREF(self);\n             return NULL;\n         }\n         if (index < 0) {\n-            goto bad_template;\n+            /* Clean up only initialized items */\n+            for (Py_ssize_t j = 0; j < i; j++) {\n+                Py_CLEAR(self->items[j].literal);\n+            }\n+            Py_CLEAR(self->literal);\n+            Py_SET_SIZE(self, i);\n+            Py_DECREF(self);\n+            goto bad_template_end;\n         }\n         self->items[i].index = index;\n \n@@ -1566,7 +1579,7 @@ _sre_template_impl(PyObject *module, PyObject *pattern, PyObject *template)\n \n bad_template:\n     PyErr_SetString(PyExc_TypeError, \"invalid template\");\n-    Py_XDECREF(self);\n+bad_template_end:\n     return NULL;\n }\n \n", "result": false, "error": "Traceback (most recent call last):\n  File \"/gentest-cpython/py-pr-106524/generated_1.py\", line 77, in <module>\n    main()\n  File \"/gentest-cpython/py-pr-106524/generated_1.py\", line 70, in main\n    test_negative_index_raises_typeerror_with_message()\n  File \"/gentest-cpython/py-pr-106524/generated_1.py\", line 11, in test_negative_index_raises_typeerror_with_message\n    _sre.template(\"\", [\"\", -1, \"\"])  # minimal invalid template (single pair)\n    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nSystemError: <built-in function template> returned NULL without setting an exception\n"}