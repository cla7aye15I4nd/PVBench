{"patch": "diff --git a/Modules/_sre/sre.c b/Modules/_sre/sre.c\nindex 3f11916f9e1..d8c35f7d7c5 100644\n--- a/Modules/_sre/sre.c\n+++ b/Modules/_sre/sre.c\n@@ -1544,11 +1544,24 @@ _sre_template_impl(PyObject *module, PyObject *pattern, PyObject *template)\n     for (Py_ssize_t i = 0; i < n; i++) {\n         Py_ssize_t index = PyLong_AsSsize_t(PyList_GET_ITEM(template, 2*i+1));\n         if (index == -1 && PyErr_Occurred()) {\n+            /* Clean up only initialized items */\n+            for (Py_ssize_t j = 0; j < i; j++) {\n+                Py_CLEAR(self->items[j].literal);\n+            }\n+            Py_CLEAR(self->literal);\n+            Py_SET_SIZE(self, i);\n             Py_DECREF(self);\n             return NULL;\n         }\n         if (index < 0) {\n-            goto bad_template;\n+            /* Clean up only initialized items */\n+            for (Py_ssize_t j = 0; j < i; j++) {\n+                Py_CLEAR(self->items[j].literal);\n+            }\n+            Py_CLEAR(self->literal);\n+            Py_SET_SIZE(self, i);\n+            Py_DECREF(self);\n+            goto bad_template_end;\n         }\n         self->items[i].index = index;\n \n@@ -1566,7 +1579,7 @@ _sre_template_impl(PyObject *module, PyObject *pattern, PyObject *template)\n \n bad_template:\n     PyErr_SetString(PyExc_TypeError, \"invalid template\");\n-    Py_XDECREF(self);\n+bad_template_end:\n     return NULL;\n }\n \n", "result": false, "error": "Traceback (most recent call last):\n  File \"/gentest-cpython/py-pr-106524/generated_2.py\", line 86, in <module>\n    test_invalid_negative_index_first()\n  File \"/gentest-cpython/py-pr-106524/generated_2.py\", line 32, in test_invalid_negative_index_first\n    run_case(\"A\", code, b\"OK A\")\n  File \"/gentest-cpython/py-pr-106524/generated_2.py\", line 12, in run_case\n    rc, out, err = assert_python_ok('-c', code)\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/tmp/py-pr-106524/build/Lib/test/support/script_helper.py\", line 166, in assert_python_ok\n    return _assert_python(True, *args, **env_vars)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/tmp/py-pr-106524/build/Lib/test/support/script_helper.py\", line 151, in _assert_python\n    res.fail(cmd_line)\n  File \"/tmp/py-pr-106524/build/Lib/test/support/script_helper.py\", line 76, in fail\n    raise AssertionError(\"Process return code is %d\\n\"\nAssertionError: Process return code is 1\ncommand line: ['/tmp/py-pr-106524/build/python', '-X', 'faulthandler', '-I', '-c', 'if 1:\\n    import _sre\\n    try:\\n        _sre.template(\"\", [\"\", -1, \"\"])\\n    except TypeError as e:\\n        msg = str(e)\\n        assert \"invalid template\" in msg, f\"Expected \\'invalid template\\' in error, got: {msg!r}\"\\n        print(\"OK A\")\\n    else:\\n        raise SystemExit(\"Expected TypeError for invalid template (negative index)\")\\n    ']\n\nstdout:\n---\n\n---\n\nstderr:\n---\nTraceback (most recent call last):\n  File \"<string>\", line 4, in <module>\nSystemError: <built-in function template> returned NULL without setting an exception\n---\n"}