{"patch": "diff --git a/Modules/_sre/sre.c b/Modules/_sre/sre.c\nindex 3f11916f9e1..d8c35f7d7c5 100644\n--- a/Modules/_sre/sre.c\n+++ b/Modules/_sre/sre.c\n@@ -1544,11 +1544,24 @@ _sre_template_impl(PyObject *module, PyObject *pattern, PyObject *template)\n     for (Py_ssize_t i = 0; i < n; i++) {\n         Py_ssize_t index = PyLong_AsSsize_t(PyList_GET_ITEM(template, 2*i+1));\n         if (index == -1 && PyErr_Occurred()) {\n+            /* Clean up only initialized items */\n+            for (Py_ssize_t j = 0; j < i; j++) {\n+                Py_CLEAR(self->items[j].literal);\n+            }\n+            Py_CLEAR(self->literal);\n+            Py_SET_SIZE(self, i);\n             Py_DECREF(self);\n             return NULL;\n         }\n         if (index < 0) {\n-            goto bad_template;\n+            /* Clean up only initialized items */\n+            for (Py_ssize_t j = 0; j < i; j++) {\n+                Py_CLEAR(self->items[j].literal);\n+            }\n+            Py_CLEAR(self->literal);\n+            Py_SET_SIZE(self, i);\n+            Py_DECREF(self);\n+            goto bad_template_end;\n         }\n         self->items[i].index = index;\n \n@@ -1566,7 +1579,7 @@ _sre_template_impl(PyObject *module, PyObject *pattern, PyObject *template)\n \n bad_template:\n     PyErr_SetString(PyExc_TypeError, \"invalid template\");\n-    Py_XDECREF(self);\n+bad_template_end:\n     return NULL;\n }\n \n", "result": false, "error": "Traceback (most recent call last):\n  File \"/gentest-cpython/py-pr-106524/generated_3.py\", line 112, in <module>\n    main()\n  File \"/gentest-cpython/py-pr-106524/generated_3.py\", line 103, in main\n    test_no_crash_and_typeerror_on_negative_index_subprocess()\n  File \"/gentest-cpython/py-pr-106524/generated_3.py\", line 23, in test_no_crash_and_typeerror_on_negative_index_subprocess\n    rc, out, err = assert_python_ok('-c', code)\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/tmp/py-pr-106524/build/Lib/test/support/script_helper.py\", line 166, in assert_python_ok\n    return _assert_python(True, *args, **env_vars)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/tmp/py-pr-106524/build/Lib/test/support/script_helper.py\", line 151, in _assert_python\n    res.fail(cmd_line)\n  File \"/tmp/py-pr-106524/build/Lib/test/support/script_helper.py\", line 76, in fail\n    raise AssertionError(\"Process return code is %d\\n\"\nAssertionError: Process return code is 1\ncommand line: ['/tmp/py-pr-106524/build/python', '-X', 'faulthandler', '-I', '-c', 'if 1:\\n        import _sre\\n        try:\\n            _sre.template(\"\", [\"\", -1, \"\"])  # invalid negative group index\\n        except TypeError as e:\\n            # Print marker to stdout to assert behavior and avoid non-zero exit\\n            print(\"OK:TypeError\", str(e))\\n        else:\\n            print(\"FAIL: no exception\")\\n    ']\n\nstdout:\n---\n\n---\n\nstderr:\n---\nTraceback (most recent call last):\n  File \"<string>\", line 4, in <module>\nSystemError: <built-in function template> returned NULL without setting an exception\n---\n"}