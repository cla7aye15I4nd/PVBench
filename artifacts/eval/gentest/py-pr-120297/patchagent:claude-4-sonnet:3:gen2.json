{"patch": "diff --git a/Modules/_lsprof.c b/Modules/_lsprof.c\nindex 5cf9eba243b..3eb3218d11b 100644\n--- a/Modules/_lsprof.c\n+++ b/Modules/_lsprof.c\n@@ -307,13 +307,25 @@ initContext(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n         if (subentry)\n             ++subentry->recursionLevel;\n     }\n-    self->t0 = call_timer(pObj);\n+    PyTime_t timer_result = call_timer(pObj);\n+    /* Check if the context is still valid after call_timer, as it may have\n+       triggered Python code that called profiler_disable and freed this context */\n+    if (pObj->currentProfilerContext == self) {\n+        self->t0 = timer_result;\n+    }\n }\n \n static void\n Stop(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n {\n-    PyTime_t tt = call_timer(pObj) - self->t0;\n+    PyTime_t timer_result = call_timer(pObj);\n+    /* Check if the context is still valid after call_timer, as it may have\n+       triggered Python code that called profiler_disable and freed this context */\n+    if (pObj->currentProfilerContext != self) {\n+        return;\n+    }\n+    \n+    PyTime_t tt = timer_result - self->t0;\n     PyTime_t it = tt - self->subt;\n     if (self->previous)\n         self->previous->subt += tt;\n@@ -386,6 +398,7 @@ static void\n ptrace_leave_call(PyObject *self, void *key)\n {\n     /* leaving a call to the function identified by 'key' */\n+    ProfilerContext *saved_pContext;\n     ProfilerObject *pObj = (ProfilerObject*)self;\n     ProfilerEntry *profEntry;\n     ProfilerContext *pContext;\n@@ -393,16 +406,22 @@ ptrace_leave_call(PyObject *self, void *key)\n     pContext = pObj->currentProfilerContext;\n     if (pContext == NULL)\n         return;\n+    saved_pContext = pContext;\n     profEntry = getEntry(pObj, key);\n     if (profEntry) {\n         Stop(pObj, pContext, profEntry);\n+        /* Check if the context is still valid after Stop, as it may have\n+           triggered Python code that called profiler_disable and freed this context */\n+        if (pObj->currentProfilerContext != saved_pContext) {\n+            return;\n+        }\n     }\n     else {\n         pObj->currentProfilerContext = pContext->previous;\n     }\n     /* put pContext into the free list */\n-    pContext->previous = pObj->freelistProfilerContext;\n-    pObj->freelistProfilerContext = pContext;\n+    saved_pContext->previous = pObj->freelistProfilerContext;\n+    pObj->freelistProfilerContext = saved_pContext;\n }\n \n static int\n", "result": true}