{"patch": "diff --git a/Modules/_lsprof.c b/Modules/_lsprof.c\nindex 5cf9eba243b..954dbb0b96f 100644\n--- a/Modules/_lsprof.c\n+++ b/Modules/_lsprof.c\n@@ -291,7 +291,7 @@ static void clearEntries(ProfilerObject *pObj)\n }\n \n static void\n-initContext(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n+initContext(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry, PyTime_t t0)\n {\n     self->ctxEntry = entry;\n     self->subt = 0;\n@@ -307,13 +307,13 @@ initContext(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n         if (subentry)\n             ++subentry->recursionLevel;\n     }\n-    self->t0 = call_timer(pObj);\n+    self->t0 = t0;\n }\n \n static void\n-Stop(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n+Stop(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry, PyTime_t t1)\n {\n-    PyTime_t tt = call_timer(pObj) - self->t0;\n+    PyTime_t tt = t1 - self->t0;\n     PyTime_t it = tt - self->subt;\n     if (self->previous)\n         self->previous->subt += tt;\n@@ -376,7 +376,8 @@ ptrace_enter_call(PyObject *self, void *key, PyObject *userObj)\n             goto restorePyerr;\n         }\n     }\n-    initContext(pObj, pContext, profEntry);\n+    PyTime_t t0 = call_timer(pObj);\n+    initContext(pObj, pContext, profEntry, t0);\n \n restorePyerr:\n     PyErr_SetRaisedException(exc);\n@@ -389,13 +390,15 @@ ptrace_leave_call(PyObject *self, void *key)\n     ProfilerObject *pObj = (ProfilerObject*)self;\n     ProfilerEntry *profEntry;\n     ProfilerContext *pContext;\n+    PyTime_t t1;\n \n+    t1 = call_timer(pObj);\n     pContext = pObj->currentProfilerContext;\n     if (pContext == NULL)\n         return;\n     profEntry = getEntry(pObj, key);\n     if (profEntry) {\n-        Stop(pObj, pContext, profEntry);\n+        Stop(pObj, pContext, profEntry, t1);\n     }\n     else {\n         pObj->currentProfilerContext = pContext->previous;\n@@ -759,7 +762,7 @@ flush_unmatched(ProfilerObject *pObj)\n         ProfilerContext *pContext = pObj->currentProfilerContext;\n         ProfilerEntry *profEntry= pContext->ctxEntry;\n         if (profEntry)\n-            Stop(pObj, pContext, profEntry);\n+            Stop(pObj, pContext, profEntry, call_timer(pObj));\n         else\n             pObj->currentProfilerContext = pContext->previous;\n         if (pContext)\n", "result": false, "error": "Traceback (most recent call last):\n  File \"/gentest-cpython/py-pr-120297/generated_3.py\", line 208, in <module>\n    main()\n    ~~~~^^\n  File \"/gentest-cpython/py-pr-120297/generated_3.py\", line 202, in main\n    run_and_check('clear-call', code_clear_on_call)\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/gentest-cpython/py-pr-120297/generated_3.py\", line 5, in run_and_check\n    rc, out, err = assert_python_ok('-c', code)\n                   ~~~~~~~~~~~~~~~~^^^^^^^^^^^^\n  File \"/tmp/py-pr-120297/build/Lib/test/support/script_helper.py\", line 182, in assert_python_ok\n    return _assert_python(True, *args, **env_vars)\n  File \"/tmp/py-pr-120297/build/Lib/test/support/script_helper.py\", line 167, in _assert_python\n    res.fail(cmd_line)\n    ~~~~~~~~^^^^^^^^^^\n  File \"/tmp/py-pr-120297/build/Lib/test/support/script_helper.py\", line 80, in fail\n    raise AssertionError(f\"Process return code is {exitcode}\\n\"\n    ...<10 lines>...\n                         f\"---\")\nAssertionError: Process return code is 1\ncommand line: ['/tmp/py-pr-120297/build/python', '-X', 'faulthandler', '-I', '-c', \"if 1:\\n    import _lsprof, sys\\n\\n    prof = None\\n\\n    class ClearTimer:\\n        def __init__(self, trip_at):\\n            self.count = 0\\n            self.trip_at = trip_at\\n        def __call__(self):\\n            global prof\\n            self.count += 1\\n            if self.count == self.trip_at:\\n                prof.clear()\\n            return self.count\\n\\n    def do_one_call_and_return():\\n        (lambda: None)()\\n\\n    captured = {}\\n    def hook(unraisable):\\n        captured['type'] = unraisable.exc_type\\n        captured['value'] = unraisable.exc_value\\n    sys.unraisablehook = hook\\n\\n    prof = _lsprof.Profiler(ClearTimer(1))  # trigger on call event\\n    prof.enable()\\n    do_one_call_and_return()\\n    prof.disable()\\n    prof.clear()\\n\\n    if captured.get('type') is RuntimeError and 'cannot clear profiler in external timer' in str(captured.get('value')):\\n        print('PASS clear-call')\\n    else:\\n        print('SKIP clear-call')\\n\"]\n\nstdout:\n---\n\n---\n\nstderr:\n---\n=================================================================\n==2988605==ERROR: AddressSanitizer: heap-use-after-free on address 0x50700007bb30 at pc 0x7f0387570996 bp 0x7ffc336bd050 sp 0x7ffc336bd048\nREAD of size 8 at 0x50700007bb30 thread T0\n    #0 0x7f0387570995 in initContext /tmp/py-pr-120297/build/./Modules/_lsprof.c:300:5\n    #1 0x7f038756f9f1 in ptrace_enter_call /tmp/py-pr-120297/build/./Modules/_lsprof.c:380:5\n    #2 0x7f038756f841 in pystart_callback /tmp/py-pr-120297/build/./Modules/_lsprof.c:607:5\n    #3 0x562f3ed2806d in cfunction_vectorcall_FASTCALL /tmp/py-pr-120297/build/Objects/methodobject.c:425:24\n    #4 0x562f3f13871f in _PyObject_VectorcallTstate /tmp/py-pr-120297/build/./Include/internal/pycore_call.h:167:11\n    #5 0x562f3f131b67 in call_one_instrument /tmp/py-pr-120297/build/Python/instrumentation.c:907:21\n    #6 0x562f3f12f8ac in call_instrumentation_vector /tmp/py-pr-120297/build/Python/instrumentation.c:1095:19\n    #7 0x562f3f12f5ac in _Py_call_instrumentation /tmp/py-pr-120297/build/Python/instrumentation.c:1132:12\n    #8 0x562f3f0037a3 in _PyEval_EvalFrameDefault /tmp/py-pr-120297/build/Python/generated_cases.c.h:3791:27\n    #9 0x562f3efe1f01 in _PyEval_EvalFrame /tmp/py-pr-120297/build/./Include/internal/pycore_ceval.h:119:16\n    #10 0x562f3efe1dfe in _PyEval_Vector /tmp/py-pr-120297/build/Python/ceval.c:1866:12\n    #11 0x562f3efe177c in PyEval_EvalCode /tmp/py-pr-120297/build/Python/ceval.c:624:21\n    #12 0x562f3f194693 in run_eval_code_obj /tmp/py-pr-120297/build/Python/pythonrun.c:1292:9\n    #13 0x562f3f1943cb in run_mod /tmp/py-pr-120297/build/Python/pythonrun.c:1377:19\n    #14 0x562f3f190616 in _PyRun_StringFlagsWithName /tmp/py-pr-120297/build/Python/pythonrun.c:1176:15\n    #15 0x562f3f19027e in _PyRun_SimpleStringFlagsWithName /tmp/py-pr-120297/build/Python/pythonrun.c:516:15\n    #16 0x562f3f227467 in pymain_run_command "}