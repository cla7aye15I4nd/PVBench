{"patch": "diff --git a/Modules/_lsprof.c b/Modules/_lsprof.c\nindex 5cf9eba243b..87caca8cd89 100644\n--- a/Modules/_lsprof.c\n+++ b/Modules/_lsprof.c\n@@ -296,7 +296,6 @@ initContext(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n     self->ctxEntry = entry;\n     self->subt = 0;\n     self->previous = pObj->currentProfilerContext;\n-    pObj->currentProfilerContext = self;\n     ++entry->recursionLevel;\n     if ((pObj->flags & POF_SUBCALLS) && self->previous) {\n         /* find or create an entry for me in my caller's entry */\n@@ -308,25 +307,32 @@ initContext(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n             ++subentry->recursionLevel;\n     }\n     self->t0 = call_timer(pObj);\n+    pObj->currentProfilerContext = self;\n }\n \n static void\n Stop(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n {\n-    PyTime_t tt = call_timer(pObj) - self->t0;\n-    PyTime_t it = tt - self->subt;\n-    if (self->previous)\n-        self->previous->subt += tt;\n-    pObj->currentProfilerContext = self->previous;\n+    /* Save context values before calling timer to avoid use-after-free */\n+    PyTime_t t0 = self->t0;\n+    PyTime_t subt = self->subt;\n+    ProfilerContext *previous = self->previous;\n+    \n+    PyTime_t current_time = call_timer(pObj);\n+    PyTime_t tt = current_time - t0;\n+    PyTime_t it = tt - subt;\n+    if (previous)\n+        previous->subt += tt;\n+    pObj->currentProfilerContext = previous;\n     if (--entry->recursionLevel == 0)\n         entry->tt += tt;\n     else\n         ++entry->recursivecallcount;\n     entry->it += it;\n     entry->callcount++;\n-    if ((pObj->flags & POF_SUBCALLS) && self->previous) {\n+    if ((pObj->flags & POF_SUBCALLS) && previous) {\n         /* find or create an entry for me in my caller's entry */\n-        ProfilerEntry *caller = self->previous->ctxEntry;\n+        ProfilerEntry *caller = previous->ctxEntry;\n         ProfilerSubEntry *subentry = getSubEntry(pObj, caller, entry);\n         if (subentry) {\n             if (--subentry->recursionLevel == 0)\n@@ -396,6 +402,9 @@ ptrace_leave_call(PyObject *self, void *key)\n     profEntry = getEntry(pObj, key);\n     if (profEntry) {\n         Stop(pObj, pContext, profEntry);\n+        /* Check if profiler is still enabled after Stop call */\n+        if (!(pObj->flags & POF_ENABLED))\n+            return;\n     }\n     else {\n         pObj->currentProfilerContext = pContext->previous;\n", "result": true}