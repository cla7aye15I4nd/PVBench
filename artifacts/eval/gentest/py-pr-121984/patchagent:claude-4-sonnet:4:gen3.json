{"patch": "diff --git a/Modules/_lsprof.c b/Modules/_lsprof.c\nindex 5cf9eba243b..7f4f63241d4 100644\n--- a/Modules/_lsprof.c\n+++ b/Modules/_lsprof.c\n@@ -60,6 +60,7 @@ typedef struct {\n #define POF_SUBCALLS    0x002\n #define POF_BUILTINS    0x004\n #define POF_NOMEMORY    0x100\n+#define POF_IN_CRITICAL 0x200\n \n /*[clinic input]\n module _lsprof\n@@ -294,6 +295,7 @@ static void\n initContext(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n {\n     self->ctxEntry = entry;\n+    pObj->flags |= POF_IN_CRITICAL;\n     self->subt = 0;\n     self->previous = pObj->currentProfilerContext;\n     pObj->currentProfilerContext = self;\n@@ -308,11 +310,13 @@ initContext(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n             ++subentry->recursionLevel;\n     }\n     self->t0 = call_timer(pObj);\n+    pObj->flags &= ~POF_IN_CRITICAL;\n }\n \n static void\n Stop(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n {\n+    pObj->flags |= POF_IN_CRITICAL;\n     PyTime_t tt = call_timer(pObj) - self->t0;\n     PyTime_t it = tt - self->subt;\n     if (self->previous)\n@@ -337,6 +341,7 @@ Stop(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n             ++subentry->callcount;\n         }\n     }\n+    pObj->flags &= ~POF_IN_CRITICAL;\n }\n \n static void\n@@ -779,6 +784,11 @@ profiler_disable(ProfilerObject *self, PyObject* noarg)\n {\n     if (self->flags & POF_ENABLED) {\n         PyObject* result = NULL;\n+        \n+        /* Don't disable if we're in a critical section */\n+        if (self->flags & POF_IN_CRITICAL) {\n+            Py_RETURN_NONE;\n+        }\n         PyObject* monitoring = _PyImport_GetModuleAttrString(\"sys\", \"monitoring\");\n \n         if (!monitoring) {\n", "result": false, "error": "Traceback (most recent call last):\n  File \"/gentest-cpython/py-pr-121984/generated_3.py\", line 148, in <module>\n    test_disable_inside_timer_both_events()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"/gentest-cpython/py-pr-121984/generated_3.py\", line 123, in test_disable_inside_timer_both_events\n    assert oks.count('OK') == 2, f\"Expected two 'OK' lines on patched build, got: {out!r}, stderr={err!r}\"\n           ^^^^^^^^^^^^^^^^^^^^\nAssertionError: Expected two 'OK' lines on patched build, got: 'NO-UNRAISABLE\\nNO-UNRAISABLE\\n', stderr=''\n"}