{"patch": "diff --git a/Modules/_lsprof.c b/Modules/_lsprof.c\nindex 5cf9eba243b..b043d7f5535 100644\n--- a/Modules/_lsprof.c\n+++ b/Modules/_lsprof.c\n@@ -757,15 +757,25 @@ flush_unmatched(ProfilerObject *pObj)\n {\n     while (pObj->currentProfilerContext) {\n         ProfilerContext *pContext = pObj->currentProfilerContext;\n-        ProfilerEntry *profEntry= pContext->ctxEntry;\n-        if (profEntry)\n+        ProfilerEntry *profEntry = pContext->ctxEntry;\n+        ProfilerContext *prev = pContext->previous;\n+        if (profEntry) {\n             Stop(pObj, pContext, profEntry);\n-        else\n-            pObj->currentProfilerContext = pContext->previous;\n-        if (pContext)\n+            /* Do not free pContext here, as Stop updates currentProfilerContext and may still reference pContext */\n+        } else {\n+            pObj->currentProfilerContext = prev;\n             PyMem_Free(pContext);\n+        }\n     }\n+    pObj->currentProfilerContext = NULL;\n \n+    /* Also clear the freelist to avoid use-after-free */\n+    while (pObj->freelistProfilerContext) {\n+        ProfilerContext *c = pObj->freelistProfilerContext;\n+        pObj->freelistProfilerContext = c->previous;\n+        PyMem_Free(c);\n+    }\n+    pObj->freelistProfilerContext = NULL;\n }\n \n PyDoc_STRVAR(disable_doc, \"\\\n", "result": false, "error": "Traceback (most recent call last):\n  File \"/gentest-cpython/py-pr-121984/generated_3.py\", line 148, in <module>\n    test_disable_inside_timer_both_events()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"/gentest-cpython/py-pr-121984/generated_3.py\", line 123, in test_disable_inside_timer_both_events\n    assert oks.count('OK') == 2, f\"Expected two 'OK' lines on patched build, got: {out!r}, stderr={err!r}\"\n           ^^^^^^^^^^^^^^^^^^^^\nAssertionError: Expected two 'OK' lines on patched build, got: 'NO-UNRAISABLE\\nNO-UNRAISABLE\\n', stderr=''\n"}