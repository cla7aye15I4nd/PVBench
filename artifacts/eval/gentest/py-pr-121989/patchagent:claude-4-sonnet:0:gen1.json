{"patch": "diff --git a/Modules/_lsprof.c b/Modules/_lsprof.c\nindex 257de4387c0..4175258934b 100644\n--- a/Modules/_lsprof.c\n+++ b/Modules/_lsprof.c\n@@ -56,6 +56,7 @@ typedef struct {\n #define POF_ENABLED     0x001\n #define POF_SUBCALLS    0x002\n #define POF_BUILTINS    0x004\n+#define POF_DISABLING   0x008\n #define POF_NOMEMORY    0x100\n \n /*[clinic input]\n@@ -289,6 +290,11 @@ static void clearEntries(ProfilerObject *pObj)\n static void\n initContext(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n {\n+    /* Call timer before linking context to avoid use-after-free if\n+       timer callback triggers profiler_disable */\n+    pObj->flags |= POF_DISABLING;\n+    _PyTime_t t0 = call_timer(pObj);\n+    pObj->flags &= ~POF_DISABLING;\n     self->ctxEntry = entry;\n     self->subt = 0;\n     self->previous = pObj->currentProfilerContext;\n@@ -303,13 +309,18 @@ initContext(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n         if (subentry)\n             ++subentry->recursionLevel;\n     }\n-    self->t0 = call_timer(pObj);\n+    self->t0 = t0;\n }\n \n static void\n Stop(ProfilerObject *pObj, ProfilerContext *self, ProfilerEntry *entry)\n {\n-    _PyTime_t tt = call_timer(pObj) - self->t0;\n+    /* Call timer before accessing context fields to avoid use-after-free if\n+       timer callback triggers profiler_disable */\n+    pObj->flags |= POF_DISABLING;\n+    _PyTime_t t1 = call_timer(pObj);\n+    pObj->flags &= ~POF_DISABLING;\n+    _PyTime_t tt = t1 - self->t0;\n     _PyTime_t it = tt - self->subt;\n     if (self->previous)\n         self->previous->subt += tt;\n@@ -775,6 +786,10 @@ profiler_disable(ProfilerObject *self, PyObject* noarg)\n {\n     if (self->flags & POF_ENABLED) {\n         PyObject* result = NULL;\n+        /* Don't disable if we're in the middle of timer operations */\n+        if (self->flags & POF_DISABLING) {\n+            Py_RETURN_NONE;\n+        }\n         PyObject* monitoring = _PyImport_GetModuleAttrString(\"sys\", \"monitoring\");\n \n         if (!monitoring) {\n", "result": false, "error": "Traceback (most recent call last):\n  File \"/gentest-cpython/py-pr-121989/generated_1.py\", line 186, in <module>\n    test_disable_in_external_timer_disallowed_call_and_return_events()\n  File \"/gentest-cpython/py-pr-121989/generated_1.py\", line 70, in test_disable_in_external_timer_disallowed_call_and_return_events\n    run_subprocess_and_check(code, expected)\n  File \"/gentest-cpython/py-pr-121989/generated_1.py\", line 35, in run_subprocess_and_check\n    assert s in err, f\"Expected {s!r} in stderr, got: {err!r}\"\n           ^^^^^^^^\nAssertionError: Expected b'RuntimeError: cannot disable profiler in external timer' in stderr, got: b''\n"}