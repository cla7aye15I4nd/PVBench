{"patch": "diff --git a/Modules/_lsprof.c b/Modules/_lsprof.c\nindex 257de4387c0..8b86cb612d8 100644\n--- a/Modules/_lsprof.c\n+++ b/Modules/_lsprof.c\n@@ -753,13 +753,21 @@ flush_unmatched(ProfilerObject *pObj)\n {\n     while (pObj->currentProfilerContext) {\n         ProfilerContext *pContext = pObj->currentProfilerContext;\n-        ProfilerEntry *profEntry= pContext->ctxEntry;\n-        if (profEntry)\n+        ProfilerEntry *profEntry = pContext->ctxEntry;\n+        if (profEntry) {\n+            /* Stop will update currentProfilerContext and put pContext into the freelist */\n             Stop(pObj, pContext, profEntry);\n-        else\n+            /* DO NOT free pContext here; it is now in the freelist and will be freed below. */\n+        } else {\n             pObj->currentProfilerContext = pContext->previous;\n-        if (pContext)\n             PyMem_Free(pContext);\n+        }\n+    }\n+    /* Now free all contexts in the freelist */\n+    while (pObj->freelistProfilerContext) {\n+        ProfilerContext *c = pObj->freelistProfilerContext;\n+        pObj->freelistProfilerContext = c->previous;\n+        PyMem_Free(c);\n     }\n \n }\n", "result": false, "error": "Traceback (most recent call last):\n  File \"/gentest-cpython/py-pr-121989/generated_1.py\", line 186, in <module>\n    test_disable_in_external_timer_disallowed_call_and_return_events()\n  File \"/gentest-cpython/py-pr-121989/generated_1.py\", line 70, in test_disable_in_external_timer_disallowed_call_and_return_events\n    run_subprocess_and_check(code, expected)\n  File \"/gentest-cpython/py-pr-121989/generated_1.py\", line 35, in run_subprocess_and_check\n    assert s in err, f\"Expected {s!r} in stderr, got: {err!r}\"\n           ^^^^^^^^\nAssertionError: Expected b'RuntimeError: cannot disable profiler in external timer' in stderr, got: b''\n"}