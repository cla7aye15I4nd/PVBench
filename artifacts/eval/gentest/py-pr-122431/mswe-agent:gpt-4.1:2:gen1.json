{"patch": "diff --git a/.gitignore b/.gitignore\nindex 8872e9d5508..959a12bbd57 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -171,3 +171,9 @@ Python/frozen_modules/MANIFEST\n \n # main branch only: ABI files are not checked/maintained.\n Doc/data/python*.abi\n+build/\n+Build/\n+bin/\n+lib/\n+*.out\n+*.obj\ndiff --git a/Modules/readline.c b/Modules/readline.c\nindex 35655c70a46..efe4849f0ba 100644\n--- a/Modules/readline.c\n+++ b/Modules/readline.c\n@@ -362,8 +362,19 @@ readline_append_history_file_impl(PyObject *module, int nelements,\n         filename_bytes = NULL;\n         filename = NULL;\n     }\n-    errno = err = append_history(\n-        nelements - libedit_append_replace_history_offset, filename);\n+    /* Prevent integer overflow/underflow in nelements calculation */\n+    if (nelements < libedit_append_replace_history_offset) {\n+        PyErr_SetString(PyExc_ValueError, \"nelements is too small\");\n+        Py_XDECREF(filename_bytes);\n+        return NULL;\n+    }\n+    int safe_nelements = nelements - libedit_append_replace_history_offset;\n+    if (safe_nelements < 0 || safe_nelements > INT_MAX) {\n+        PyErr_SetString(PyExc_OverflowError, \"nelements calculation overflow\");\n+        Py_XDECREF(filename_bytes);\n+        return NULL;\n+    }\n+    errno = err = append_history(safe_nelements, filename);\n     if (!err && _history_length >= 0)\n         history_truncate_file(filename, _history_length);\n     Py_XDECREF(filename_bytes);\n", "result": false, "error": "Traceback (most recent call last):\n  File \"/gentest-cpython/py-pr-122431/generated_1.py\", line 30, in test_negative_prefers_value_error_but_tolerates_legacy\n    readline.append_history_file(-1, path)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^\nValueError: nelements is too small\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/gentest-cpython/py-pr-122431/generated_1.py\", line 124, in <module>\n    main()\n    ~~~~^^\n  File \"/gentest-cpython/py-pr-122431/generated_1.py\", line 117, in main\n    test_negative_prefers_value_error_but_tolerates_legacy()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"/gentest-cpython/py-pr-122431/generated_1.py\", line 33, in test_negative_prefers_value_error_but_tolerates_legacy\n    assert \"positive\" in msg and \"nelements\" in msg, (\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAssertionError: Error message should mention 'nelements' and 'positive'. Got: 'nelements is too small'\n"}