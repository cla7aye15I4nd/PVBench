{"patch": "diff --git a/Modules/readline.c b/Modules/readline.c\nindex 35655c70a46..cf053d61a5e 100644\n--- a/Modules/readline.c\n+++ b/Modules/readline.c\n@@ -362,13 +362,30 @@ readline_append_history_file_impl(PyObject *module, int nelements,\n         filename_bytes = NULL;\n         filename = NULL;\n     }\n+    /* Validate nelements to prevent invalid history access */\n+    if (nelements < 0) {\n+        Py_XDECREF(filename_bytes);\n+        PyErr_SetString(PyExc_ValueError, \"nelements must be non-negative\");\n+        return NULL;\n+    }\n+    /* Store errno to restore later and avoid potential race conditions */\n+    int saved_errno = errno;\n     errno = err = append_history(\n         nelements - libedit_append_replace_history_offset, filename);\n-    if (!err && _history_length >= 0)\n-        history_truncate_file(filename, _history_length);\n+    if (!err && _history_length >= 0) {\n+        /* Verify history state is still valid before truncating */\n+        if (history_get_history_state() != NULL) {\n+            history_truncate_file(filename, _history_length);\n+        }\n+    }\n     Py_XDECREF(filename_bytes);\n-    errno = err;\n-    if (errno)\n+    /* Only update errno if an actual error occurred */\n+    if (err != 0) {\n+        errno = err;\n+    } else {\n+        errno = saved_errno;\n+    }\n+    if (errno && err != 0)\n         return PyErr_SetFromErrno(PyExc_OSError);\n     Py_RETURN_NONE;\n }\n", "result": false, "error": "Traceback (most recent call last):\n  File \"/gentest-cpython/py-pr-122431/generated_1.py\", line 30, in test_negative_prefers_value_error_but_tolerates_legacy\n    readline.append_history_file(-1, path)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^\nValueError: nelements must be non-negative\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/gentest-cpython/py-pr-122431/generated_1.py\", line 124, in <module>\n    main()\n    ~~~~^^\n  File \"/gentest-cpython/py-pr-122431/generated_1.py\", line 117, in main\n    test_negative_prefers_value_error_but_tolerates_legacy()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"/gentest-cpython/py-pr-122431/generated_1.py\", line 33, in test_negative_prefers_value_error_but_tolerates_legacy\n    assert \"positive\" in msg and \"nelements\" in msg, (\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAssertionError: Error message should mention 'nelements' and 'positive'. Got: 'nelements must be non-negative'\n"}