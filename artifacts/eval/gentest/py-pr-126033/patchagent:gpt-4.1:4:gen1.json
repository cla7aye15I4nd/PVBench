{"patch": "diff --git a/Modules/_elementtree.c b/Modules/_elementtree.c\nindex b73bd844626..5dbf0a2c583 100644\n--- a/Modules/_elementtree.c\n+++ b/Modules/_elementtree.c\n@@ -1630,43 +1630,67 @@ _elementtree_Element_remove_impl(ElementObject *self, PyObject *subelement)\n {\n     Py_ssize_t i;\n     int rc;\n-    PyObject *found;\n+    PyObject *found = NULL;\n+    ElementObjectExtra *extra = self ? self->extra : NULL;\n+    Py_ssize_t length;\n+    PyObject **children = NULL;\n \n-    if (!self->extra) {\n-        /* element has no children, so raise exception */\n+    if (!extra) {\n         PyErr_SetString(\n             PyExc_ValueError,\n             \"list.remove(x): x not in list\"\n-            );\n+        );\n         return NULL;\n     }\n \n-    for (i = 0; i < self->extra->length; i++) {\n-        if (self->extra->children[i] == subelement)\n+    length = extra->length;\n+    if (length > 0) {\n+        children = (PyObject **)PyMem_Malloc(sizeof(PyObject *) * length);\n+        if (!children) {\n+            PyErr_NoMemory();\n+            return NULL;\n+        }\n+        for (i = 0; i < length; i++) {\n+            children[i] = extra->children[i];\n+            Py_XINCREF(children[i]);\n+        }\n+    }\n+\n+    for (i = 0; i < length; i++) {\n+        if (children[i] == subelement)\n             break;\n-        rc = PyObject_RichCompareBool(self->extra->children[i], subelement, Py_EQ);\n+        rc = PyObject_RichCompareBool(children[i], subelement, Py_EQ);\n         if (rc > 0)\n             break;\n         if (rc < 0)\n-            return NULL;\n+            goto cleanup;\n     }\n \n-    if (i >= self->extra->length) {\n-        /* subelement is not in children, so raise exception */\n+    if (i >= length) {\n         PyErr_SetString(\n             PyExc_ValueError,\n             \"list.remove(x): x not in list\"\n-            );\n-        return NULL;\n+        );\n+        goto cleanup;\n     }\n \n-    found = self->extra->children[i];\n-\n-    self->extra->length--;\n-    for (; i < self->extra->length; i++)\n-        self->extra->children[i] = self->extra->children[i+1];\n-\n+    found = children[i];\n+    extra = self->extra;\n+    if (extra && i < extra->length && extra->children[i] == found) {\n+        extra->length--;\n+        for (; i < extra->length; i++)\n+            extra->children[i] = extra->children[i+1];\n+    }\n     Py_DECREF(found);\n+cleanup:\n+    if (children) {\n+        for (i = 0; i < length; i++) {\n+            Py_XDECREF(children[i]);\n+        }\n+        PyMem_Free(children);\n+    }\n+    if (PyErr_Occurred())\n+        return NULL;\n     Py_RETURN_NONE;\n }\n \n", "result": false, "error": "=================================================================\n==2760678==ERROR: AddressSanitizer: heap-use-after-free on address 0x513000094560 at pc 0x7fdd545721d4 bp 0x7ffee47403d0 sp 0x7ffee47403c8\nREAD of size 4 at 0x513000094560 thread T0\n    #0 0x7fdd545721d3 in _Py_IsImmortal /tmp/py-pr-126033/build/./Include/refcount.h:129:12\n    #1 0x7fdd545721d3 in Py_DECREF /tmp/py-pr-126033/build/./Include/refcount.h:427:9\n    #2 0x7fdd545721d3 in Py_XDECREF /tmp/py-pr-126033/build/./Include/refcount.h:526:9\n    #3 0x7fdd5458931e in _elementtree_Element_remove_impl /tmp/py-pr-126033/build/./Modules/_elementtree.c:1688:13\n    #4 0x7fdd54584c8f in _elementtree_Element_remove /tmp/py-pr-126033/build/./Modules/clinic/_elementtree.c.h:826:20\n    #5 0x562d36e564b0 in method_vectorcall_O /tmp/py-pr-126033/build/Objects/descrobject.c:476:24\n    #6 0x562d36e2d71f in _PyObject_VectorcallTstate /tmp/py-pr-126033/build/./Include/internal/pycore_call.h:169:11\n    #7 0x562d36e2f339 in PyObject_Vectorcall /tmp/py-pr-126033/build/Objects/call.c:327:12\n    #8 0x562d37238439 in _PyEval_EvalFrameDefault /tmp/py-pr-126033/build/Python/generated_cases.c.h:1366:35\n    #9 0x562d37231471 in _PyEval_EvalFrame /tmp/py-pr-126033/build/./Include/internal/pycore_ceval.h:119:16\n    #10 0x562d372312fc in _PyEval_Vector /tmp/py-pr-126033/build/Python/ceval.c:1908:12\n    #11 0x562d37230bda in PyEval_EvalCode /tmp/py-pr-126033/build/Python/ceval.c:836:21\n    #12 0x562d3740e116 in run_eval_code_obj /tmp/py-pr-126033/build/Python/pythonrun.c:1365:12\n    #13 0x562d3740de57 in run_mod /tmp/py-pr-126033/build/Python/pythonrun.c:1436:19\n    #14 0x562d374091c2 in pyrun_file /tmp/py-pr-126033/build/Python/pythonrun.c:1293:15\n    #15 0x562d37406fdd in _PyRun_SimpleFileObject /tmp/py-pr-126033/build/Python/pythonrun.c:521:13\n    #16 0x562d37406668 in _PyRun_AnyFileObject /tmp/py-pr-126033/build/Python/pythonrun.c:81:15\n    #17 0x562d374a7c96 in pymain_run_file_obj /tmp/py-pr-126033/build/Modules/main.c:396:15\n    #18 0x562d374a693c in pymain_run_file /tmp/py-pr-126033/build/Modules/main.c:415:15\n    #19 0x562d374a495f in pymain_run_python /tmp/py-pr-126033/build/Modules/main.c:680:21\n    #20 0x562d374a3c72 in Py_RunMain /tmp/py-pr-126033/build/Modules/main.c:761:5\n    #21 0x562d374a4da8 in pymain_main /tmp/py-pr-126033/build/Modules/main.c:791:12\n    #22 0x562d374a4eb7 in Py_BytesMain /tmp/py-pr-126033/build/Modules/main.c:815:12\n    #23 0x562d36c8b511 in main /tmp/py-pr-126033/build/./Programs/python.c:15:12\n    #24 0x7fdd5705a1c9  (/lib/x86_64-linux-gnu/libc.so.6+0x2a1c9) (BuildId: 274eec488d230825a136fa9c4d85370fed7a0a5e)\n    #25 0x7fdd5705a28a in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2a28a) (BuildId: 274eec488d230825a136fa9c4d85370fed7a0a5e)\n    #26 0x562d36bb2104 in _start (/tmp/py-pr-126033/build/python+0x1a2104) (BuildId: 487103bb159fe247df84ec54b81411d2745f6b17)\n\n0x513000094560 is located 32 bytes inside of 368-byte region [0x513000094540,0x5130000946b0)\nfreed by thread T0 here:\n    #0 0x562d36c4ccba in free (/tmp/py-pr-126033/build/python+0x23ccba) (BuildId: 487103bb159fe247df84ec54b81411d2745f6b17)\n    #1 0x562d36f80198 in _PyMem_RawFree /tmp/py-pr-126033/build/Objects/obmalloc.c:91:5\n    #2 0x562d36f83697 in PyObject_Free /tmp/py-pr-126033/build/Objects/obmalloc.c:1423:5\n    #3 0x562d3733aa0b in PyObject_GC_Del /tmp/py-pr-126033/build/Python/gc.c:2368:5\n    #4 0x7fdd5457ed9f in element_dealloc /tmp/py-pr-126033/build/./Modules/_elementtree.c:701:5\n    #5 0x562d36fc812b in subtype_dealloc /tmp/py-pr-126033/build/Objects/typeobject.c:2649:5\n    #6 0x562d36f5eba2 in _Py_Dealloc /tmp/py-pr-126033/build/Objects/object.c:3021:5\n    #7 0x7fdd545892b6 in Py_DECREF /tmp/py-pr-126033/build/./Include/refcount.h:433:9\n    #8 0x7fdd545892b6 in _elementtree_Element_remove_impl /tmp/py-pr-126033/build/./Modules/_elementtree.c:1684:5\n    #9 0x7fdd54584c8f in _elementtree_Element_remove /tmp/py-pr-126033/build/./Modules/clinic/_elementtree.c.h:826:20\n    #10 0x5"}