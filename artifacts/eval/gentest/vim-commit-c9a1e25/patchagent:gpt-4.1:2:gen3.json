{"patch": "--- a/src/register.c\n+++ b/src/register.c\n@@ -1267,12 +1267,21 @@\n \t\t    int tmp;\n \n \t\t    charwise_block_prep(oap->start, oap->end, &bd, lnum, oap->inclusive);\n \n-\t\t    // make sure bd.textlen is not longer than the text\n-\t\t    tmp = (int)STRLEN(bd.textstart);\n-\t\t    if (tmp < bd.textlen)\n-\t\t\tbd.textlen = tmp;\n+            // Ensure bd.textstart does not go out of the line and bd.textlen does not overflow buffer\n+            {\n+                char_u *linep = ml_get(lnum);\n+                colnr_T linelen = ml_get_len(lnum);\n+                colnr_T tcol = bd.textcol;\n+                if (tcol >= linelen) {\n+                    bd.textlen = 0;\n+                    bd.textstart = linep + linelen; // point to terminating NUL\n+                } else if ((long)(bd.textlen) > (long)(linelen - tcol)) {\n+                    bd.textlen = linelen - tcol;\n+                }\n+                /* else: bd.textstart and bd.textlen untouched */\n+            }\n \n \t\t    if (yank_copy_line(&bd, y_idx, FALSE) == FAIL)\n \t\t\tgoto fail;\n \t\t    break;\n--- a/src/misc1.c\n+++ b/src/misc1.c\n@@ -543,12 +543,15 @@\n gchar_pos(pos_T *pos)\n {\n     char_u\t*ptr;\n \n     // When searching columns is sometimes put at the end of a line.\n     if (pos->col == MAXCOL)\n \treturn NUL;\n-    ptr = ml_get_pos(pos);\n-    if (has_mbyte)\n-\treturn (*mb_ptr2char)(ptr);\n-    return (int)*ptr;\n+    colnr_T len = ml_get_len(pos->lnum);\n+    if (pos->col >= len)\n+        return NUL;\n+    ptr = ml_get_pos(pos);\n+    if (has_mbyte)\n+        return (*mb_ptr2char)(ptr);\n+    return (int)*ptr;\n }\n", "result": true}