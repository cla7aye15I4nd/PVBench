{"patch": "diff --git a/src/ex_docmd.c b/src/ex_docmd.c\nindex 26acc07e0..61afa8672 100644\n--- a/src/ex_docmd.c\n+++ b/src/ex_docmd.c\n@@ -3435,17 +3435,28 @@ append_command(char_u *cmd)\n \n     STRCAT(IObuff, \": \");\n     d = IObuff + STRLEN(IObuff);\n-    while (*s != NUL && d - IObuff < IOSIZE - 7)\n+    while (*s != NUL && d - IObuff < IOSIZE - 1)\n     {\n \tif (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n \t{\n+\t    // Need 4 bytes for \"<a0>\" plus 1 for NUL terminator\n+\t    if (d - IObuff >= IOSIZE - 5)\n+\t\tbreak;\n \t    s += enc_utf8 ? 2 : 1;\n \t    STRCPY(d, \"<a0>\");\n \t    d += 4;\n \t}\n \telse\n+\t{\n+\t    // Need up to 6 bytes for multi-byte char plus 1 for NUL terminator\n+\t    if (d - IObuff >= IOSIZE - 7)\n+\t\tbreak;\n \t    MB_COPY_CHAR(s, d);\n+\t}\n     }\n+    // Ensure we always null-terminate within bounds\n+    if (d - IObuff >= IOSIZE)\n+\td = IObuff + IOSIZE - 1;\n     *d = NUL;\n }\n \n", "result": true}