{"patch": "diff --git a/src/ex_docmd.c b/src/ex_docmd.c\nindex 26acc07e0..683a6a050 100644\n--- a/src/ex_docmd.c\n+++ b/src/ex_docmd.c\n@@ -3435,7 +3435,7 @@ append_command(char_u *cmd)\n \n     STRCAT(IObuff, \": \");\n     d = IObuff + STRLEN(IObuff);\n-    while (*s != NUL && d - IObuff < IOSIZE - 7)\n+    while (*s != NUL && d - IObuff < IOSIZE - 1)\n     {\n \tif (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n \t{\n@@ -3446,6 +3446,9 @@ append_command(char_u *cmd)\n \telse\n \t    MB_COPY_CHAR(s, d);\n     }\n+    // Ensure we don't write past the buffer\n+    if (d - IObuff >= IOSIZE)\n+\td = IObuff + IOSIZE - 1;\n     *d = NUL;\n }\n \n", "result": true}