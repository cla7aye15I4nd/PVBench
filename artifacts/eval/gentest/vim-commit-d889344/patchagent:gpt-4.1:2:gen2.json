{"patch": "diff --git a/src/ex_docmd.c b/src/ex_docmd.c\nindex 26acc07e0..813773f83 100644\n--- a/src/ex_docmd.c\n+++ b/src/ex_docmd.c\n@@ -3439,12 +3439,21 @@ append_command(char_u *cmd)\n     {\n \tif (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n \t{\n+\t    int space_left = (int)(IOSIZE - 1 - (d - IObuff));\n+\t    if (space_left < 4)\n+\t\tbreak;\n \t    s += enc_utf8 ? 2 : 1;\n \t    STRCPY(d, \"<a0>\");\n \t    d += 4;\n \t}\n \telse\n+\t{\n+\t    int char_len = has_mbyte ? (*mb_ptr2len)(s) : 1;\n+\t    int space_left = (int)(IOSIZE - 1 - (d - IObuff));\n+\t    if (char_len > space_left)\n+\t\tbreak;\n \t    MB_COPY_CHAR(s, d);\n+\t}\n     }\n     *d = NUL;\n }\n", "result": true}