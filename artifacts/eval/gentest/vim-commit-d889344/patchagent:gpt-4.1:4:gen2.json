{"patch": "diff --git a/src/ex_docmd.c b/src/ex_docmd.c\nindex 26acc07e0..e6d508b69 100644\n--- a/src/ex_docmd.c\n+++ b/src/ex_docmd.c\n@@ -3437,14 +3437,26 @@ append_command(char_u *cmd)\n     d = IObuff + STRLEN(IObuff);\n     while (*s != NUL && d - IObuff < IOSIZE - 7)\n     {\n-\tif (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n-\t{\n-\t    s += enc_utf8 ? 2 : 1;\n-\t    STRCPY(d, \"<a0>\");\n-\t    d += 4;\n-\t}\n-\telse\n-\t    MB_COPY_CHAR(s, d);\n+        if (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n+        {\n+            // Need 4 bytes for \"<a0>\" and 1 for NUL\n+            if (d - IObuff + 4 < IOSIZE) {\n+                s += enc_utf8 ? 2 : 1;\n+                STRCPY(d, \"<a0>\");\n+                d += 4;\n+            } else {\n+                break;\n+            }\n+        }\n+        else {\n+            int l = has_mbyte ? (*mb_ptr2len)(s) : 1;\n+            // Need l bytes for the char and 1 for NUL\n+            if (d - IObuff + l < IOSIZE) {\n+                MB_COPY_CHAR(s, d);\n+            } else {\n+                break;\n+            }\n+        }\n     }\n     *d = NUL;\n }\n", "result": true}