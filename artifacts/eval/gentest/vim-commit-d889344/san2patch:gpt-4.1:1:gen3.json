{"patch": "diff --git a/src/ex_docmd.c b/src/ex_docmd.c\nindex 26acc07e0..319e6dddb 100644\n--- a/src/ex_docmd.c\n+++ b/src/ex_docmd.c\n@@ -3435,20 +3435,31 @@ append_command(char_u *cmd)\n \n     STRCAT(IObuff, \": \");\n     d = IObuff + STRLEN(IObuff);\n-    while (*s != NUL && d - IObuff < IOSIZE - 7)\n+    size_t max = IOSIZE - 1;\n+    while (*s != NUL && (size_t)(d - IObuff) < max - 6)\n     {\n \tif (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n \t{\n+\t    if ((size_t)(d - IObuff) + 4 >= max)\n+\t\tbreak;\n \t    s += enc_utf8 ? 2 : 1;\n \t    STRCPY(d, \"<a0>\");\n \t    d += 4;\n \t}\n-\telse\n+\telse {\n+\t    char_u *d_start = d;\n \t    MB_COPY_CHAR(s, d);\n+\t    if ((size_t)(d - IObuff) > max)\n+\t    {\n+\t\td = d_start;\n+\t\tbreak;\n+\t    }\n+\t}\n     }\n     *d = NUL;\n }\n \n+\n #if defined(FEAT_EVAL) || defined(PROTO)\n /*\n  * If \"start\" points \"&opt\", \"&l:opt\", \"&g:opt\" or \"$ENV\" return a pointer to\n", "result": true}