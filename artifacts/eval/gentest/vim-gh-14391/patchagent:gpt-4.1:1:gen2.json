{"patch": "diff --git a/src/change.c b/src/change.c\nindex daf4faed5..71ad2979d 100644\n--- a/src/change.c\n+++ b/src/change.c\n@@ -1118,19 +1118,29 @@ ins_char_bytes(char_u *buf, int charlen)\n \t}\n     }\n \n-    newp = alloc(linelen + newlen - oldlen);\n+    size_t alloc_len = linelen + newlen - oldlen;\n+    size_t needed = col + newlen + 1; // +1 for NUL terminator\n+    if (alloc_len < needed)\n+        alloc_len = needed;\n+    newp = alloc(alloc_len);\n     if (newp == NULL)\n-\treturn;\n+        return;\n+    // Always NUL-terminate the new line\n+    newp[alloc_len - 1] = NUL;\n \n     // Copy bytes before the cursor.\n-    if (col > 0)\n-\tmch_memmove(newp, oldp, (size_t)col);\n+    if (col > 0 && linelen > 1)\n+    {\n+        size_t safe_col = (size_t)col < (size_t)(linelen - 1) ? (size_t)col : (size_t)(linelen - 1);\n+        if (safe_col > 0)\n+            mch_memmove(newp, oldp, safe_col);\n+    }\n \n     // Copy bytes after the changed character(s).\n     p = newp + col;\n-    if (linelen > col + oldlen)\n-\tmch_memmove(p + newlen, oldp + col + oldlen,\n-\t\t\t\t\t    (size_t)(linelen - col - oldlen));\n+    size_t after_bytes = linelen > col + oldlen ? (linelen - col - oldlen) : 0;\n+    if (after_bytes > 0 && (col + newlen + after_bytes <= alloc_len))\n+        mch_memmove(p + newlen, oldp + col + oldlen, after_bytes);\n \n     // Insert or overwrite the new character.\n     mch_memmove(p, buf, charlen);\n", "result": true}