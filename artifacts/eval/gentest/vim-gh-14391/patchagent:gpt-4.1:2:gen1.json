{"patch": "diff --git a/src/change.c b/src/change.c\nindex daf4faed5..26a3d1b65 100644\n--- a/src/change.c\n+++ b/src/change.c\n@@ -1118,27 +1118,42 @@ ins_char_bytes(char_u *buf, int charlen)\n \t}\n     }\n \n-    newp = alloc(linelen + newlen - oldlen);\n+    int old_line_len = linelen - 1; // exclude NUL\n+    int needed_len = col > old_line_len ? col : old_line_len;\n+    needed_len += newlen;\n+    needed_len += 1; // for NUL\n+    newp = alloc(needed_len);\n     if (newp == NULL)\n-\treturn;\n-\n-    // Copy bytes before the cursor.\n-    if (col > 0)\n-\tmch_memmove(newp, oldp, (size_t)col);\n-\n-    // Copy bytes after the changed character(s).\n-    p = newp + col;\n-    if (linelen > col + oldlen)\n-\tmch_memmove(p + newlen, oldp + col + oldlen,\n-\t\t\t\t\t    (size_t)(linelen - col - oldlen));\n+        return;\n+\n+    // Copy bytes before the cursor, up to the original line length.\n+    size_t copy_len = (size_t)col;\n+    if (copy_len > (size_t)old_line_len)\n+        copy_len = (size_t)old_line_len;\n+    if (copy_len > 0)\n+        mch_memmove(newp, oldp, copy_len);\n+\n+    // If col > old_line_len, fill the gap with spaces.\n+    if ((int)copy_len < col) {\n+        memset(newp + copy_len, ' ', (size_t)(col - copy_len));\n+    }\n \n     // Insert or overwrite the new character.\n+    p = newp + col;\n     mch_memmove(p, buf, charlen);\n     i = charlen;\n \n-    // Fill with spaces when necessary.\n-    while (i < newlen)\n-\tp[i++] = ' ';\n+    // Fill with spaces when necessary, but do not write past allocation.\n+    while (i < newlen && (col + i) < (needed_len - 1))\n+        p[i++] = ' ';\n+\n+    // Copy bytes after the changed character(s), if any remain in the original line.\n+    if (old_line_len > col + oldlen - 1)\n+        mch_memmove(p + newlen, oldp + col + oldlen,\n+                    (size_t)(old_line_len - col - oldlen + 1));\n+\n+    // Always NUL-terminate.\n+    newp[needed_len - 1] = NUL;\n \n     // Replace the line in the buffer.\n     ml_replace(lnum, newp, FALSE);\n", "result": true}