{"patch": "diff --git a/src/change.c b/src/change.c\nindex daf4faed5..7dcd06780 100644\n--- a/src/change.c\n+++ b/src/change.c\n@@ -1118,19 +1118,33 @@ ins_char_bytes(char_u *buf, int charlen)\n \t}\n     }\n \n-    newp = alloc(linelen + newlen - oldlen);\n+    // Calculate the new line length: max(col, linelen - 1) + newlen - oldlen + 1 (for NUL)\n+    int old_line_len = linelen - 1; // exclude NUL\n+    int before_len = (col > old_line_len) ? col : old_line_len;\n+    int after_len = (old_line_len > col + oldlen) ? (old_line_len - (col + oldlen)) : 0;\n+    int new_line_len = col + newlen + after_len + 1;\n+    newp = alloc(new_line_len);\n     if (newp == NULL)\n \treturn;\n \n     // Copy bytes before the cursor.\n-    if (col > 0)\n-\tmch_memmove(newp, oldp, (size_t)col);\n+    if (col > 0) {\n+        int copylen = (col > old_line_len) ? old_line_len : col;\n+        if (copylen > 0)\n+            mch_memmove(newp, oldp, (size_t)copylen);\n+        // If cursor is past end of line, fill gap with spaces\n+        for (int j = copylen; j < col; ++j)\n+            newp[j] = ' ';\n+    }\n \n     // Copy bytes after the changed character(s).\n     p = newp + col;\n-    if (linelen > col + oldlen)\n-\tmch_memmove(p + newlen, oldp + col + oldlen,\n-\t\t\t\t\t    (size_t)(linelen - col - oldlen));\n+    int after_start = col + oldlen;\n+    int afterlen = (old_line_len > after_start) ? (old_line_len - after_start) : 0;\n+    if (afterlen > 0)\n+        mch_memmove(p + newlen, oldp + after_start, (size_t)afterlen);\n+    // NUL terminate\n+    newp[new_line_len - 1] = NUL;\n \n     // Insert or overwrite the new character.\n     mch_memmove(p, buf, charlen);\n", "result": true}