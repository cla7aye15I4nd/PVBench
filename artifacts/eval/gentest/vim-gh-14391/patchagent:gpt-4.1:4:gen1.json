{"patch": "diff --git a/src/change.c b/src/change.c\nindex daf4faed5..79e347705 100644\n--- a/src/change.c\n+++ b/src/change.c\n@@ -1118,13 +1118,40 @@ ins_char_bytes(char_u *buf, int charlen)\n \t}\n     }\n \n-    newp = alloc(linelen + newlen - oldlen);\n+\n+    int alloclen = linelen;\n+    if (col > linelen)\n+        alloclen = col;\n+    alloclen += newlen - oldlen;\n+    newp = alloc(alloclen + 1); // +1 for the NUL terminator\n     if (newp == NULL)\n-\treturn;\n+        return;\n+\n+    // Copy or fill spaces before the cursor.\n+    if (col > 0) {\n+        int ncopy = (linelen > col) ? col : linelen;\n+        if (ncopy > 0)\n+            mch_memmove(newp, oldp, (size_t)ncopy);\n+        if (col > linelen)\n+            memset(newp + linelen, ' ', (size_t)(col - linelen));\n+    }\n \n-    // Copy bytes before the cursor.\n-    if (col > 0)\n-\tmch_memmove(newp, oldp, (size_t)col);\n+    // Insert or overwrite the new character.\n+    p = newp + col;\n+    mch_memmove(p, buf, charlen);\n+    i = charlen;\n+\n+    // Fill with spaces when necessary.\n+    while (i < newlen)\n+        p[i++] = ' ';\n+\n+    // Copy bytes after the changed character(s).\n+    if (linelen > col + oldlen)\n+        mch_memmove(p + newlen, oldp + col + oldlen,\n+                        (size_t)(linelen - col - oldlen));\n+\n+    // Always NUL-terminate the newly created line buffer.\n+    newp[alloclen] = 0;\n \n     // Copy bytes after the changed character(s).\n     p = newp + col;\n", "result": true}