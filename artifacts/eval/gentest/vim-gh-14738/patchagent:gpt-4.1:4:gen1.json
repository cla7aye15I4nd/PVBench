{"patch": "diff --git a/src/xxd/xxd.c b/src/xxd/xxd.c\nindex cf8b4ea6a..b0ec85804 100644\n--- a/src/xxd/xxd.c\n+++ b/src/xxd/xxd.c\n@@ -672,6 +672,26 @@ main(int argc, char *argv[])\n   unsigned long displayoff = 0;\n   static char l[LLEN+1];  /* static because it may be too big for stack */\n   char *pp;\n+#define L_SAFE_WRITE(expr, needed) \\\n+  do { \\\n+    if ((c) + (needed) < (int)sizeof(l)) { expr; } \\\n+    else { l[sizeof(l)-1] = '\\0'; goto finish_line; } \\\n+  } while (0)\n+\n+#undef COLOR_PROLOGUE\n+#define COLOR_PROLOGUE \\\n+  L_SAFE_WRITE(l[c++] = '\\033', 5); \\\n+  L_SAFE_WRITE(l[c++] = '[', 4); \\\n+  L_SAFE_WRITE(l[c++] = '1', 3); \\\n+  L_SAFE_WRITE(l[c++] = ';', 2); \\\n+  L_SAFE_WRITE(l[c++] = '3', 1);\n+\n+#undef COLOR_EPILOGUE\n+#define COLOR_EPILOGUE \\\n+  L_SAFE_WRITE(l[c++] = '\\033', 4); \\\n+  L_SAFE_WRITE(l[c++] = '[', 3); \\\n+  L_SAFE_WRITE(l[c++] = '0', 2); \\\n+  L_SAFE_WRITE(l[c++] = 'm', 1);\n   char *varname = NULL;\n   int addrlen = 9;\n   int color = 0;\n@@ -1101,22 +1121,28 @@ main(int argc, char *argv[])\n           COLOR_PROLOGUE\n           begin_coloring_char(l,&c,e,ebcdic);\n #if defined(__MVS__) && __CHARSET_LIB == 0\n-          if (e >= 64)\n-            l[c++] = e;\n-          else\n-            l[c++] = '.';\n+          if ((c + 1) < (int)sizeof(l)) {\n+            if (e >= 64)\n+              l[c++] = e;\n+            else\n+              l[c++] = '.';\n+          } else { l[sizeof(l)-1] = '\\0'; goto finish_line; }\n #else\n           if (ebcdic)\n             e = (e < 64) ? '.' : etoa64[e-64];\n-          l[c++] = (e > 31 && e < 127) ? e : '.';\n+          if ((c + 1) < (int)sizeof(l))\n+            l[c++] = (e > 31 && e < 127) ? e : '.';\n+          else { l[sizeof(l)-1] = '\\0'; goto finish_line; }\n #endif\n           COLOR_EPILOGUE\n           n++;\n           if (++p == cols)\n             {\n-              l[c++] = '\\n';\n-              l[c++] = '\\0';\n-              xxdline(fpo, l, autoskip ? nonzero : 1);\n+              if ((c + 2) < (int)sizeof(l)) {\n+                l[c++] = '\\n';\n+                l[c++] = '\\0';\n+                xxdline(fpo, l, autoskip ? nonzero : 1);\n+              } else { l[sizeof(l)-1] = '\\0'; goto finish_line; }\n               nonzero = 0;\n               p = 0;\n             }\n@@ -1143,6 +1169,8 @@ main(int argc, char *argv[])\n               nonzero = 0;\n               p = 0;\n             }\n+finish_line:\n+\n         }\n     }\n   if (p)\n", "result": true}