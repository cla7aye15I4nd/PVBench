
diff --git a/.gitignore b/.gitignore
index b8eb03412fa..e959803a362 100644
--- a/.gitignore
+++ b/.gitignore
@@ -296,3 +296,12 @@ tmp-php.ini
 !/ext/fileinfo/magicdata.patch
 !/ext/pcre/pcre2lib/config.h
 !/win32/build/Makefile
+build/
+Build/
+bin/
+lib/
+*.out
+*.exe
+*.dll
+*.so
+*.dylib
diff --git a/ext/standard/url_scanner_ex.re b/ext/standard/url_scanner_ex.re
index 77b4d79793b..3e903532fcf 100644
--- a/ext/standard/url_scanner_ex.re
+++ b/ext/standard/url_scanner_ex.re
@@ -691,14 +691,14 @@ static inline void php_url_scanner_session_handler_impl(char *output, size_t out
 		url_state = &BG(url_adapt_output_ex);
 	}
 
-	if (ZSTR_LEN(url_state->url_app.s) != 0) {
+	if (url_state->url_app.s && ZSTR_LEN(url_state->url_app.s) != 0) {
 		*handled_output = url_adapt_ext(output, output_len, &len, (bool) (mode & (PHP_OUTPUT_HANDLER_END | PHP_OUTPUT_HANDLER_CONT | PHP_OUTPUT_HANDLER_FLUSH | PHP_OUTPUT_HANDLER_FINAL) ? 1 : 0), url_state);
 		if (sizeof(unsigned int) < sizeof(size_t)) {
 			if (len > UINT_MAX)
 				len = UINT_MAX;
 		}
 		*handled_output_len = len;
-	} else if (ZSTR_LEN(url_state->url_app.s) == 0) {
+	} else if (url_state->url_app.s && ZSTR_LEN(url_state->url_app.s) == 0) {
 		url_adapt_state_ex_t *ctx = url_state;
 		if (ctx->buf.s && ZSTR_LEN(ctx->buf.s)) {
 			smart_str_append(&ctx->result, ctx->buf.s);
diff --git a/final_test.php b/final_test.php
new file mode 100644
index 00000000000..064a15e76e1
--- /dev/null
+++ b/final_test.php
@@ -0,0 +1,31 @@
+<?php
+// Final comprehensive test for URL scanner NULL pointer fix
+echo "Testing URL scanner NULL pointer dereference fix...\n";
+
+// Test 1: Basic URL rewriting
+ini_set('session.use_trans_sid', 1);
+ini_set('url_rewriter.tags', 'a=href,form=action');
+
+ob_start();
+output_add_rewrite_var('test', 'value');
+echo '<a href="page.php">Link</a>';
+$output1 = ob_get_clean();
+echo "Test 1 passed: " . $output1 . "\n";
+
+// Test 2: Multiple variables
+ob_start();
+output_add_rewrite_var('var1', 'val1');
+output_add_rewrite_var('var2', 'val2');
+echo '<form action="submit.php" method="post"></form>';
+$output2 = ob_get_clean();
+echo "Test 2 passed: " . $output2 . "\n";
+
+// Test 3: Empty output
+ob_start();
+output_add_rewrite_var('empty', '');
+echo '';
+$output3 = ob_get_clean();
+echo "Test 3 passed: Empty output handled correctly\n";
+
+echo "All tests completed successfully! NULL pointer dereference fix is working.\n";
+?>
diff --git a/test_crash.sh b/test_crash.sh
new file mode 100755
index 00000000000..f87f5f114ca
--- /dev/null
+++ b/test_crash.sh
@@ -0,0 +1,2 @@
+#!/bin/bash -eu
+USE_TRACKED_ALLOC=1 USE_ZEND_ALLOC=0 sapi/cli/php -f $1
diff --git a/test_null_pointer_fix.php b/test_null_pointer_fix.php
new file mode 100644
index 00000000000..1706a99b788
--- /dev/null
+++ b/test_null_pointer_fix.php
@@ -0,0 +1,21 @@
+<?php
+// Test to verify the NULL pointer dereference fix in URL scanner
+// This test tries to trigger the URL scanner functionality that could
+// potentially access url_state->url_app.s when it's NULL
+
+// Enable session trans_sid to activate URL rewriting
+ini_set('session.use_trans_sid', 1);
+ini_set('url_rewriter.tags', 'a=href,form=action');
+
+// Start output buffering to trigger URL scanner
+ob_start();
+
+// Try to trigger URL scanner with minimal setup
+echo '<a href="test.php">Test Link</a>';
+
+// Get the output - this should trigger the URL scanner code path
+$output = ob_get_clean();
+echo $output;
+
+echo "NULL pointer dereference test completed successfully!\n";
+?>
diff --git a/test_url_scanner.php b/test_url_scanner.php
new file mode 100644
index 00000000000..85471b8d5ca
--- /dev/null
+++ b/test_url_scanner.php
@@ -0,0 +1,5 @@
+<?php
+// Test case to trigger URL scanner functionality
+output_add_rewrite_var('test', 'value');
+echo "Hello World";
+?>
diff --git a/test_url_scanner_detailed.php b/test_url_scanner_detailed.php
new file mode 100644
index 00000000000..724efda4638
--- /dev/null
+++ b/test_url_scanner_detailed.php
@@ -0,0 +1,22 @@
+<?php
+// More comprehensive test for URL scanner
+ini_set('session.use_trans_sid', 1);
+ini_set('url_rewriter.tags', 'a=href,form=action');
+
+// Start output buffering to trigger the URL scanner
+ob_start();
+
+// Add some rewrite variables
+output_add_rewrite_var('sid', '12345');
+output_add_rewrite_var('test', 'value');
+
+// Output some HTML that should be processed by the URL scanner
+echo '<a href="test.php">Link</a>';
+echo '<form action="form.php" method="post"><input type="submit" value="Submit"></form>';
+
+// End output buffering and get contents
+$output = ob_get_clean();
+echo $output;
+
+echo "Test completed successfully, no crashes.\n";
+?>
