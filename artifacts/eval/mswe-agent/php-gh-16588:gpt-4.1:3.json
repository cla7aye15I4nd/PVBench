[{"patch": "diff --git a/.gitignore b/.gitignore\nindex b8eb03412fa..e959803a362 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -296,3 +296,12 @@ tmp-php.ini\n !/ext/fileinfo/magicdata.patch\n !/ext/pcre/pcre2lib/config.h\n !/win32/build/Makefile\n+build/\n+Build/\n+bin/\n+lib/\n+*.out\n+*.exe\n+*.dll\n+*.so\n+*.dylib\ndiff --git a/ext/spl/spl_observer.c b/ext/spl/spl_observer.c\nindex cc2956ccc27..970a06ddfe5 100644\n--- a/ext/spl/spl_observer.c\n+++ b/ext/spl/spl_observer.c\n@@ -789,21 +789,47 @@ PHP_METHOD(SplObjectStorage, serialize)\n \n \tzend_hash_internal_pointer_reset_ex(&intern->storage, &pos);\n \n+\t/* Make a shallow copy of all storage elements to protect against modification during serialization */\n+\tuint32_t num_elements = zend_hash_num_elements(&intern->storage);\n+\tspl_SplObjectStorageElement **elements = emalloc(num_elements * sizeof(spl_SplObjectStorageElement *));\n+\tuint32_t i = 0;\n+\tzend_hash_internal_pointer_reset_ex(&intern->storage, &pos);\n \twhile (zend_hash_has_more_elements_ex(&intern->storage, &pos) == SUCCESS) {\n-\t\tzval obj;\n-\t\tif ((element = zend_hash_get_current_data_ptr_ex(&intern->storage, &pos)) == NULL) {\n-\t\t\tsmart_str_free(&buf);\n-\t\t\tPHP_VAR_SERIALIZE_DESTROY(var_hash);\n-\t\t\tRETURN_NULL();\n+\t\telement = zend_hash_get_current_data_ptr_ex(&intern->storage, &pos);\n+\t\tif (element) {\n+\t\t\telements[i++] = element;\n \t\t}\n-\t\tZVAL_OBJ(&obj, element->obj);\n-\t\tphp_var_serialize(&buf, &obj, &var_hash);\n+\t\tzend_hash_move_forward_ex(&intern->storage, &pos);\n+\t}\n+\n+\t/* First pass: Make a deep copy of all objects and inf zvals */\n+\ttypedef struct {\n+\t\tzval obj;\n+\t\tzval inf;\n+\t} storage_copy_t;\n+\tstorage_copy_t *storage_copy = emalloc(num_elements * sizeof(storage_copy_t));\n+\tfor (i = 0; i < num_elements; i++) {\n+\t\tZVAL_OBJ(&storage_copy[i].obj, elements[i]->obj);\n+\t\tZ_ADDREF(storage_copy[i].obj);\n+\t\tZVAL_COPY(&storage_copy[i].inf, &elements[i]->inf);\n+\t}\n+\n+\t/* Second pass: Serialize */\n+\tfor (i = 0; i < num_elements; i++) {\n+\t\tphp_var_serialize(&buf, &storage_copy[i].obj, &var_hash);\n \t\tsmart_str_appendc(&buf, ',');\n-\t\tphp_var_serialize(&buf, &element->inf, &var_hash);\n+\t\tphp_var_serialize(&buf, &storage_copy[i].inf, &var_hash);\n \t\tsmart_str_appendc(&buf, ';');\n-\t\tzend_hash_move_forward_ex(&intern->storage, &pos);\n \t}\n \n+\t/* Third pass: Delref all object and inf zvals */\n+\tfor (i = 0; i < num_elements; i++) {\n+\t\tzval_ptr_dtor(&storage_copy[i].obj);\n+\t\tzval_ptr_dtor(&storage_copy[i].inf);\n+\t}\n+\tefree(storage_copy);\n+\n+\tefree(elements);\n \t/* members */\n \tsmart_str_appendl(&buf, \"m:\", 2);\n \n"}]