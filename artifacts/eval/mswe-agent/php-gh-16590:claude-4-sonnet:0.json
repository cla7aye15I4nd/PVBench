[{"patch": "diff --git a/.gitignore b/.gitignore\nindex d54334f599a..3a5943bfb9b 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -297,3 +297,12 @@ tmp-php.ini\n !/ext/dom/lexbor/patches/*.patch\n !/ext/pcre/pcre2lib/config.h\n !/win32/build/Makefile\n+build/\n+Build/\n+bin/\n+lib/\n+*.out\n+*.exe\n+*.dll\n+*.so\n+*.dylib\ndiff --git a/ext/session/php_session.h b/ext/session/php_session.h\nindex 65bf7de2044..8cc13f5e7e4 100644\n--- a/ext/session/php_session.h\n+++ b/ext/session/php_session.h\n@@ -293,16 +293,29 @@ PHPAPI zend_result php_session_reset_id(void);\n \n #define PS_ENCODE_LOOP(code) do {\t\t\t\t\t\t\t\t\t\\\n \tHashTable *_ht = Z_ARRVAL_P(Z_REFVAL(PS(http_session_vars)));\t\\\n+\tzend_string **keys;\t\t\t\t\t\t\t\t\t\t\t\t\\\n+\tuint32_t key_count = 0;\t\t\t\t\t\t\t\t\t\t\t\\\n+\tuint32_t i;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\\\n+\t/* First pass: collect all keys */\t\t\t\t\t\t\t\t\\\n+\tkeys = emalloc(zend_hash_num_elements(_ht) * sizeof(zend_string*)); \\\n \tZEND_HASH_FOREACH_KEY(_ht, num_key, key) {\t\t\t\t\t\t\\\n \t\tif (key == NULL) {\t\t\t\t\t\t\t\t\t\t\t\\\n \t\t\tphp_error_docref(NULL, E_WARNING,\t\t\t\t\t\t\\\n \t\t\t\t\t\"Skipping numeric key \" ZEND_LONG_FMT, num_key);\\\n \t\t\tcontinue;\t\t\t\t\t\t\t\t\t\t\t\t\\\n \t\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\\\n+\t\tkeys[key_count] = zend_string_copy(key);\t\t\t\t\t\\\n+\t\tkey_count++;\t\t\t\t\t\t\t\t\t\t\t\t\\\n+\t} ZEND_HASH_FOREACH_END();\t\t\t\t\t\t\t\t\t\t\\\n+\t/* Second pass: process each key */\t\t\t\t\t\t\t\t\\\n+\tfor (i = 0; i < key_count; i++) {\t\t\t\t\t\t\t\t\\\n+\t\tkey = keys[i];\t\t\t\t\t\t\t\t\t\t\t\t\\\n \t\tif ((struc = php_get_session_var(key))) {\t\t\t\t\t\\\n \t\t\tcode;\t\t \t\t\t\t\t\t\t\t\t\t\t\\\n \t\t} \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\\\n-\t} ZEND_HASH_FOREACH_END();\t\t\t\t\t\t\t\t\t\t\\\n+\t\tzend_string_release(key);\t\t\t\t\t\t\t\t\t\\\n+\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\\\n+\tefree(keys);\t\t\t\t\t\t\t\t\t\t\t\t\t\\\n } while(0)\n \n PHPAPI ZEND_EXTERN_MODULE_GLOBALS(ps)\n"}]