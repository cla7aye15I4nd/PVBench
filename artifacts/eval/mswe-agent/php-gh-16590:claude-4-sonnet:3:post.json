{"patch": "diff --git a/.gitignore b/.gitignore\nindex d54334f599a..3a5943bfb9b 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -297,3 +297,12 @@ tmp-php.ini\n !/ext/dom/lexbor/patches/*.patch\n !/ext/pcre/pcre2lib/config.h\n !/win32/build/Makefile\n+build/\n+Build/\n+bin/\n+lib/\n+*.out\n+*.exe\n+*.dll\n+*.so\n+*.dylib\ndiff --git a/ext/session/session.c b/ext/session/session.c\nindex b23f1fce358..3ce17b0b22e 100644\n--- a/ext/session/session.c\n+++ b/ext/session/session.c\n@@ -1056,20 +1056,58 @@ PS_SERIALIZER_ENCODE_FUNC(php) /* {{{ */\n {\n \tsmart_str buf = {0};\n \tphp_serialize_data_t var_hash;\n-\tPS_ENCODE_VARS;\n+\tHashTable *ht;\n+\tzend_string *key;\n+\tzend_ulong num_key;\n+\tzval *struc;\n+\tzend_string **keys = NULL;\n+\tuint32_t key_count = 0;\n+\tuint32_t i;\n \n \tPHP_VAR_SERIALIZE_INIT(var_hash);\n \n-\tPS_ENCODE_LOOP(\n-\t\tsmart_str_appendl(&buf, ZSTR_VAL(key), ZSTR_LEN(key));\n-\t\tif (memchr(ZSTR_VAL(key), PS_DELIMITER, ZSTR_LEN(key))) {\n-\t\t\tPHP_VAR_SERIALIZE_DESTROY(var_hash);\n-\t\t\tsmart_str_free(&buf);\n-\t\t\treturn NULL;\n-\t\t}\n-\t\tsmart_str_appendc(&buf, PS_DELIMITER);\n-\t\tphp_var_serialize(&buf, struc, &var_hash);\n-\t);\n+\t/* First, collect all keys to avoid iterator invalidation during serialization */\n+\tht = Z_ARRVAL_P(Z_REFVAL(PS(http_session_vars)));\n+\tkey_count = zend_hash_num_elements(ht);\n+\t\n+\tif (key_count > 0) {\n+\t\tkeys = emalloc(key_count * sizeof(zend_string*));\n+\t\ti = 0;\n+\t\t\n+\t\tZEND_HASH_FOREACH_KEY(ht, num_key, key) {\n+\t\t\tif (key == NULL) {\n+\t\t\t\tphp_error_docref(NULL, E_WARNING,\n+\t\t\t\t\t\t\"Skipping numeric key \" ZEND_LONG_FMT, num_key);\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\t\t\tkeys[i++] = zend_string_copy(key);\n+\t\t} ZEND_HASH_FOREACH_END();\n+\t\t\n+\t\tkey_count = i; /* Update count in case we skipped numeric keys */\n+\t\t\n+\t\t/* Now serialize using the collected keys */\n+\t\tfor (i = 0; i < key_count; i++) {\n+\t\t\tkey = keys[i];\n+\t\t\tif ((struc = php_get_session_var(key))) {\n+\t\t\t\tsmart_str_appendl(&buf, ZSTR_VAL(key), ZSTR_LEN(key));\n+\t\t\t\tif (memchr(ZSTR_VAL(key), PS_DELIMITER, ZSTR_LEN(key))) {\n+\t\t\t\t\tPHP_VAR_SERIALIZE_DESTROY(var_hash);\n+\t\t\t\t\tsmart_str_free(&buf);\n+\t\t\t\t\t/* Clean up keys */\n+\t\t\t\t\tfor (uint32_t j = 0; j < key_count; j++) {\n+\t\t\t\t\t\tzend_string_release(keys[j]);\n+\t\t\t\t\t}\n+\t\t\t\t\tefree(keys);\n+\t\t\t\t\treturn NULL;\n+\t\t\t\t}\n+\t\t\t\tsmart_str_appendc(&buf, PS_DELIMITER);\n+\t\t\t\tphp_var_serialize(&buf, struc, &var_hash);\n+\t\t\t}\n+\t\t\tzend_string_release(keys[i]);\n+\t\t}\n+\t\t\n+\t\tefree(keys);\n+\t}\n \n \tsmart_str_0(&buf);\n \n", "result": true}