
diff --git a/.gitignore b/.gitignore
index d54334f599a..3a5943bfb9b 100644
--- a/.gitignore
+++ b/.gitignore
@@ -297,3 +297,12 @@ tmp-php.ini
 !/ext/dom/lexbor/patches/*.patch
 !/ext/pcre/pcre2lib/config.h
 !/win32/build/Makefile
+build/
+Build/
+bin/
+lib/
+*.out
+*.exe
+*.dll
+*.so
+*.dylib
diff --git a/ext/session/php_session.h b/ext/session/php_session.h
index 65bf7de2044..8cc13f5e7e4 100644
--- a/ext/session/php_session.h
+++ b/ext/session/php_session.h
@@ -293,16 +293,29 @@ PHPAPI zend_result php_session_reset_id(void);
 
 #define PS_ENCODE_LOOP(code) do {									\
 	HashTable *_ht = Z_ARRVAL_P(Z_REFVAL(PS(http_session_vars)));	\
+	zend_string **keys;												\
+	uint32_t key_count = 0;											\
+	uint32_t i;														\
+	/* First pass: collect all keys */								\
+	keys = emalloc(zend_hash_num_elements(_ht) * sizeof(zend_string*)); \
 	ZEND_HASH_FOREACH_KEY(_ht, num_key, key) {						\
 		if (key == NULL) {											\
 			php_error_docref(NULL, E_WARNING,						\
 					"Skipping numeric key " ZEND_LONG_FMT, num_key);\
 			continue;												\
 		}															\
+		keys[key_count] = zend_string_copy(key);					\
+		key_count++;												\
+	} ZEND_HASH_FOREACH_END();										\
+	/* Second pass: process each key */								\
+	for (i = 0; i < key_count; i++) {								\
+		key = keys[i];												\
 		if ((struc = php_get_session_var(key))) {					\
 			code;		 											\
 		} 															\
-	} ZEND_HASH_FOREACH_END();										\
+		zend_string_release(key);									\
+	}																\
+	efree(keys);													\
 } while(0)
 
 PHPAPI ZEND_EXTERN_MODULE_GLOBALS(ps)
