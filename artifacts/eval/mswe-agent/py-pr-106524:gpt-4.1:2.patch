
diff --git a/.gitignore b/.gitignore
index dddf28da016..efa3374de86 100644
--- a/.gitignore
+++ b/.gitignore
@@ -158,3 +158,9 @@ Python/frozen_modules/MANIFEST
 
 # main branch only: ABI files are not checked/maintained
 Doc/data/python*.abi
+build/
+Build/
+bin/
+lib/
+*.out
+*.obj
diff --git a/Modules/_sre/sre.c b/Modules/_sre/sre.c
index 3f11916f9e1..f00fa83fa39 100644
--- a/Modules/_sre/sre.c
+++ b/Modules/_sre/sre.c
@@ -2777,7 +2777,11 @@ template_traverse(TemplateObject *self, visitproc visit, void *arg)
 {
     Py_VISIT(Py_TYPE(self));
     Py_VISIT(self->literal);
-    for (Py_ssize_t i = 0, n = Py_SIZE(self); i < n; i++) {
+    if (!Py_IS_TYPE(self, Py_TYPE(self)) || Py_SIZE(self) < 0 || Py_SIZE(self) > 1000000) {
+        return 0;
+    }
+    Py_ssize_t n = Py_SIZE(self);
+    for (Py_ssize_t i = 0; i < n; i++) {
         Py_VISIT(self->items[i].literal);
     }
     return 0;
@@ -2786,20 +2790,28 @@ template_traverse(TemplateObject *self, visitproc visit, void *arg)
 static int
 template_clear(TemplateObject *self)
 {
-    Py_CLEAR(self->literal);
-    for (Py_ssize_t i = 0, n = Py_SIZE(self); i < n; i++) {
+    if (!Py_IS_TYPE(self, Py_TYPE(self)) || Py_SIZE(self) < 0 || Py_SIZE(self) > 1000000) {
+        return 0;
+    }
+    Py_ssize_t n = Py_SIZE(self);
+    for (Py_ssize_t i = 0; i < n; i++) {
         Py_CLEAR(self->items[i].literal);
     }
     return 0;
 }
 
 static void
+
 template_dealloc(TemplateObject *self)
 {
+    if (self == NULL) {
+        return;
+    }
     PyTypeObject *tp = Py_TYPE(self);
 
-    PyObject_GC_UnTrack(self);
-    (void)template_clear(self);
+    if (Py_IS_TYPE(self, Py_TYPE(self)) && Py_SIZE(self) >= 0 && Py_SIZE(self) < 1000000) {
+        (void)template_clear(self);
+    }
     tp->tp_free(self);
     Py_DECREF(tp);
 }
