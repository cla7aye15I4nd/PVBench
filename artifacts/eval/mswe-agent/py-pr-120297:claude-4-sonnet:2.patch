
diff --git a/.gitignore b/.gitignore
index 8872e9d5508..959a12bbd57 100644
--- a/.gitignore
+++ b/.gitignore
@@ -171,3 +171,9 @@ Python/frozen_modules/MANIFEST
 
 # main branch only: ABI files are not checked/maintained.
 Doc/data/python*.abi
+build/
+Build/
+bin/
+lib/
+*.out
+*.obj
diff --git a/Modules/_lsprof.c b/Modules/_lsprof.c
index 5cf9eba243b..9c7556f41b6 100644
--- a/Modules/_lsprof.c
+++ b/Modules/_lsprof.c
@@ -348,6 +348,10 @@ ptrace_enter_call(PyObject *self, void *key, PyObject *userObj)
     ProfilerEntry *profEntry;
     ProfilerContext *pContext;
 
+    /* Check if profiler is still enabled to avoid use-after-free */
+    if (!(pObj->flags & POF_ENABLED))
+        return;
+
     /* In the case of entering a generator expression frame via a
      * throw (gen_send_ex(.., 1)), we may already have an
      * Exception set here. We must not mess around with this
@@ -390,6 +394,10 @@ ptrace_leave_call(PyObject *self, void *key)
     ProfilerEntry *profEntry;
     ProfilerContext *pContext;
 
+    /* Check if profiler is still enabled to avoid use-after-free */
+    if (!(pObj->flags & POF_ENABLED))
+        return;
+
     pContext = pObj->currentProfilerContext;
     if (pContext == NULL)
         return;
