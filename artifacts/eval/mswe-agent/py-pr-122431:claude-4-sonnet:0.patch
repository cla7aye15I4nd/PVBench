
diff --git a/.gitignore b/.gitignore
index 8872e9d5508..959a12bbd57 100644
--- a/.gitignore
+++ b/.gitignore
@@ -171,3 +171,9 @@ Python/frozen_modules/MANIFEST
 
 # main branch only: ABI files are not checked/maintained.
 Doc/data/python*.abi
+build/
+Build/
+bin/
+lib/
+*.out
+*.obj
diff --git a/Modules/readline.c b/Modules/readline.c
index 35655c70a46..a4d7aea1518 100644
--- a/Modules/readline.c
+++ b/Modules/readline.c
@@ -362,8 +362,37 @@ readline_append_history_file_impl(PyObject *module, int nelements,
         filename_bytes = NULL;
         filename = NULL;
     }
-    errno = err = append_history(
-        nelements - libedit_append_replace_history_offset, filename);
+    /* Check for integer overflow/underflow in nelements calculation */
+    int adjusted_nelements;
+    
+    if (libedit_append_replace_history_offset > 0) {
+        /* Check for underflow: nelements - offset < INT_MIN */
+        if (nelements < INT_MIN + libedit_append_replace_history_offset) {
+            PyErr_SetString(PyExc_OverflowError, 
+                           "nelements value would cause integer underflow");
+            Py_XDECREF(filename_bytes);
+            return NULL;
+        }
+    } else if (libedit_append_replace_history_offset < 0) {
+        /* Check for overflow: nelements - offset > INT_MAX */
+        if (nelements > INT_MAX + libedit_append_replace_history_offset) {
+            PyErr_SetString(PyExc_OverflowError, 
+                           "nelements value would cause integer overflow");
+            Py_XDECREF(filename_bytes);
+            return NULL;
+        }
+    }
+    
+    adjusted_nelements = nelements - libedit_append_replace_history_offset;
+    
+    /* Check if the final value is negative, which is invalid for append_history */
+    if (adjusted_nelements < 0) {
+        PyErr_SetString(PyExc_ValueError, 
+                       "nelements must be non-negative");
+        Py_XDECREF(filename_bytes);
+        return NULL;
+    }
+    errno = err = append_history(adjusted_nelements, filename);
     if (!err && _history_length >= 0)
         history_truncate_file(filename, _history_length);
     Py_XDECREF(filename_bytes);
