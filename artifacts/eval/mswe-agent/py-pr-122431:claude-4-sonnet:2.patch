
diff --git a/.gitignore b/.gitignore
index 8872e9d5508..959a12bbd57 100644
--- a/.gitignore
+++ b/.gitignore
@@ -171,3 +171,9 @@ Python/frozen_modules/MANIFEST
 
 # main branch only: ABI files are not checked/maintained.
 Doc/data/python*.abi
+build/
+Build/
+bin/
+lib/
+*.out
+*.obj
diff --git a/Modules/readline.c b/Modules/readline.c
index 35655c70a46..dc34ada81ab 100644
--- a/Modules/readline.c
+++ b/Modules/readline.c
@@ -362,8 +362,22 @@ readline_append_history_file_impl(PyObject *module, int nelements,
         filename_bytes = NULL;
         filename = NULL;
     }
-    errno = err = append_history(
-        nelements - libedit_append_replace_history_offset, filename);
+    /* Check for integer overflow before subtraction */
+    int adjusted_nelements;
+    if (libedit_append_replace_history_offset > 0 && nelements < INT_MIN + libedit_append_replace_history_offset) {
+        /* Underflow would occur */
+        adjusted_nelements = INT_MIN;
+    } else if (libedit_append_replace_history_offset < 0 && nelements > INT_MAX + libedit_append_replace_history_offset) {
+        /* Overflow would occur */
+        adjusted_nelements = INT_MAX;
+    } else {
+        adjusted_nelements = nelements - libedit_append_replace_history_offset;
+        /* Ensure we don't pass negative values to append_history */
+        if (adjusted_nelements < 0) {
+            adjusted_nelements = 0;
+        }
+    }
+    errno = err = append_history(adjusted_nelements, filename);
     if (!err && _history_length >= 0)
         history_truncate_file(filename, _history_length);
     Py_XDECREF(filename_bytes);
