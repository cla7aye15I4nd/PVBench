
diff --git a/.gitignore b/.gitignore
index 8872e9d5508..959a12bbd57 100644
--- a/.gitignore
+++ b/.gitignore
@@ -171,3 +171,9 @@ Python/frozen_modules/MANIFEST
 
 # main branch only: ABI files are not checked/maintained.
 Doc/data/python*.abi
+build/
+Build/
+bin/
+lib/
+*.out
+*.obj
diff --git a/Modules/readline.c b/Modules/readline.c
index 35655c70a46..61983d6558c 100644
--- a/Modules/readline.c
+++ b/Modules/readline.c
@@ -362,8 +362,24 @@ readline_append_history_file_impl(PyObject *module, int nelements,
         filename_bytes = NULL;
         filename = NULL;
     }
-    errno = err = append_history(
-        nelements - libedit_append_replace_history_offset, filename);
+    /* Check for integer overflow/underflow and validate nelements */
+    int adjusted_nelements;
+    
+    /* Reject negative nelements as they don't make sense for append_history */
+    if (nelements < 0) {
+        PyErr_SetString(PyExc_ValueError, "nelements must be non-negative");
+        Py_XDECREF(filename_bytes);
+        return NULL;
+    }
+    
+    /* Check if subtraction would cause underflow */
+    if (nelements < libedit_append_replace_history_offset) {
+        adjusted_nelements = 0;  /* Clamp to 0 instead of going negative */
+    } else {
+        adjusted_nelements = nelements - libedit_append_replace_history_offset;
+    }
+    
+    errno = err = append_history(adjusted_nelements, filename);
     if (!err && _history_length >= 0)
         history_truncate_file(filename, _history_length);
     Py_XDECREF(filename_bytes);
