
diff --git a/.gitignore b/.gitignore
index 8872e9d5508..959a12bbd57 100644
--- a/.gitignore
+++ b/.gitignore
@@ -171,3 +171,9 @@ Python/frozen_modules/MANIFEST
 
 # main branch only: ABI files are not checked/maintained.
 Doc/data/python*.abi
+build/
+Build/
+bin/
+lib/
+*.out
+*.obj
diff --git a/Objects/frameobject.c b/Objects/frameobject.c
index d6b4065e130..6c94973ac41 100644
--- a/Objects/frameobject.c
+++ b/Objects/frameobject.c
@@ -51,7 +51,15 @@ framelocalsproxy_getval(_PyInterpreterFrame *frame, PyCodeObject *co, int i)
 
     return value;
 }
-
+static PyObject *framelocalsproxy_getitem(PyObject *self, PyObject *key);
+static int framelocalsproxy_setitem(PyObject *self, PyObject *key, PyObject *value);
+static PyObject *framelocalsproxy_keys(PyObject *self);
+static PyObject *framelocalsproxy_values(PyObject *self);
+static PyObject *framelocalsproxy_items(PyObject *self);
+static Py_ssize_t framelocalsproxy_length(PyObject *self);
+static int framelocalsproxy_contains(PyObject *self, PyObject *key);
+static PyObject *framelocalsproxy_iter(PyObject *self);
+static PyObject *framelocalsproxy_richcompare(PyObject *self, PyObject *other, int op);
 static int
 framelocalsproxy_getkeyindex(PyFrameObject *frame, PyObject* key, bool read)
 {
@@ -88,14 +96,6 @@ framelocalsproxy_getkeyindex(PyFrameObject *frame, PyObject* key, bool read)
             }
             found = true;
         }
-    }
-    if (found) {
-        // This is an attempt to read an unset local variable or
-        // write to a variable that is hidden from regular write operations
-        return -1;
-    }
-    // This is unlikely, but we need to make sure. This means the key
-    // is not interned.
     for (int i = 0; i < co->co_nlocalsplus; i++) {
         PyObject *name = PyTuple_GET_ITEM(co->co_localsplusnames, i);
         Py_hash_t name_hash = PyObject_Hash(name);
@@ -119,14 +119,19 @@ framelocalsproxy_getkeyindex(PyFrameObject *frame, PyObject* key, bool read)
             }
         }
     }
-
     return -1;
-}
+
+
+static PyObject *
 
 static PyObject *
 framelocalsproxy_getitem(PyObject *self, PyObject *key)
 {
     PyFrameObject* frame = ((PyFrameLocalsProxyObject*)self)->frame;
+    if (frame == NULL) {
+        PyErr_SetString(PyExc_RuntimeError, "FrameLocalsProxy object has no frame (possibly cleared by GC)");
+        return NULL;
+    }
     PyCodeObject* co = _PyFrame_GetCode(frame->f_frame);
 
     int i = framelocalsproxy_getkeyindex(frame, key, true);
@@ -156,8 +161,12 @@ framelocalsproxy_getitem(PyObject *self, PyObject *key)
 static int
 framelocalsproxy_setitem(PyObject *self, PyObject *key, PyObject *value)
 {
-    /* Merge locals into fast locals */
     PyFrameObject *frame = ((PyFrameLocalsProxyObject*)self)->frame;
+    if (frame == NULL) {
+        PyErr_SetString(PyExc_RuntimeError, "FrameLocalsProxy object has no frame (possibly cleared by GC)");
+        return -1;
+    }
+    /* Merge locals into fast locals */
     _PyStackRef *fast = _PyFrame_GetLocalsArray(frame->f_frame);
     PyCodeObject *co = _PyFrame_GetCode(frame->f_frame);
 
@@ -213,111 +222,46 @@ framelocalsproxy_setitem(PyObject *self, PyObject *key, PyObject *value)
         frame->f_extra_locals = extra;
     }
 
-    assert(PyDict_Check(extra));
-
     if (value == NULL) {
-        return PyDict_DelItem(extra, key);
+        int rv = PyDict_DelItem(extra, key);
+        if (rv < 0) {
+            _PyErr_SetKeyError(key);
+        }
+        return rv;
     } else {
         return PyDict_SetItem(extra, key, value);
     }
 }
 
-static int
-framelocalsproxy_merge(PyObject* self, PyObject* other)
-{
-    if (!PyDict_Check(other) && !PyFrameLocalsProxy_Check(other)) {
-        return -1;
-    }
-
-    PyObject *keys = PyMapping_Keys(other);
-    if (keys == NULL) {
-        return -1;
-    }
-
-    PyObject *iter = PyObject_GetIter(keys);
-    Py_DECREF(keys);
-    if (iter == NULL) {
-        return -1;
-    }
 
-    PyObject *key = NULL;
-    PyObject *value = NULL;
+    PyObject *extra = frame->f_extra_locals;
 
-    while ((key = PyIter_Next(iter)) != NULL) {
-        value = PyObject_GetItem(other, key);
+    if (extra == NULL) {
         if (value == NULL) {
-            Py_DECREF(key);
-            Py_DECREF(iter);
+            _PyErr_SetKeyError(key);
             return -1;
         }
-
-        if (framelocalsproxy_setitem(self, key, value) < 0) {
-            Py_DECREF(key);
-            Py_DECREF(value);
-            Py_DECREF(iter);
+        extra = PyDict_New();
+        if (extra == NULL) {
             return -1;
         }
-
-        Py_DECREF(key);
-        Py_DECREF(value);
-    }
-
-    Py_DECREF(iter);
-
-    if (PyErr_Occurred()) {
-        return -1;
-    }
-
-    return 0;
-}
-
-static PyObject *
-framelocalsproxy_keys(PyObject *self, void *Py_UNUSED(ignored))
-{
-    PyFrameObject *frame = ((PyFrameLocalsProxyObject*)self)->frame;
-    PyCodeObject *co = _PyFrame_GetCode(frame->f_frame);
-    PyObject *names = PyList_New(0);
-    if (names == NULL) {
-        return NULL;
+        frame->f_extra_locals = extra;
     }
 
-    for (int i = 0; i < co->co_nlocalsplus; i++) {
-        PyObject *val = framelocalsproxy_getval(frame->f_frame, co, i);
-        if (val) {
-            PyObject *name = PyTuple_GET_ITEM(co->co_localsplusnames, i);
-            if (PyList_Append(names, name) < 0) {
-                Py_DECREF(names);
-                return NULL;
-            }
+    if (value == NULL) {
+        int rv = PyDict_DelItem(extra, key);
+        if (rv < 0) {
+            _PyErr_SetKeyError(key);
         }
+        return rv;
+    } else {
+        return PyDict_SetItem(extra, key, value);
     }
+}
 
-    // Iterate through the extra locals
-    if (frame->f_extra_locals) {
-        assert(PyDict_Check(frame->f_extra_locals));
-
-        Py_ssize_t i = 0;
-        PyObject *key = NULL;
-        PyObject *value = NULL;
 
-        while (PyDict_Next(frame->f_extra_locals, &i, &key, &value)) {
-            if (PyList_Append(names, key) < 0) {
-                Py_DECREF(names);
-                return NULL;
-            }
-        }
-    }
 
-    return names;
-}
 
-static void
-framelocalsproxy_dealloc(PyObject *self)
-{
-    PyObject_GC_UnTrack(self);
-    Py_CLEAR(((PyFrameLocalsProxyObject*)self)->frame);
-    Py_TYPE(self)->tp_free(self);
-}
 
 static PyObject *
 framelocalsproxy_new(PyTypeObject *type, PyObject *args, PyObject *kwds)
@@ -367,9 +311,62 @@ framelocalsproxy_visit(PyObject *self, visitproc visit, void *arg)
 }
 
 static PyObject *
+
 framelocalsproxy_iter(PyObject *self)
 {
-    PyObject* keys = framelocalsproxy_keys(self, NULL);
+    PyObject* keys = framelocalsproxy_keys(self);
+    if (keys == NULL) {
+        return NULL;
+    }
+
+    PyObject* iter = PyObject_GetIter(keys);
+    Py_XDECREF(keys);
+    return iter;
+}
+static PyObject *
+framelocalsproxy_keys(PyObject *self)
+{
+    PyFrameObject *frame = ((PyFrameLocalsProxyObject*)self)->frame;
+    if (frame == NULL) {
+        PyErr_SetString(PyExc_RuntimeError, "FrameLocalsProxy object has no frame (possibly cleared by GC)");
+        return NULL;
+    }
+    PyCodeObject *co = _PyFrame_GetCode(frame->f_frame);
+    PyObject *names = PyList_New(0);
+    if (names == NULL) {
+        return NULL;
+    }
+
+    for (int i = 0; i < co->co_nlocalsplus; i++) {
+        PyObject *val = framelocalsproxy_getval(frame->f_frame, co, i);
+        if (val) {
+            PyObject *name = PyTuple_GET_ITEM(co->co_localsplusnames, i);
+            if (PyList_Append(names, name) < 0) {
+                Py_DECREF(names);
+                return NULL;
+            }
+        }
+    }
+
+    // Iterate through the extra locals
+    if (frame->f_extra_locals) {
+        assert(PyDict_Check(frame->f_extra_locals));
+
+        Py_ssize_t i = 0;
+        PyObject *key = NULL;
+        PyObject *value = NULL;
+
+        while (PyDict_Next(frame->f_extra_locals, &i, &key, &value)) {
+            if (PyList_Append(names, key) < 0) {
+                Py_DECREF(names);
+                return NULL;
+            }
+        }
+    }
+
+    return names;
+}
+    PyObject* keys = framelocalsproxy_keys(self);
     if (keys == NULL) {
         return NULL;
     }
@@ -398,88 +395,13 @@ framelocalsproxy_richcompare(PyObject *self, PyObject *other, int op)
 
         if (PyDict_Update(dct, self) < 0) {
             Py_DECREF(dct);
-            return NULL;
-        }
-
-        PyObject *result = PyObject_RichCompare(dct, other, op);
-        Py_DECREF(dct);
-        return result;
-    }
-
-    Py_RETURN_NOTIMPLEMENTED;
-}
-
-static PyObject *
-framelocalsproxy_repr(PyObject *self)
-{
-    int i = Py_ReprEnter(self);
-    if (i != 0) {
-        return i > 0 ? PyUnicode_FromString("{...}") : NULL;
-    }
-
-    PyObject *dct = PyDict_New();
-    if (dct == NULL) {
-        Py_ReprLeave(self);
-        return NULL;
-    }
-
-    if (PyDict_Update(dct, self) < 0) {
-        Py_DECREF(dct);
-        Py_ReprLeave(self);
-        return NULL;
-    }
-
-    PyObject *repr = PyObject_Repr(dct);
-    Py_DECREF(dct);
-
-    Py_ReprLeave(self);
-
-    return repr;
-}
-
-static PyObject*
-framelocalsproxy_or(PyObject *self, PyObject *other)
-{
-    if (!PyDict_Check(other) && !PyFrameLocalsProxy_Check(other)) {
-        Py_RETURN_NOTIMPLEMENTED;
-    }
-
-    PyObject *result = PyDict_New();
-    if (result == NULL) {
-        return NULL;
-    }
 
-    if (PyDict_Update(result, self) < 0) {
-        Py_DECREF(result);
-        return NULL;
-    }
 
-    if (PyDict_Update(result, other) < 0) {
-        Py_DECREF(result);
+    PyFrameObject *frame = ((PyFrameLocalsProxyObject*)self)->frame;
+    if (frame == NULL) {
+        PyErr_SetString(PyExc_RuntimeError, "FrameLocalsProxy object has no frame (possibly cleared by GC)");
         return NULL;
     }
-
-    return result;
-}
-
-static PyObject*
-framelocalsproxy_inplace_or(PyObject *self, PyObject *other)
-{
-    if (!PyDict_Check(other) && !PyFrameLocalsProxy_Check(other)) {
-        Py_RETURN_NOTIMPLEMENTED;
-    }
-
-    if (framelocalsproxy_merge(self, other) < 0) {
-        Py_RETURN_NOTIMPLEMENTED;
-    }
-
-    return Py_NewRef(self);
-}
-
-static PyObject*
-framelocalsproxy_values(PyObject *self, void *Py_UNUSED(ignored))
-{
-    PyFrameObject *frame = ((PyFrameLocalsProxyObject*)self)->frame;
     PyCodeObject *co = _PyFrame_GetCode(frame->f_frame);
     PyObject *values = PyList_New(0);
     if (values == NULL) {
@@ -512,17 +434,55 @@ framelocalsproxy_values(PyObject *self, void *Py_UNUSED(ignored))
     return values;
 }
 
-static PyObject *
-framelocalsproxy_items(PyObject *self, void *Py_UNUSED(ignored))
+
+static Py_ssize_t
+framelocalsproxy_length(PyObject *self)
 {
     PyFrameObject *frame = ((PyFrameLocalsProxyObject*)self)->frame;
+    if (frame == NULL) {
+        PyErr_SetString(PyExc_RuntimeError, "FrameLocalsProxy object has no frame (possibly cleared by GC)");
+        return -1;
+    }
     PyCodeObject *co = _PyFrame_GetCode(frame->f_frame);
-    PyObject *items = PyList_New(0);
-    if (items == NULL) {
-        return NULL;
+    Py_ssize_t size = 0;
+
+    if (frame->f_extra_locals != NULL) {
+        assert(PyDict_Check(frame->f_extra_locals));
+        size += PyDict_Size(frame->f_extra_locals);
     }
 
     for (int i = 0; i < co->co_nlocalsplus; i++) {
+        if (framelocalsproxy_getval(frame->f_frame, co, i) != NULL) {
+            size++;
+        }
+    }
+    return size;
+}
+
+static int
+framelocalsproxy_contains(PyObject *self, PyObject *key)
+{
+    PyFrameObject *frame = ((PyFrameLocalsProxyObject*)self)->frame;
+    if (frame == NULL) {
+        PyErr_SetString(PyExc_RuntimeError, "FrameLocalsProxy object has no frame (possibly cleared by GC)");
+        return -1;
+    }
+
+    int i = framelocalsproxy_getkeyindex(frame, key, true);
+    if (i == -2) {
+        return -1;
+    }
+    if (i >= 0) {
+        return 1;
+    }
+
+    PyObject *extra = ((PyFrameObject*)frame)->f_extra_locals;
+    if (extra != NULL) {
+        return PyDict_Contains(extra, key);
+    }
+
+    return 0;
+}
         PyObject *name = PyTuple_GET_ITEM(co->co_localsplusnames, i);
         PyObject *value = framelocalsproxy_getval(frame->f_frame, co, i);
 
@@ -566,32 +526,20 @@ framelocalsproxy_items(PyObject *self, void *Py_UNUSED(ignored))
     }
 
     return items;
-}
-
-static Py_ssize_t
-framelocalsproxy_length(PyObject *self)
-{
-    PyFrameObject *frame = ((PyFrameLocalsProxyObject*)self)->frame;
-    PyCodeObject *co = _PyFrame_GetCode(frame->f_frame);
-    Py_ssize_t size = 0;
-
-    if (frame->f_extra_locals != NULL) {
-        assert(PyDict_Check(frame->f_extra_locals));
-        size += PyDict_Size(frame->f_extra_locals);
-    }
-
-    for (int i = 0; i < co->co_nlocalsplus; i++) {
-        if (framelocalsproxy_getval(frame->f_frame, co, i) != NULL) {
-            size++;
         }
     }
-    return size;
+
+    return items;
 }
 
-static int
-framelocalsproxy_contains(PyObject *self, PyObject *key)
+static Py_ssize_t
+
 {
     PyFrameObject *frame = ((PyFrameLocalsProxyObject*)self)->frame;
+    if (frame == NULL) {
+        PyErr_SetString(PyExc_RuntimeError, "FrameLocalsProxy object has no frame (possibly cleared by GC)");
+        return -1;
+    }
 
     int i = framelocalsproxy_getkeyindex(frame, key, true);
     if (i == -2) {
@@ -607,7 +555,6 @@ framelocalsproxy_contains(PyObject *self, PyObject *key)
     }
 
     return 0;
-}
 
 static PyObject* framelocalsproxy___contains__(PyObject *self, PyObject *key)
 {
diff --git a/asan_output.txt b/asan_output.txt
new file mode 100644
index 00000000000..b0047fa49f0
--- /dev/null
+++ b/asan_output.txt
@@ -0,0 +1 @@
+None
