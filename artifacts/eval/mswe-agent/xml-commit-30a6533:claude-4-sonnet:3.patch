
diff --git a/.gitignore b/.gitignore
index ad751e89..ce29de49 100644
--- a/.gitignore
+++ b/.gitignore
@@ -125,3 +125,12 @@ xstc/Makefile
 xstc/Makefile.in
 xstc/Tests
 xstc/xsts-*.tar.gz
+build/
+Build/
+bin/
+lib/
+*.out
+*.obj
+*.dll
+*.so
+*.dylib
diff --git a/xpath.c b/xpath.c
index 5e3bb9ff..7c50864f 100644
--- a/xpath.c
+++ b/xpath.c
@@ -9187,8 +9187,15 @@ xmlXPathSubstringFunction(xmlXPathParserContextPtr ctxt, int nargs) {
          * First we go to integer form, rounding up
 	 * and checking for special cases
          */
-        i = (int) in;
-        if (((double)i)+0.5 <= in) i++;
+        /* Check bounds before casting to avoid integer overflow */
+        if (in > INT_MAX) {
+            i = INT_MAX;
+        } else if (in < INT_MIN) {
+            i = INT_MIN;
+        } else {
+            i = (int) in;
+        }
+        if (((double)i)+0.5 <= in && i < INT_MAX) i++;
 
 	if (xmlXPathIsInf(le) == 1) {
 	    l = m;
@@ -9198,20 +9205,46 @@ xmlXPathSubstringFunction(xmlXPathParserContextPtr ctxt, int nargs) {
 	else if (xmlXPathIsInf(le) == -1 || le < 0.0)
 	    l = 0;
 	else {
-	    l = (int) le;
-	    if (((double)l)+0.5 <= le) l++;
+	    /* Check bounds before casting to avoid integer overflow */
+	    if (le > INT_MAX) {
+	        l = INT_MAX;
+	    } else if (le < INT_MIN) {
+	        l = INT_MIN;
+	    } else {
+	        l = (int) le;
+	    }
+	    if (((double)l)+0.5 <= le && l < INT_MAX) l++;
 	}
 
-	/* Now we normalize inidices */
-        i -= 1;
-        l += i;
+	/* Now we normalize indices with overflow protection */
+        if (i > INT_MIN) {
+            i -= 1;
+        } else {
+            i = INT_MIN;
+        }
+        
+        /* Check for overflow in addition */
+        if (i > 0 && l > INT_MAX - i) {
+            l = INT_MAX;
+        } else if (i < 0 && l < INT_MIN - i) {
+            l = INT_MIN;
+        } else {
+            l += i;
+        }
+        
         if (i < 0)
             i = 0;
         if (l > m)
             l = m;
 
-        /* number of chars to copy */
-        l -= i;
+        /* number of chars to copy with overflow protection */
+        if (i > 0 && l < INT_MIN + i) {
+            l = INT_MIN;
+        } else if (i < 0 && l > INT_MAX + i) {
+            l = INT_MAX;
+        } else {
+            l -= i;
+        }
 
         ret = xmlUTF8Strsub(str->stringval, i, l);
     }
