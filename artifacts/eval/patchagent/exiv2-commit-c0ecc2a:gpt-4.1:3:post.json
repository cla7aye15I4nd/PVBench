{"patch": "diff --git a/src/crwimage_int.cpp b/src/crwimage_int.cpp\nindex c2fd5f3a5..66d199f2c 100644\n--- a/src/crwimage_int.cpp\n+++ b/src/crwimage_int.cpp\n@@ -283,6 +283,8 @@ namespace Exiv2 {\n         uint32_t o = getULong(pData + size - 4, byteOrder);\n         if ( o+2 > size )\n             throw Error(kerCorruptedMetadata);\n+        if (o > size - 2)\n+            throw Error(kerCorruptedMetadata);\n         uint16_t count = getUShort(pData + o, byteOrder);\n #ifdef DEBUG\n         std::cout << \"Directory at offset \" << std::dec << o\n@@ -293,6 +295,8 @@ namespace Exiv2 {\n             throw Error(kerCorruptedMetadata);\n \n         for (uint16_t i = 0; i < count; ++i) {\n+            if (o > size - 2)\n+                throw Error(kerCorruptedMetadata);\n             uint16_t tag = getUShort(pData + o, byteOrder);\n             CiffComponent::AutoPtr m;\n             switch (CiffComponent::typeId(tag)) {\ndiff --git a/src/types.cpp b/src/types.cpp\nindex 17ab051e5..ce2a2127c 100644\n--- a/src/types.cpp\n+++ b/src/types.cpp\n@@ -277,6 +277,10 @@ namespace Exiv2 {\n \n     uint16_t getUShort(const byte* buf, ByteOrder byteOrder)\n     {\n+        if (!buf) {\n+            throw Error(kerCorruptedMetadata); // or another suitable error\n+        }\n+        // Defensive: we cannot check buffer size here, so rely on callers to check\n         return getUShort(makeSliceUntil(buf, 2), byteOrder);\n     }\n \n", "result": true}