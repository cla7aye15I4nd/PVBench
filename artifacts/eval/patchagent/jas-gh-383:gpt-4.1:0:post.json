{"patch": "diff --git a/src/libjasper/heic/heic_dec.c b/src/libjasper/heic/heic_dec.c\nindex cde3843..00785bd 100644\n--- a/src/libjasper/heic/heic_dec.c\n+++ b/src/libjasper/heic/heic_dec.c\n@@ -193,11 +193,15 @@ jas_image_t *jas_heic_decode(jas_stream_t *in, const char *optstr)\n \theif_context_read_from_memory_without_copy(ctx, ptr, size, 0);\n \n \t/* Get a handle to the primary image. */\n-\theif_context_get_primary_image_handle(ctx, &handle);\n+    struct heif_error herr = heif_context_get_primary_image_handle(ctx, &handle);\n+    if (herr.code != 0 || !handle) {\n+        jas_logerrorf(\"heif_context_get_primary_image_handle failed\\n\");\n+        goto error;\n+    }\n \n-\tint width = heif_image_handle_get_width(handle);\n-\tint height = heif_image_handle_get_height(handle);\n-\tJAS_LOGDEBUGF(1, \"width %d; height %d\\n\", width, height);\n+    int width = heif_image_handle_get_width(handle);\n+    int height = heif_image_handle_get_height(handle);\n+    JAS_LOGDEBUGF(1, \"width %d; height %d\\n\", width, height);\n \n \tsize_t num_samples;\n \tif (!jas_safe_size_mul(width, height, &num_samples)) {\n@@ -219,12 +223,16 @@ jas_image_t *jas_heic_decode(jas_stream_t *in, const char *optstr)\n \t/* Decode the image and convert the colorspace to RGB,\n \t  saved as 24bit interleaved. */\n \tstruct heif_error err;\n-\terr = heif_decode_image(handle, &img, heif_colorspace_RGB,\n-\t  heif_chroma_interleaved_RGB, 0);\n-\tif (err.code != 0) {\n-\t\tjas_logerrorf(\"heif_decode_image failed\\n\");\n-\t\tgoto error;\n-\t}\n+    if (!handle) {\n+        jas_logerrorf(\"image handle is NULL before decode\\n\");\n+        goto error;\n+    }\n+    err = heif_decode_image(handle, &img, heif_colorspace_RGB,\n+      heif_chroma_interleaved_RGB, 0);\n+    if (err.code != 0) {\n+        jas_logerrorf(\"heif_decode_image failed\\n\");\n+        goto error;\n+    }\n \n \tenum heif_colorspace colorspace = heif_image_get_colorspace(img);\n \tenum heif_chroma chroma = heif_image_get_chroma_format(img);\n", "result": true}