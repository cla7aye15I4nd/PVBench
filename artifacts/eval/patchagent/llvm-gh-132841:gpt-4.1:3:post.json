{"patch": "diff --git a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\nindex 4dc398f716b3..aac4e45ec63b 100644\n--- a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n+++ b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n@@ -15111,7 +15111,15 @@ Instruction &BoUpSLP::getLastInstructionInBundle(const TreeEntry *E) {\n       Res = (*It)->getBundle().back()->getInst();\n       return *Res;\n     }\n-    assert(E->getOpcode() == Instruction::PHI && \"Expected PHI\");\n+    // If we failed to find a schedule bundle, only expect PHI nodes.\n+    // However, in rare cases, this may not be a PHI. In that case, fall back to brute-force search.\n+    if (E->getOpcode() != Instruction::PHI) {\n+      Res = FindLastInst();\n+      if (Res)\n+        return *Res;\n+    } else {\n+      assert(E->getOpcode() == Instruction::PHI && \"Expected PHI\");\n+    }\n   }\n \n   // LastInst can still be null at this point if there's either not an entry\n", "result": true}