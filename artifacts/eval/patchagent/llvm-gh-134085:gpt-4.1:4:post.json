{"patch": "diff --git a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\nindex 838e952c024c..05c4ec9561e0 100644\n--- a/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n+++ b/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp\n@@ -14698,13 +14698,19 @@ BoUpSLP::isGatherShuffledSingleRegisterEntry(\n   // scalar in the list.\n   for (const std::pair<unsigned, int> &Pair : EntryLanes) {\n     unsigned Idx = Part * VL.size() + Pair.second;\n-    Mask[Idx] =\n-        Pair.first * VF +\n-        (ForOrder ? std::distance(\n-                        Entries[Pair.first]->Scalars.begin(),\n-                        find(Entries[Pair.first]->Scalars, VL[Pair.second]))\n-                  : Entries[Pair.first]->findLaneForValue(VL[Pair.second]));\n-    IsIdentity &= Mask[Idx] == Pair.second;\n+    if (Pair.first < Entries.size()) {\n+      Mask[Idx] =\n+          Pair.first * VF +\n+          (ForOrder ? std::distance(\n+                          Entries[Pair.first]->Scalars.begin(),\n+                          find(Entries[Pair.first]->Scalars, VL[Pair.second]))\n+                    : Entries[Pair.first]->findLaneForValue(VL[Pair.second]));\n+      IsIdentity &= Mask[Idx] == Pair.second;\n+    } else {\n+      // Out-of-bounds, mark as poison and continue safely.\n+      Mask[Idx] = PoisonMaskElem;\n+      IsIdentity = false;\n+    }\n   }\n   if (ForOrder || IsIdentity || Entries.empty()) {\n     switch (Entries.size()) {\n", "result": true}