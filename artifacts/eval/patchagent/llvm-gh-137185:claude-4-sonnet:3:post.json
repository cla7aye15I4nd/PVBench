{"patch": "diff --git a/llvm/include/llvm/IR/ConstantFolder.h b/llvm/include/llvm/IR/ConstantFolder.h\nindex a75cdf97f6ed..3ccb988d63dd 100644\n--- a/llvm/include/llvm/IR/ConstantFolder.h\n+++ b/llvm/include/llvm/IR/ConstantFolder.h\n@@ -173,7 +173,8 @@ public:\n   Value *FoldCast(Instruction::CastOps Op, Value *V,\n                   Type *DestTy) const override {\n     if (auto *C = dyn_cast<Constant>(V)) {\n-      if (ConstantExpr::isDesirableCastOp(Op))\n+      if (ConstantExpr::isDesirableCastOp(Op) &&\n+          CastInst::castIsValid(Op, C, DestTy))\n         return ConstantExpr::getCast(Op, C, DestTy);\n       return ConstantFoldCastInstruction(Op, C, DestTy);\n     }\ndiff --git a/llvm/include/llvm/IR/IRBuilder.h b/llvm/include/llvm/IR/IRBuilder.h\nindex f650c06590ef..5b917e034608 100644\n--- a/llvm/include/llvm/IR/IRBuilder.h\n+++ b/llvm/include/llvm/IR/IRBuilder.h\n@@ -2070,6 +2070,8 @@ public:\n       return V;\n     if (Value *Folded = Folder.FoldCast(Instruction::Trunc, V, DestTy))\n       return Folded;\n+    if (!CastInst::castIsValid(Instruction::Trunc, V, DestTy))\n+      return V;\n     Instruction *I = CastInst::Create(Instruction::Trunc, V, DestTy);\n     if (IsNUW)\n       I->setHasNoUnsignedWrap();\ndiff --git a/llvm/lib/IR/ConstantFold.cpp b/llvm/lib/IR/ConstantFold.cpp\nindex 7e5fda229b85..2dd9d409d1e5 100644\n--- a/llvm/lib/IR/ConstantFold.cpp\n+++ b/llvm/lib/IR/ConstantFold.cpp\n@@ -245,7 +245,8 @@ Constant *llvm::ConstantFoldCastInstruction(unsigned opc, Constant *V,\n   case Instruction::Trunc: {\n     if (ConstantInt *CI = dyn_cast<ConstantInt>(V)) {\n       uint32_t BitWidth = DestTy->getScalarSizeInBits();\n-      return ConstantInt::get(DestTy, CI->getValue().trunc(BitWidth));\n+      if (BitWidth < CI->getBitWidth())\n+        return ConstantInt::get(DestTy, CI->getValue().trunc(BitWidth));\n     }\n \n     return nullptr;\n", "result": true}