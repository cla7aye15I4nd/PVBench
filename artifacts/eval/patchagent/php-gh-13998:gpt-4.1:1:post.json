{"patch": "diff --git a/ext/pdo_sqlite/sqlite_driver.c b/ext/pdo_sqlite/sqlite_driver.c\nindex 2f494c2ddb8..f0c54f48b7c 100644\n--- a/ext/pdo_sqlite/sqlite_driver.c\n+++ b/ext/pdo_sqlite/sqlite_driver.c\n@@ -434,19 +434,31 @@ static int do_callback(struct pdo_sqlite_fci *fc, zval *cb,\n \t\t}\n \n \t\tif (agg_context) {\n-\t\t\tzval_ptr_dtor(&agg_context->val);\n+            if (!Z_ISUNDEF(agg_context->val)) {\n+                zval_ptr_dtor(&agg_context->val);\n+                ZVAL_UNDEF(&agg_context->val);\n+            }\n \t\t}\n \t} else {\n \t\t/* we're stepping in an aggregate; the return value goes into\n \t\t * the context */\n \t\tif (agg_context) {\n \t\t\tif (Z_ISUNDEF(retval)) {\n-\t\t\t\tzval_ptr_dtor(&agg_context->val);\n-\t\t\t\treturn FAILURE;\n+                if (!Z_ISUNDEF(agg_context->val)) {\n+                    zval_ptr_dtor(&agg_context->val);\n+                    ZVAL_UNDEF(&agg_context->val);\n+                }\n+                return FAILURE;\n \t\t\t}\n-\t\t\tzval_ptr_dtor(Z_REFVAL(agg_context->val));\n-\t\t\tZVAL_COPY_VALUE(Z_REFVAL(agg_context->val), &retval);\n-\t\t\tZVAL_UNDEF(&retval);\n+            if (Z_TYPE(agg_context->val) == IS_REFERENCE) {\n+                zval *refval = Z_REFVAL(agg_context->val);\n+                if (!Z_ISUNDEF_P(refval)) {\n+                    zval_ptr_dtor(refval);\n+                    ZVAL_UNDEF(refval);\n+                }\n+                ZVAL_COPY_VALUE(refval, &retval);\n+                ZVAL_UNDEF(&retval);\n+            }\n \t\t}\n \t}\n \n", "result": true}