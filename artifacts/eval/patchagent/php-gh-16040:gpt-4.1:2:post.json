{"patch": "diff --git a/Zend/zend_object_handlers.c b/Zend/zend_object_handlers.c\nindex 64e494200ee..d2079b12905 100644\n--- a/Zend/zend_object_handlers.c\n+++ b/Zend/zend_object_handlers.c\n@@ -806,48 +806,53 @@ ZEND_API zval *zend_std_read_property(zend_object *zobj, zend_string *name, int\n \t\t\tgoto exit;\n \t\t}\n \n-\t\tzend_class_entry *ce = zobj->ce;\n-\n-\t\tif (!zend_call_get_hook(prop_info, name, get, zobj, rv)) {\n-\t\t\tif (EG(exception)) {\n-\t\t\t\treturn &EG(uninitialized_zval);\n-\t\t\t}\n-\n-\t\t\t/* Reads from backing store can only occur in hooks, and hence will always remain simple. */\n-\t\t\tzend_execute_data *execute_data = EG(current_execute_data);\n-\t\t\tif (cache_slot && EX(opline) && EX(opline)->opcode == ZEND_FETCH_OBJ_R && EX(opline)->op1_type == IS_UNUSED) {\n-\t\t\t\tZEND_SET_PROPERTY_HOOK_SIMPLE_READ(cache_slot);\n-\t\t\t}\n-\n-\t\t\tproperty_offset = prop_info->offset;\n-\t\t\tif (!ZEND_TYPE_IS_SET(prop_info->type)) {\n-\t\t\t\tprop_info = NULL;\n-\t\t\t}\n-\t\t\tgoto try_again;\n-\t\t}\n-\n-\t\tif (EXPECTED(cache_slot\n-\t\t && zend_execute_ex == execute_ex\n-\t\t && zobj->ce->default_object_handlers->read_property == zend_std_read_property\n-\t\t && !zobj->ce->create_object\n-\t\t && !zend_is_in_hook(prop_info)\n-\t\t && !(prop_info->hooks[ZEND_PROPERTY_HOOK_GET]->common.fn_flags & ZEND_ACC_RETURN_REFERENCE))) {\n-\t\t\tZEND_SET_PROPERTY_HOOK_SIMPLE_GET(cache_slot);\n-\t\t}\n-\n-\t\tif (Z_TYPE_P(rv) != IS_UNDEF) {\n-\t\t\tretval = rv;\n-\t\t\tif (!Z_ISREF_P(rv)\n-\t\t\t && (type == BP_VAR_W || type == BP_VAR_RW || type == BP_VAR_UNSET)\n-\t\t\t && UNEXPECTED(Z_TYPE_P(rv) != IS_OBJECT)) {\n-\t\t\t\tzend_throw_error(NULL, \"Indirect modification of %s::$%s is not allowed\",\n-\t\t\t\t\tZSTR_VAL(ce->name), ZSTR_VAL(name));\n-\t\t\t}\n-\t\t} else {\n-\t\t\tretval = &EG(uninitialized_zval);\n-\t\t}\n-\n-\t\tgoto exit;\n+        zend_class_entry *saved_ce = zobj->ce;\n+        zend_object_handlers *saved_handlers = saved_ce->default_object_handlers;\n+        int saved_has_create_object = (saved_ce->create_object != NULL);\n+        bool saved_in_hook = zend_is_in_hook(prop_info);\n+        uint32_t saved_hook_flags = 0;\n+        if (prop_info && prop_info->hooks[ZEND_PROPERTY_HOOK_GET]) {\n+            saved_hook_flags = prop_info->hooks[ZEND_PROPERTY_HOOK_GET]->common.fn_flags;\n+        }\n+        zend_string *saved_class_name = saved_ce->name;\n+        GC_ADDREF(zobj);\n+        if (!zend_call_get_hook(prop_info, name, get, zobj, rv)) {\n+            OBJ_RELEASE(zobj);\n+            if (EG(exception)) {\n+                return &EG(uninitialized_zval);\n+            }\n+            zend_execute_data *execute_data = EG(current_execute_data);\n+            if (cache_slot && EX(opline) && EX(opline)->opcode == ZEND_FETCH_OBJ_R && EX(opline)->op1_type == IS_UNUSED) {\n+                ZEND_SET_PROPERTY_HOOK_SIMPLE_READ(cache_slot);\n+            }\n+            property_offset = prop_info->offset;\n+            if (!ZEND_TYPE_IS_SET(prop_info->type)) {\n+                prop_info = NULL;\n+            }\n+            goto try_again;\n+        }\n+        OBJ_RELEASE(zobj);\n+        if (EXPECTED(cache_slot\n+            && zend_execute_ex == execute_ex\n+            && saved_handlers->read_property == zend_std_read_property\n+            && !saved_has_create_object\n+            && !saved_in_hook\n+            && !(saved_hook_flags & ZEND_ACC_RETURN_REFERENCE))) {\n+            ZEND_SET_PROPERTY_HOOK_SIMPLE_GET(cache_slot);\n+        }\n+        if (Z_TYPE_P(rv) != IS_UNDEF) {\n+            retval = rv;\n+            if (!Z_ISREF_P(rv)\n+                && (type == BP_VAR_W || type == BP_VAR_RW || type == BP_VAR_UNSET)\n+                && UNEXPECTED(Z_TYPE_P(rv) != IS_OBJECT))\n+            {\n+                zend_throw_error(NULL, \"Indirect modification of %s::$%s is not allowed\",\n+                    ZSTR_VAL(saved_class_name), ZSTR_VAL(name));\n+            }\n+        } else {\n+            retval = &EG(uninitialized_zval);\n+        }\n+        goto exit;\n \t} else if (UNEXPECTED(EG(exception))) {\n \t\tretval = &EG(uninitialized_zval);\n \t\tgoto exit;\n", "result": true}