{"patch": "diff --git a/ext/spl/spl_observer.c b/ext/spl/spl_observer.c\nindex cc2956ccc27..61a9c47ccde 100644\n--- a/ext/spl/spl_observer.c\n+++ b/ext/spl/spl_observer.c\n@@ -789,20 +789,26 @@ PHP_METHOD(SplObjectStorage, serialize)\n \n \tzend_hash_internal_pointer_reset_ex(&intern->storage, &pos);\n \n-\twhile (zend_hash_has_more_elements_ex(&intern->storage, &pos) == SUCCESS) {\n-\t\tzval obj;\n-\t\tif ((element = zend_hash_get_current_data_ptr_ex(&intern->storage, &pos)) == NULL) {\n-\t\t\tsmart_str_free(&buf);\n-\t\t\tPHP_VAR_SERIALIZE_DESTROY(var_hash);\n-\t\t\tRETURN_NULL();\n-\t\t}\n-\t\tZVAL_OBJ(&obj, element->obj);\n-\t\tphp_var_serialize(&buf, &obj, &var_hash);\n-\t\tsmart_str_appendc(&buf, ',');\n-\t\tphp_var_serialize(&buf, &element->inf, &var_hash);\n-\t\tsmart_str_appendc(&buf, ';');\n-\t\tzend_hash_move_forward_ex(&intern->storage, &pos);\n+while (zend_hash_has_more_elements_ex(&intern->storage, &pos) == SUCCESS) {\n+\tzval obj_copy;\n+\tzval inf_copy;\n+\tzend_object *obj_ptr;\n+\tif ((element = zend_hash_get_current_data_ptr_ex(&intern->storage, &pos)) == NULL) {\n+\t\tsmart_str_free(&buf);\n+\t\tPHP_VAR_SERIALIZE_DESTROY(var_hash);\n+\t\tRETURN_NULL();\n \t}\n+\tobj_ptr = element->obj;\n+\tZVAL_OBJ(&obj_copy, obj_ptr);\n+\tZVAL_DUP(&inf_copy, &element->inf);\n+\t/* After this point, do not access element! */\n+\tphp_var_serialize(&buf, &obj_copy, &var_hash);\n+\tsmart_str_appendc(&buf, ',');\n+\tphp_var_serialize(&buf, &inf_copy, &var_hash);\n+\tzval_ptr_dtor(&inf_copy);\n+\tsmart_str_appendc(&buf, ';');\n+\tzend_hash_move_forward_ex(&intern->storage, &pos);\n+}\n \n \t/* members */\n \tsmart_str_appendl(&buf, \"m:\", 2);\n", "result": true}