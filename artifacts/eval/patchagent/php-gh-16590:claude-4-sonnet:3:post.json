{"patch": "diff --git a/ext/session/session.c b/ext/session/session.c\nindex b23f1fce358..bf50a3b5e7a 100644\n--- a/ext/session/session.c\n+++ b/ext/session/session.c\n@@ -1055,21 +1055,37 @@ PS_SERIALIZER_DECODE_FUNC(php_binary) /* {{{ */\n PS_SERIALIZER_ENCODE_FUNC(php) /* {{{ */\n {\n \tsmart_str buf = {0};\n+\tzval session_copy;\n+\tHashTable *session_ht;\n \tphp_serialize_data_t var_hash;\n \tPS_ENCODE_VARS;\n \n \tPHP_VAR_SERIALIZE_INIT(var_hash);\n \n-\tPS_ENCODE_LOOP(\n+\t/* Create a copy of the session variables to prevent use-after-free\n+\t * when magic methods modify the original during serialization */\n+\tZVAL_COPY(&session_copy, Z_REFVAL(PS(http_session_vars)));\n+\tsession_ht = Z_ARRVAL(session_copy);\n+\n+\tZEND_HASH_FOREACH_KEY(session_ht, num_key, key) {\n+\t\tif (key == NULL) {\n+\t\t\tphp_error_docref(NULL, E_WARNING, \"Skipping numeric key \" ZEND_LONG_FMT, num_key);\n+\t\t\tcontinue;\n+\t\t}\n+\t\tif ((struc = zend_hash_find(session_ht, key))) {\n \t\tsmart_str_appendl(&buf, ZSTR_VAL(key), ZSTR_LEN(key));\n \t\tif (memchr(ZSTR_VAL(key), PS_DELIMITER, ZSTR_LEN(key))) {\n+\t\t\tzval_ptr_dtor(&session_copy);\n \t\t\tPHP_VAR_SERIALIZE_DESTROY(var_hash);\n \t\t\tsmart_str_free(&buf);\n \t\t\treturn NULL;\n \t\t}\n \t\tsmart_str_appendc(&buf, PS_DELIMITER);\n \t\tphp_var_serialize(&buf, struc, &var_hash);\n-\t);\n+\t\t}\n+\t} ZEND_HASH_FOREACH_END();\n+\n+\tzval_ptr_dtor(&session_copy);\n \n \tsmart_str_0(&buf);\n \n", "result": true}