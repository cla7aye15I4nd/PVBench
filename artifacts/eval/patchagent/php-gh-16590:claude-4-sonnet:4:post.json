{"patch": "diff --git a/ext/session/session.c b/ext/session/session.c\nindex b23f1fce358..ab96261a471 100644\n--- a/ext/session/session.c\n+++ b/ext/session/session.c\n@@ -1056,24 +1056,55 @@ PS_SERIALIZER_ENCODE_FUNC(php) /* {{{ */\n {\n \tsmart_str buf = {0};\n \tphp_serialize_data_t var_hash;\n-\tPS_ENCODE_VARS;\n+\tzend_string *key;\n+\tzend_ulong num_key;\n+\tzval *struc;\n+\tHashTable *session_ht;\n+\tHashTable *temp_ht = NULL;\n+\tzval *temp_val;\n \n \tPHP_VAR_SERIALIZE_INIT(var_hash);\n \n-\tPS_ENCODE_LOOP(\n+\tIF_SESSION_VARS() {\n+\t\tsession_ht = Z_ARRVAL_P(Z_REFVAL(PS(http_session_vars)));\n+\t\t\n+\t\t/* Create a temporary copy of the session variables to avoid use-after-free */\n+\t\tALLOC_HASHTABLE(temp_ht);\n+\t\tzend_hash_init(temp_ht, zend_hash_num_elements(session_ht), NULL, ZVAL_PTR_DTOR, 0);\n+\t\tzend_hash_copy(temp_ht, session_ht, (copy_ctor_func_t) zval_add_ref);\n+\t}\n+\n+\tif (temp_ht) {\n+\t\tZEND_HASH_FOREACH_KEY_VAL(temp_ht, num_key, key, temp_val) {\n+\t\t\tif (key == NULL) {\n+\t\t\t\tphp_error_docref(NULL, E_WARNING,\n+\t\t\t\t\t\t\"Skipping numeric key \" ZEND_LONG_FMT, num_key);\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\t\t\tif ((struc = php_get_session_var(key))) {\n \t\tsmart_str_appendl(&buf, ZSTR_VAL(key), ZSTR_LEN(key));\n \t\tif (memchr(ZSTR_VAL(key), PS_DELIMITER, ZSTR_LEN(key))) {\n \t\t\tPHP_VAR_SERIALIZE_DESTROY(var_hash);\n \t\t\tsmart_str_free(&buf);\n+\t\t\t\tif (temp_ht) {\n+\t\t\t\t\tzend_hash_destroy(temp_ht);\n+\t\t\t\t\tFREE_HASHTABLE(temp_ht);\n+\t\t\t\t}\n \t\t\treturn NULL;\n \t\t}\n \t\tsmart_str_appendc(&buf, PS_DELIMITER);\n \t\tphp_var_serialize(&buf, struc, &var_hash);\n-\t);\n+\t\t\t}\n+\t\t} ZEND_HASH_FOREACH_END();\n+\t}\n \n \tsmart_str_0(&buf);\n \n \tPHP_VAR_SERIALIZE_DESTROY(var_hash);\n+\tif (temp_ht) {\n+\t\tzend_hash_destroy(temp_ht);\n+\t\tFREE_HASHTABLE(temp_ht);\n+\t}\n \treturn buf.s;\n }\n /* }}} */\n", "result": true}