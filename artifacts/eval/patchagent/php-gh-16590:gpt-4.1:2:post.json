{"patch": "diff --git a/ext/session/session.c b/ext/session/session.c\nindex b23f1fce358..7c32a2aa6f2 100644\n--- a/ext/session/session.c\n+++ b/ext/session/session.c\n@@ -1054,22 +1054,39 @@ PS_SERIALIZER_DECODE_FUNC(php_binary) /* {{{ */\n \n PS_SERIALIZER_ENCODE_FUNC(php) /* {{{ */\n {\n-\tsmart_str buf = {0};\n-\tphp_serialize_data_t var_hash;\n-\tPS_ENCODE_VARS;\n-\n-\tPHP_VAR_SERIALIZE_INIT(var_hash);\n+    smart_str buf = {0};\n+    php_serialize_data_t var_hash;\n+    PS_ENCODE_VARS;\n+    HashTable *orig_ht = NULL, *copy_ht = NULL;\n+\n+    PHP_VAR_SERIALIZE_INIT(var_hash);\n+\n+    /* Make a shallow copy of the session array for safe iteration */\n+    IF_SESSION_VARS() {\n+        orig_ht = Z_ARRVAL_P(Z_REFVAL(PS(http_session_vars)));\n+        copy_ht = zend_array_dup(orig_ht);\n+    } else {\n+        return NULL;\n+    }\n \n-\tPS_ENCODE_LOOP(\n-\t\tsmart_str_appendl(&buf, ZSTR_VAL(key), ZSTR_LEN(key));\n-\t\tif (memchr(ZSTR_VAL(key), PS_DELIMITER, ZSTR_LEN(key))) {\n-\t\t\tPHP_VAR_SERIALIZE_DESTROY(var_hash);\n-\t\t\tsmart_str_free(&buf);\n-\t\t\treturn NULL;\n-\t\t}\n-\t\tsmart_str_appendc(&buf, PS_DELIMITER);\n-\t\tphp_var_serialize(&buf, struc, &var_hash);\n-\t);\n+    ZEND_HASH_FOREACH_KEY(copy_ht, num_key, key) {\n+        if (key == NULL) {\n+            php_error_docref(NULL, E_WARNING, \"Skipping numeric key \" ZEND_LONG_FMT, num_key);\n+            continue;\n+        }\n+        if ((struc = php_get_session_var(key))) {\n+            smart_str_appendl(&buf, ZSTR_VAL(key), ZSTR_LEN(key));\n+            if (memchr(ZSTR_VAL(key), PS_DELIMITER, ZSTR_LEN(key))) {\n+                PHP_VAR_SERIALIZE_DESTROY(var_hash);\n+                smart_str_free(&buf);\n+                zend_array_release(copy_ht);\n+                return NULL;\n+            }\n+            smart_str_appendc(&buf, PS_DELIMITER);\n+            php_var_serialize(&buf, struc, &var_hash);\n+        }\n+    } ZEND_HASH_FOREACH_END();\n+    zend_array_release(copy_ht);\n \n \tsmart_str_0(&buf);\n \n", "result": true}