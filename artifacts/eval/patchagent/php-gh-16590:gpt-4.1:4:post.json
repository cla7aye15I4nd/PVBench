{"patch": "diff --git a/ext/session/session.c b/ext/session/session.c\nindex b23f1fce358..202763d9a60 100644\n--- a/ext/session/session.c\n+++ b/ext/session/session.c\n@@ -1060,16 +1060,34 @@ PS_SERIALIZER_ENCODE_FUNC(php) /* {{{ */\n \n \tPHP_VAR_SERIALIZE_INIT(var_hash);\n \n-\tPS_ENCODE_LOOP(\n-\t\tsmart_str_appendl(&buf, ZSTR_VAL(key), ZSTR_LEN(key));\n-\t\tif (memchr(ZSTR_VAL(key), PS_DELIMITER, ZSTR_LEN(key))) {\n-\t\t\tPHP_VAR_SERIALIZE_DESTROY(var_hash);\n-\t\t\tsmart_str_free(&buf);\n-\t\t\treturn NULL;\n-\t\t}\n-\t\tsmart_str_appendc(&buf, PS_DELIMITER);\n-\t\tphp_var_serialize(&buf, struc, &var_hash);\n-\t);\n+\tHashTable *session_ht = NULL;\n+\tzval *session_vars_ref = &PS(http_session_vars);\n+\tif (!Z_ISUNDEF_P(session_vars_ref) && Z_TYPE_P(session_vars_ref) == IS_REFERENCE) {\n+\t\tzval *session_vars_zv = Z_REFVAL_P(session_vars_ref);\n+\t\tif (session_vars_zv && Z_TYPE_P(session_vars_zv) == IS_ARRAY) {\n+\t\t\tsession_ht = zend_array_dup(Z_ARRVAL_P(session_vars_zv));\n+\t\t}\n+\t}\n+\tif (session_ht) {\n+\t\tZEND_HASH_FOREACH_KEY(session_ht, num_key, key) {\n+\t\t\tif (key == NULL) {\n+\t\t\t\tphp_error_docref(NULL, E_WARNING, \"Skipping numeric key \" ZEND_LONG_FMT, num_key);\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\t\t\tif ((struc = php_get_session_var(key))) {\n+\t\t\t\tsmart_str_appendl(&buf, ZSTR_VAL(key), ZSTR_LEN(key));\n+\t\t\t\tif (memchr(ZSTR_VAL(key), PS_DELIMITER, ZSTR_LEN(key))) {\n+\t\t\t\t\tPHP_VAR_SERIALIZE_DESTROY(var_hash);\n+\t\t\t\t\tsmart_str_free(&buf);\n+\t\t\t\t\tzend_array_destroy(session_ht);\n+\t\t\t\t\treturn NULL;\n+\t\t\t\t}\n+\t\t\t\tsmart_str_appendc(&buf, PS_DELIMITER);\n+\t\t\t\tphp_var_serialize(&buf, struc, &var_hash);\n+\t\t\t}\n+\t\t} ZEND_HASH_FOREACH_END();\n+\t\tzend_array_destroy(session_ht);\n+\t}\n \n \tsmart_str_0(&buf);\n \n", "result": true}