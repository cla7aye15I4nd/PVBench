{"patch": "diff --git a/Zend/zend_objects_API.c b/Zend/zend_objects_API.c\nindex 80f5b747db7..758e78be632 100644\n--- a/Zend/zend_objects_API.c\n+++ b/Zend/zend_objects_API.c\n@@ -179,10 +179,18 @@ ZEND_API void ZEND_FASTCALL zend_objects_store_del(zend_object *object) /* {{{ *\n \n \t\tif (object->handlers->dtor_obj != zend_objects_destroy_object\n \t\t\t\t|| object->ce->destructor) {\n+\t\t\tuint32_t handle = object->handle;\n \t\t\tzend_fiber_switch_block();\n \t\t\tGC_SET_REFCOUNT(object, 1);\n \t\t\tobject->handlers->dtor_obj(object);\n-\t\t\tGC_DELREF(object);\n+\t\t\t/* Check if object was freed during destructor call */\n+\t\t\tif (IS_OBJ_VALID(EG(objects_store).object_buckets[handle])) {\n+\t\t\t\tGC_DELREF(object);\n+\t\t\t} else {\n+\t\t\t\t/* Object was freed during destructor call, nothing more to do */\n+\t\t\t\tzend_fiber_switch_unblock();\n+\t\t\t\treturn;\n+\t\t\t}\n \t\t\tzend_fiber_switch_unblock();\n \t\t}\n \t}\ndiff --git a/ext/spl/spl_array.c b/ext/spl/spl_array.c\nindex dbe110f7c40..03b4ac5638d 100644\n--- a/ext/spl/spl_array.c\n+++ b/ext/spl/spl_array.c\n@@ -555,12 +555,17 @@ static void spl_array_unset_dimension_ex(int check_inherited, zend_object *objec\n \t\t\tif (Z_TYPE_P(data) == IS_INDIRECT) {\n \t\t\t\tdata = Z_INDIRECT_P(data);\n \t\t\t\tif (Z_TYPE_P(data) != IS_UNDEF) {\n+\t\t\t\t\t/* Save the hash table pointer before calling destructor */\n+\t\t\t\t\tHashTable *saved_ht = ht;\n \t\t\t\t\tzval_ptr_dtor(data);\n-\t\t\t\t\tZVAL_UNDEF(data);\n-\t\t\t\t\tHT_FLAGS(ht) |= HASH_FLAG_HAS_EMPTY_IND;\n-\t\t\t\t\tzend_hash_move_forward_ex(ht, spl_array_get_pos_ptr(ht, intern));\n-\t\t\t\t\tif (spl_array_is_object(intern)) {\n-\t\t\t\t\t\tspl_array_skip_protected(intern, ht);\n+\t\t\t\t\t/* Check if hash table is still valid after destructor call */\n+\t\t\t\t\tif (ht == saved_ht && ht == spl_array_get_hash_table(intern)) {\n+\t\t\t\t\t\tZVAL_UNDEF(data);\n+\t\t\t\t\t\tHT_FLAGS(ht) |= HASH_FLAG_HAS_EMPTY_IND;\n+\t\t\t\t\t\tzend_hash_move_forward_ex(ht, spl_array_get_pos_ptr(ht, intern));\n+\t\t\t\t\t\tif (spl_array_is_object(intern)) {\n+\t\t\t\t\t\t\tspl_array_skip_protected(intern, ht);\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t} else {\n", "result": true}