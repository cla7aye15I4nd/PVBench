{"patch": "diff --git a/src/ex_docmd.c b/src/ex_docmd.c\nindex 26acc07e0..988d3570f 100644\n--- a/src/ex_docmd.c\n+++ b/src/ex_docmd.c\n@@ -3437,16 +3437,27 @@ append_command(char_u *cmd)\n     d = IObuff + STRLEN(IObuff);\n     while (*s != NUL && d - IObuff < IOSIZE - 7)\n     {\n-\tif (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n-\t{\n-\t    s += enc_utf8 ? 2 : 1;\n-\t    STRCPY(d, \"<a0>\");\n-\t    d += 4;\n-\t}\n-\telse\n-\t    MB_COPY_CHAR(s, d);\n-    }\n-    *d = NUL;\n+        if (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n+        {\n+            int needed = 4; // \"<a0>\"\n+            if (d - IObuff + needed >= IOSIZE)\n+                break;\n+            s += enc_utf8 ? 2 : 1;\n+            STRCPY(d, \"<a0>\");\n+            d += 4;\n+        }\n+        else\n+        {\n+            int charlen = has_mbyte ? (*mb_ptr2len)(s) : 1;\n+            if (d - IObuff + charlen >= IOSIZE)\n+                break;\n+            MB_COPY_CHAR(s, d);\n+        }\n+    }\n+    if (d - IObuff < IOSIZE)\n+        *d = NUL;\n+    else\n+        IObuff[IOSIZE - 1] = NUL;\n }\n \n #if defined(FEAT_EVAL) || defined(PROTO)\n", "result": true}