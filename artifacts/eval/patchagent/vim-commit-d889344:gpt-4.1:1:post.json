{"patch": "diff --git a/src/ex_docmd.c b/src/ex_docmd.c\nindex 26acc07e0..aa743aff9 100644\n--- a/src/ex_docmd.c\n+++ b/src/ex_docmd.c\n@@ -3435,18 +3435,26 @@ append_command(char_u *cmd)\n \n     STRCAT(IObuff, \": \");\n     d = IObuff + STRLEN(IObuff);\n-    while (*s != NUL && d - IObuff < IOSIZE - 7)\n-    {\n-\tif (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n-\t{\n-\t    s += enc_utf8 ? 2 : 1;\n-\t    STRCPY(d, \"<a0>\");\n-\t    d += 4;\n-\t}\n-\telse\n-\t    MB_COPY_CHAR(s, d);\n-    }\n-    *d = NUL;\n+    while (*s != NUL && d - IObuff < IOSIZE - 1) {\n+        if ((enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)) {\n+            // Need 5 bytes: 4 for \"<a0>\" and 1 for NUL\n+            if (d - IObuff > IOSIZE - 5)\n+                break;\n+            s += enc_utf8 ? 2 : 1;\n+            STRCPY(d, \"<a0>\");\n+            d += 4;\n+        } else {\n+            int char_len = enc_utf8 ? utf_ptr2len(s) : (*mb_ptr2len)(s);\n+            if (d - IObuff > IOSIZE - (char_len + 1))\n+                break;\n+            MB_COPY_CHAR(s, d);\n+        }\n+    }\n+    // Ensure NUL-termination and do not write past the buffer\n+    if (d - IObuff >= IOSIZE)\n+        IObuff[IOSIZE - 1] = NUL;\n+    else\n+        *d = NUL;\n }\n \n #if defined(FEAT_EVAL) || defined(PROTO)\n", "result": true}