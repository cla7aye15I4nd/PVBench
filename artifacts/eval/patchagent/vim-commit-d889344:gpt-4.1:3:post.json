{"patch": "--- a/src/ex_docmd.c\n+++ b/src/ex_docmd.c\n@@ -3438,13 +3438,19 @@\n     while (*s != NUL && d - IObuff < IOSIZE - 7)\n     {\n \tif (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n \t{\n \t    s += enc_utf8 ? 2 : 1;\n \t    STRCPY(d, \"<a0>\");\n \t    d += 4;\n \t}\n-\telse\n-\t    MB_COPY_CHAR(s, d);\n+    else\n+    {\n+        int charlen = has_mbyte ? (*mb_ptr2len)(s) : 1;\n+        // Ensure there is enough space for the character and the NUL terminator\n+        if (d - IObuff + charlen >= IOSIZE - 1)\n+            break;\n+        MB_COPY_CHAR(s, d);\n+    }\n     }\n     *d = NUL;\n }\n", "result": true}