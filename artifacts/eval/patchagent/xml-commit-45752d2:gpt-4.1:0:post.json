{"patch": "diff --git a/parser.c b/parser.c\nindex 4464e2e8..a3fa37de 100644\n--- a/parser.c\n+++ b/parser.c\n@@ -3472,7 +3472,7 @@ xmlParseNCNameComplex(xmlParserCtxtPtr ctxt) {\n     int len = 0, l;\n     int c;\n     int count = 0;\n-    const xmlChar *end; /* needed because CUR_CHAR() can move cur on \\r\\n */\n+    size_t end_offset; /* offset from base, safe across buffer reallocs */\n \n #ifdef DEBUG\n     nbParseNCNameComplex++;\n@@ -3482,7 +3482,7 @@ xmlParseNCNameComplex(xmlParserCtxtPtr ctxt) {\n      * Handler for more complex cases\n      */\n     GROW;\n-    end = ctxt->input->cur;\n+    end_offset = ctxt->input->cur - ctxt->input->base;\n     c = CUR_CHAR(l);\n     if ((c == ' ') || (c == '>') || (c == '/') || /* accelerators */\n \t(!xmlIsNameStartChar(ctxt, c) || (c == ':'))) {\n@@ -3501,10 +3501,12 @@ xmlParseNCNameComplex(xmlParserCtxtPtr ctxt) {\n \t    GROW;\n             if (ctxt->instate == XML_PARSER_EOF)\n                 return(NULL);\n+            /* update end_offset after GROW */\n+            end_offset = ctxt->input->cur - ctxt->input->base;\n \t}\n \tlen += l;\n \tNEXTL(l);\n-\tend = ctxt->input->cur;\n+    end_offset = ctxt->input->cur - ctxt->input->base;\n \tc = CUR_CHAR(l);\n \tif (c == 0) {\n \t    count = 0;\n@@ -3518,8 +3520,8 @@ xmlParseNCNameComplex(xmlParserCtxtPtr ctxt) {\n \t    ctxt->input->cur += l;\n             if (ctxt->instate == XML_PARSER_EOF)\n                 return(NULL);\n-\t    end = ctxt->input->cur;\n-\t    c = CUR_CHAR(l);\n+            end_offset = ctxt->input->cur - ctxt->input->base;\n+            c = CUR_CHAR(l);\n \t}\n     }\n     if ((len > XML_MAX_NAME_LENGTH) &&\n@@ -3527,7 +3529,7 @@ xmlParseNCNameComplex(xmlParserCtxtPtr ctxt) {\n         xmlFatalErr(ctxt, XML_ERR_NAME_TOO_LONG, \"NCName\");\n         return(NULL);\n     }\n-    return(xmlDictLookup(ctxt->dict, end - len, len));\n+    return(xmlDictLookup(ctxt->dict, ctxt->input->base + end_offset - len, len));\n }\n \n /**\n", "result": true}