[{"patch": "diff --git a/clang/lib/Sema/SemaDeclCXX.cpp b/clang/lib/Sema/SemaDeclCXX.cpp\nindex 2142582adf6e..d1e1cf6efaa6 100644\n--- a/clang/lib/Sema/SemaDeclCXX.cpp\n+++ b/clang/lib/Sema/SemaDeclCXX.cpp\n@@ -9005,10 +9005,18 @@ bool Sema::CheckExplicitlyDefaultedComparison(Scope *S, FunctionDecl *FD,\n                             int(1)))\n       return true;\n \n-    if (llvm::none_of(RD->friends(), [&](const FriendDecl *F) {\n-          return FD->getCanonicalDecl() ==\n-                 F->getFriendDecl()->getCanonicalDecl();\n-        })) {\n+    // Check friends safely to avoid potential iterator invalidation\n+    bool IsFriend = false;\n+    auto Friends = RD->friends();\n+    for (const FriendDecl *F : Friends) {\n+      if (F && F->getFriendDecl() && \n+          FD->getCanonicalDecl() == F->getFriendDecl()->getCanonicalDecl()) {\n+        IsFriend = true;\n+        break;\n+      }\n+    }\n+    \n+    if (!IsFriend) {\n       Diag(FD->getLocation(), diag::err_defaulted_comparison_not_friend)\n           << int(DCK) << int(0) << RD;\n       Diag(RD->getCanonicalDecl()->getLocation(), diag::note_declared_at);\n"}]