[{"patch": "diff --git a/llvm/lib/CodeGen/SelectionDAG/LegalizeDAG.cpp b/llvm/lib/CodeGen/SelectionDAG/LegalizeDAG.cpp\nindex 1cacab9528ca..a4e84e20910e 100644\n--- a/llvm/lib/CodeGen/SelectionDAG/LegalizeDAG.cpp\n+++ b/llvm/lib/CodeGen/SelectionDAG/LegalizeDAG.cpp\n@@ -956,7 +956,7 @@ void SelectionDAGLegalize::LegalizeOp(SDNode *Node) {\n \n   // Allow illegal target nodes and illegal registers.\n   if (Node->getOpcode() == ISD::TargetConstant ||\n-      Node->getOpcode() == ISD::Register)\n+  Node->getOpcode() == ISD::Register)\n     return;\n \n #ifndef NDEBUG\n@@ -964,20 +964,27 @@ void SelectionDAGLegalize::LegalizeOp(SDNode *Node) {\n     assert(TLI.getTypeAction(*DAG.getContext(), Node->getValueType(i)) ==\n              TargetLowering::TypeLegal &&\n            \"Unexpected illegal type!\");\n-\n-  for (const SDValue &Op : Node->op_values())\n-    assert((TLI.getTypeAction(*DAG.getContext(), Op.getValueType()) ==\n-              TargetLowering::TypeLegal ||\n-            Op.getOpcode() == ISD::TargetConstant ||\n-            Op.getOpcode() == ISD::Register) &&\n-            \"Unexpected illegal type!\");\n #endif\n+  // Runtime check to prevent illegal types in Release builds\n+  for (unsigned i = 0, e = Node->getNumValues(); i != e; ++i) {\n+    if (TLI.getTypeAction(*DAG.getContext(), Node->getValueType(i)) != TargetLowering::TypeLegal) {\n+      report_fatal_error(\"Illegal type encountered in SelectionDAGLegalize::LegalizeOp\", false);\n+      return;\n+    }\n+  }\n+  for (const SDValue &Op : Node->op_values()) {\n+    if (!(TLI.getTypeAction(*DAG.getContext(), Op.getValueType()) == TargetLowering::TypeLegal ||\n+          Op.getOpcode() == ISD::TargetConstant ||\n+          Op.getOpcode() == ISD::Register)) {\n+      report_fatal_error(\"Illegal operand type in SelectionDAGLegalize::LegalizeOp\", false);\n+      return;\n+    }\n+  }\n \n   // Figure out the correct action; the way to query this varies by opcode\n   TargetLowering::LegalizeAction Action = TargetLowering::Legal;\n   bool SimpleFinishLegalizing = true;\n-  switch (Node->getOpcode()) {\n-  case ISD::INTRINSIC_W_CHAIN:\n+  switch (Node->getOpcode()) {  case ISD::INTRINSIC_W_CHAIN:\n   case ISD::INTRINSIC_WO_CHAIN:\n   case ISD::INTRINSIC_VOID:\n   case ISD::STACKSAVE:\n"}]