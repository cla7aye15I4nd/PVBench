[{"patch": "diff --git a/llvm/lib/Analysis/MemorySSAUpdater.cpp b/llvm/lib/Analysis/MemorySSAUpdater.cpp\nindex aa9f0b6e100c..10394d161e55 100644\n--- a/llvm/lib/Analysis/MemorySSAUpdater.cpp\n+++ b/llvm/lib/Analysis/MemorySSAUpdater.cpp\n@@ -565,9 +565,14 @@ static MemoryAccess *onlySingleValue(MemoryPhi *MP) {\n   return MA;\n }\n \n-static MemoryAccess *getNewDefiningAccessForClone(\n+static MemoryAccess *getNewDefiningAccessForCloneHelper(\n     MemoryAccess *MA, const ValueToValueMapTy &VMap, PhiToDefMap &MPhiMap,\n-    MemorySSA *MSSA, function_ref<bool(BasicBlock *BB)> IsInClonedRegion) {\n+    MemorySSA *MSSA, function_ref<bool(BasicBlock *BB)> IsInClonedRegion,\n+    SmallPtrSet<MemoryAccess *, 8> &Visited) {\n+  if (Visited.count(MA))\n+    return MA;\n+  Visited.insert(MA);\n+  \n   MemoryAccess *InsnDefining = MA;\n   if (MemoryDef *DefMUD = dyn_cast<MemoryDef>(InsnDefining)) {\n     if (MSSA->isLiveOnEntryDef(DefMUD))\n@@ -583,8 +588,8 @@ static MemoryAccess *getNewDefiningAccessForClone(\n     InsnDefining = NewDefMUDI ? MSSA->getMemoryAccess(NewDefMUDI) : nullptr;\n     if (!InsnDefining || isa<MemoryUse>(InsnDefining)) {\n       // The clone was simplified, it's no longer a MemoryDef, look up.\n-      InsnDefining = getNewDefiningAccessForClone(\n-          DefMUD->getDefiningAccess(), VMap, MPhiMap, MSSA, IsInClonedRegion);\n+      InsnDefining = getNewDefiningAccessForCloneHelper(\n+          DefMUD->getDefiningAccess(), VMap, MPhiMap, MSSA, IsInClonedRegion, Visited);\n     }\n   } else {\n     MemoryPhi *DefPhi = cast<MemoryPhi>(InsnDefining);\n@@ -595,6 +600,13 @@ static MemoryAccess *getNewDefiningAccessForClone(\n   return InsnDefining;\n }\n \n+static MemoryAccess *getNewDefiningAccessForClone(\n+    MemoryAccess *MA, const ValueToValueMapTy &VMap, PhiToDefMap &MPhiMap,\n+    MemorySSA *MSSA, function_ref<bool(BasicBlock *BB)> IsInClonedRegion) {\n+  SmallPtrSet<MemoryAccess *, 8> Visited;\n+  return getNewDefiningAccessForCloneHelper(MA, VMap, MPhiMap, MSSA, IsInClonedRegion, Visited);\n+}\n+\n void MemorySSAUpdater::cloneUsesAndDefs(\n     BasicBlock *BB, BasicBlock *NewBB, const ValueToValueMapTy &VMap,\n     PhiToDefMap &MPhiMap, function_ref<bool(BasicBlock *)> IsInClonedRegion,\n"}]