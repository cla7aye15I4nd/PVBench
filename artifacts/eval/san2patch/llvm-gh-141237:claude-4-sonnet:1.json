[{"patch": "diff --git a/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp b/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\nindex 275b3d567856..28c6503f4717 100644\n--- a/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\n+++ b/llvm/lib/Transforms/Vectorize/LoopVectorize.cpp\n@@ -7473,20 +7473,23 @@ VectorizationFactor LoopVectorizationPlanner::computeBestVF() {\n                         CM.CostKind);\n   precomputeCosts(BestPlan, BestFactor.Width, CostCtx);\n   // Verify that the VPlan-based and legacy cost models agree, except for VPlans\n-  // with early exits and plans with additional VPlan simplifications. The\n+// FIXME: Crash CWE-754: Improper Check for Unusual or Exceptional Conditions\n+   // with early exits and plans with additional VPlan simplifications. The\n   // legacy cost model doesn't properly model costs for such loops.\n-  assert((BestFactor.Width == LegacyVF.Width || BestPlan.hasEarlyExit() ||\n-          planContainsAdditionalSimplifications(getPlanFor(BestFactor.Width),\n-                                                CostCtx, OrigLoop) ||\n-          planContainsAdditionalSimplifications(getPlanFor(LegacyVF.Width),\n-                                                CostCtx, OrigLoop)) &&\n-         \" VPlan cost model and legacy cost model disagreed\");\n+  if (!(BestFactor.Width == LegacyVF.Width || BestPlan.hasEarlyExit() ||\n+        planContainsAdditionalSimplifications(getPlanFor(BestFactor.Width),\n+                                              CostCtx, OrigLoop) ||\n+        planContainsAdditionalSimplifications(getPlanFor(LegacyVF.Width),\n+                                              CostCtx, OrigLoop))) {\n+    LLVM_DEBUG(dbgs() << \"LV: VPlan cost model and legacy cost model disagreed. \"\n+                      << \"Using legacy cost model VF: \" << LegacyVF.Width << \"\\n\");\n+    BestFactor = LegacyVF;\n+  }\n   assert((BestFactor.Width.isScalar() || BestFactor.ScalarCost > 0) &&\n          \"when vectorizing, the scalar cost must be computed.\");\n #endif\n \n-  LLVM_DEBUG(dbgs() << \"LV: Selecting VF: \" << BestFactor.Width << \".\\n\");\n-  return BestFactor;\n+  LLVM_DEBUG(dbgs() << \"LV: Selecting VF: \" << BestFactor.Width << \".\\n\");  return BestFactor;\n }\n \n static void addRuntimeUnrollDisableMetaData(Loop *L) {\n"}]