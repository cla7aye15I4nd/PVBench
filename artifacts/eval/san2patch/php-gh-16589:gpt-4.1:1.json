[{"patch": "diff --git a/ext/spl/spl_dllist.c b/ext/spl/spl_dllist.c\nindex 6592efc4e5e..d716340ecdc 100644\n--- a/ext/spl/spl_dllist.c\n+++ b/ext/spl/spl_dllist.c\n@@ -1012,28 +1012,48 @@ PHP_METHOD(SplDoublyLinkedList, serialize)\n \tif (zend_parse_parameters_none() == FAILURE) {\n \t\tRETURN_THROWS();\n \t}\n+PHP_VAR_SERIALIZE_INIT(var_hash);\n \n-\tPHP_VAR_SERIALIZE_INIT(var_hash);\n+/* flags */\n+ZVAL_LONG(&flags, intern->flags);\n+php_var_serialize(&buf, &flags, &var_hash);\n \n-\t/* flags */\n-\tZVAL_LONG(&flags, intern->flags);\n-\tphp_var_serialize(&buf, &flags, &var_hash);\n-\n-\t/* elements */\n-\twhile (current) {\n-\t\tsmart_str_appendc(&buf, ':');\n-\t\tnext = current->next;\n-\n-\t\tphp_var_serialize(&buf, &current->data, &var_hash);\n-\n-\t\tcurrent = next;\n-\t}\n+/* elements */\n+// FIX: Collect data values to local buffer to avoid use-after-free\n+{\n+    zval *data_array = NULL;\n+    int node_count = 0, i = 0;\n+    void *iter = current;\n+    // The actual node type is likely 'spl_ptr_llist_element' (from SPL linked list impl)\n+    typedef struct _spl_ptr_llist_element {\n+        struct _spl_ptr_llist_element *prev, *next;\n+        zval data;\n+    } spl_ptr_llist_element;\n+    // Count nodes\n+    while (iter) {\n+        node_count++;\n+        iter = ((spl_ptr_llist_element*)iter)->next;\n+    }\n+    if (node_count > 0) {\n+        data_array = safe_emalloc(node_count, sizeof(zval), 0);\n+        iter = current;\n+        for (i = 0; i < node_count; i++) {\n+            ZVAL_COPY(&data_array[i], &((spl_ptr_llist_element*)iter)->data);\n+            iter = ((spl_ptr_llist_element*)iter)->next;\n+        }\n+        for (i = 0; i < node_count; i++) {\n+            smart_str_appendc(&buf, ':');\n+            php_var_serialize(&buf, &data_array[i], &var_hash);\n+            zval_ptr_dtor(&data_array[i]);\n+        }\n+        efree(data_array);\n+    }\n+}\n \n-\t/* done */\n-\tPHP_VAR_SERIALIZE_DESTROY(var_hash);\n+/* done */\n+PHP_VAR_SERIALIZE_DESTROY(var_hash);\n \n-\tRETURN_STR(smart_str_extract(&buf));\n-} /* }}} */\n+RETURN_STR(smart_str_extract(&buf));} /* }}} */\n \n /* {{{ Unserializes storage */\n PHP_METHOD(SplDoublyLinkedList, unserialize)\n"}]