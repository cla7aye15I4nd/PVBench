[{"patch": "diff --git a/Modules/_lsprof.c b/Modules/_lsprof.c\nindex 5cf9eba243b..75adc9bbd45 100644\n--- a/Modules/_lsprof.c\n+++ b/Modules/_lsprof.c\n@@ -366,9 +366,20 @@ ptrace_enter_call(PyObject *self, void *key, PyObject *userObj)\n     pContext = pObj->freelistProfilerContext;\n     if (pContext) {\n         pObj->freelistProfilerContext = pContext->previous;\n+        /* Validate that the context from freelist is not corrupted */\n+        if (pContext->previous == (ProfilerContext*)0xDEADBEEF || \n+            pContext->ctxEntry == (ProfilerEntry*)0xDEADBEEF) {\n+            /* Context appears to be freed/corrupted, allocate new one */\n+            pContext = (ProfilerContext*)PyMem_Malloc(sizeof(ProfilerContext));\n+            if (pContext == NULL) {\n+                pObj->flags |= POF_NOMEMORY;\n+                goto restorePyerr;\n+            }\n+        }\n     }\n     else {\n-        /* free list exhausted, allocate a new one */\n+// FIXME: Crash CWE-416: Use After Free\n+         /* free list exhausted, allocate a new one */\n         pContext = (ProfilerContext*)\n             PyMem_Malloc(sizeof(ProfilerContext));\n         if (pContext == NULL) {\n@@ -755,13 +766,22 @@ profiler_enable(ProfilerObject *self, PyObject *args, PyObject *kwds)\n static void\n flush_unmatched(ProfilerObject *pObj)\n {\n-    while (pObj->currentProfilerContext) {\n-        ProfilerContext *pContext = pObj->currentProfilerContext;\n-        ProfilerEntry *profEntry= pContext->ctxEntry;\n+    ProfilerContext *pContext, *nextContext;\n+    \n+    // First pass: disconnect all contexts to prevent access during cleanup\n+    pContext = pObj->currentProfilerContext;\n+    while (pContext) {\n+        nextContext = pContext->previous;\n+        ProfilerEntry *profEntry = pContext->ctxEntry;\n         if (profEntry)\n             Stop(pObj, pContext, profEntry);\n-        else\n-            pObj->currentProfilerContext = pContext->previous;\n+        pContext = nextContext;\n+    }\n+    \n+    // Second pass: free all contexts safely\n+    while (pObj->currentProfilerContext) {\n+        pContext = pObj->currentProfilerContext;\n+        pObj->currentProfilerContext = pContext->previous;\n         if (pContext)\n             PyMem_Free(pContext);\n     }\n"}]