[{"patch": "diff --git a/Modules/readline.c b/Modules/readline.c\nindex 35655c70a46..a683228579a 100644\n--- a/Modules/readline.c\n+++ b/Modules/readline.c\n@@ -358,13 +358,29 @@ readline_append_history_file_impl(PyObject *module, int nelements,\n         if (!PyUnicode_FSConverter(filename_obj, &filename_bytes))\n             return NULL;\n         filename = PyBytes_AS_STRING(filename_bytes);\n+        \n+        /* Validate filename pointer before using it */\n+        if (filename == NULL) {\n+            Py_DECREF(filename_bytes);\n+            PyErr_SetString(PyExc_ValueError, \"invalid filename conversion\");\n+            return NULL;\n+        }\n     } else {\n         filename_bytes = NULL;\n-        filename = NULL;\n+// FIXME: Crash CWE-416: Use After Free\n+         filename = NULL;\n     }\n+    \n+    /* Defensive check for valid nelements parameter */\n+    if (nelements < 0) {\n+        Py_XDECREF(filename_bytes);\n+        PyErr_SetString(PyExc_ValueError, \"nelements must be non-negative\");\n+        return NULL;\n+    }\n+    \n     errno = err = append_history(\n         nelements - libedit_append_replace_history_offset, filename);\n-    if (!err && _history_length >= 0)\n+    if (!err && _history_length >= 0 && filename != NULL)\n         history_truncate_file(filename, _history_length);\n     Py_XDECREF(filename_bytes);\n     errno = err;\n"}]