{"patch": "diff --git a/src/ex_docmd.c b/src/ex_docmd.c\nindex 26acc07e0..99f90e95f 100644\n--- a/src/ex_docmd.c\n+++ b/src/ex_docmd.c\n@@ -3439,12 +3439,27 @@ append_command(char_u *cmd)\n     {\n \tif (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n \t{\n+\t    if (d + 4 >= IObuff + IOSIZE - 1)\n+\t        break;\n \t    s += enc_utf8 ? 2 : 1;\n \t    STRCPY(d, \"<a0>\");\n \t    d += 4;\n \t}\n-\telse\n+\telse {\n+\t    int n;\n+#ifdef FEAT_MBYTE\n+\t    n = MB_BYTE2LEN(*s);\n+#else\n+\t    n = 1;\n+#endif\n+\t    if (d + n >= IObuff + IOSIZE - 1)\n+\t        break;\n+#ifdef FEAT_MBYTE\n \t    MB_COPY_CHAR(s, d);\n+#else\n+\t    *d++ = *s++;\n+#endif\n+\t}\n     }\n     *d = NUL;\n }\n", "result": true}