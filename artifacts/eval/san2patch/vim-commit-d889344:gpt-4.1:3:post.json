{"patch": "diff --git a/src/ex_docmd.c b/src/ex_docmd.c\nindex 26acc07e0..ca1c0b478 100644\n--- a/src/ex_docmd.c\n+++ b/src/ex_docmd.c\n@@ -3437,18 +3437,32 @@ append_command(char_u *cmd)\n     d = IObuff + STRLEN(IObuff);\n     while (*s != NUL && d - IObuff < IOSIZE - 7)\n     {\n-\tif (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n-\t{\n-\t    s += enc_utf8 ? 2 : 1;\n-\t    STRCPY(d, \"<a0>\");\n-\t    d += 4;\n-\t}\n-\telse\n-\t    MB_COPY_CHAR(s, d);\n+        if (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n+        {\n+            s += enc_utf8 ? 2 : 1;\n+            if ((d - IObuff) <= IOSIZE - 6) { // 5 chars for \"<a0>\" + NUL\n+                STRCPY(d, \"<a0>\");\n+                d += 4;\n+            } else {\n+                break;\n+            }\n+// FIXME: Crash CWE-787: Out-of-bounds Write\n+        }\n+        else {\n+            // Ensure MB_COPY_CHAR does not overflow\n+            int remaining = IOSIZE - 1 - (int)(d - IObuff);    // leave space for NUL\n+            char_u *d_old = d;\n+            MB_COPY_CHAR(s, d);\n+            if ((d - d_old) > remaining) {\n+                d = d_old;\n+                break;\n+            }\n+        }\n     }\n     *d = NUL;\n }\n \n+\n #if defined(FEAT_EVAL) || defined(PROTO)\n /*\n  * If \"start\" points \"&opt\", \"&l:opt\", \"&g:opt\" or \"$ENV\" return a pointer to\n", "result": true}