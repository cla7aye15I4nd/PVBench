[{"patch": "diff --git a/src/ex_docmd.c b/src/ex_docmd.c\nindex 26acc07e0..793c925b9 100644\n--- a/src/ex_docmd.c\n+++ b/src/ex_docmd.c\n@@ -3435,16 +3435,24 @@ append_command(char_u *cmd)\n \n     STRCAT(IObuff, \": \");\n     d = IObuff + STRLEN(IObuff);\n-    while (*s != NUL && d - IObuff < IOSIZE - 7)\n-    {\n-\tif (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n-\t{\n-\t    s += enc_utf8 ? 2 : 1;\n-\t    STRCPY(d, \"<a0>\");\n-\t    d += 4;\n-\t}\n-\telse\n-\t    MB_COPY_CHAR(s, d);\n+    while (*s != NUL)\n+    {\n+        // Always ensure enough space for next write (4 for \"<a0>\", MB_MAXBYTES for character copy, 1 for NUL)\n+        int remain = (int)(IOSIZE - (d - IObuff));\n+        if (enc_utf8 ? (s[0] == 0xc2 && s[1] == 0xa0) : *s == 0xa0)\n+        {\n+            if (remain < 5)\n+                break;\n+            s += enc_utf8 ? 2 : 1;\n+            STRCPY(d, \"<a0>\");\n+            d += 4;\n+        }\n+        else\n+        {\n+            if (remain < MB_MAXBYTES + 1)\n+                break;\n+            MB_COPY_CHAR(s, d);\n+        }\n     }\n     *d = NUL;\n }\n"}]