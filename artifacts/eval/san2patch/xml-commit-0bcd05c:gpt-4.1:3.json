[{"patch": "diff --git a/HTMLparser.c b/HTMLparser.c\nindex d1395fa5..d6713063 100644\n--- a/HTMLparser.c\n+++ b/HTMLparser.c\n@@ -4615,78 +4615,79 @@ htmlParseContentInternal(htmlParserCtxtPtr ctxt) {\n \t     */\n \t    htmlParseScript(ctxt);\n \t} else {\n-\t    /*\n-\t     * Sometimes DOCTYPE arrives in the middle of the document\n-\t     */\n-\t    if ((CUR == '<') && (NXT(1) == '!') &&\n-\t\t(UPP(2) == 'D') && (UPP(3) == 'O') &&\n-\t\t(UPP(4) == 'C') && (UPP(5) == 'T') &&\n-\t\t(UPP(6) == 'Y') && (UPP(7) == 'P') &&\n-\t\t(UPP(8) == 'E')) {\n-\t\thtmlParseErr(ctxt, XML_HTML_STRUCURE_ERROR,\n-\t\t             \"Misplaced DOCTYPE declaration\\n\",\n-\t\t\t     BAD_CAST \"DOCTYPE\" , NULL);\n-\t\thtmlParseDocTypeDecl(ctxt);\n-\t    }\n+    /*\n+     * Sometimes DOCTYPE arrives in the middle of the document\n+     */\n+    if ((ctxt->input != NULL && ctxt->input->cur < ctxt->input->end) && (CUR == '<') && (NXT(1) == '!') &&\n+\t(UPP(2) == 'D') && (UPP(3) == 'O') &&\n+\t(UPP(4) == 'C') && (UPP(5) == 'T') &&\n+\t(UPP(6) == 'Y') && (UPP(7) == 'P') &&\n+\t(UPP(8) == 'E')) {\n+\thtmlParseErr(ctxt, XML_HTML_STRUCURE_ERROR,\n+\t             \"Misplaced DOCTYPE declaration\\n\",\n+\t\t     BAD_CAST \"DOCTYPE\" , NULL);\n+\thtmlParseDocTypeDecl(ctxt);\n+    }\n \n-\t    /*\n-\t     * First case :  a comment\n-\t     */\n-\t    if ((CUR == '<') && (NXT(1) == '!') &&\n-\t\t(NXT(2) == '-') && (NXT(3) == '-')) {\n-\t\thtmlParseComment(ctxt);\n-\t    }\n+    /*\n+     * First case :  a comment\n+     */\n+    if ((ctxt->input != NULL && ctxt->input->cur + 3 < ctxt->input->end) && (CUR == '<') && (NXT(1) == '!') &&\n+\t(NXT(2) == '-') && (NXT(3) == '-')) {\n+\thtmlParseComment(ctxt);\n+    }\n \n-\t    /*\n-\t     * Second case : a Processing Instruction.\n-\t     */\n-\t    else if ((CUR == '<') && (NXT(1) == '?')) {\n-\t\thtmlParsePI(ctxt);\n-\t    }\n+    /*\n+     * Second case : a Processing Instruction.\n+     */\n+    else if ((ctxt->input != NULL && ctxt->input->cur + 1 < ctxt->input->end) && (CUR == '<') && (NXT(1) == '?')) {\n+\thtmlParsePI(ctxt);\n+    }\n \n-\t    /*\n-\t     * Third case :  a sub-element.\n-\t     */\n-\t    else if (CUR == '<') {\n-\t\thtmlParseElementInternal(ctxt);\n-\t\tif (currentNode != NULL) xmlFree(currentNode);\n+    /*\n+     * Third case :  a sub-element.\n+     */\n+    else if ((ctxt->input != NULL && ctxt->input->cur < ctxt->input->end) && CUR == '<') {\n+\thtmlParseElementInternal(ctxt);\n+\tif (currentNode != NULL) xmlFree(currentNode);\n \n-\t\tcurrentNode = xmlStrdup(ctxt->name);\n-\t\tdepth = ctxt->nameNr;\n-\t    }\n+\tcurrentNode = xmlStrdup(ctxt->name);\n+\tdepth = ctxt->nameNr;\n+    }\n \n-\t    /*\n-\t     * Fourth case : a reference. If if has not been resolved,\n-\t     *    parsing returns it's Name, create the node\n-\t     */\n-\t    else if (CUR == '&') {\n-\t\thtmlParseReference(ctxt);\n-\t    }\n+    /*\n+     * Fourth case : a reference. If if has not been resolved,\n+     *    parsing returns it's Name, create the node\n+     */\n+    else if ((ctxt->input != NULL && ctxt->input->cur < ctxt->input->end) && CUR == '&') {\n+\thtmlParseReference(ctxt);\n+    }\n \n-\t    /*\n-\t     * Fifth case : end of the resource\n-\t     */\n-\t    else if (CUR == 0) {\n-\t\thtmlAutoCloseOnEnd(ctxt);\n-\t\tbreak;\n-\t    }\n+    /*\n+     * Fifth case : end of the resource\n+     */\n+    else if ((ctxt->input == NULL || ctxt->input->cur >= ctxt->input->end) || CUR == 0) {\n+\thtmlAutoCloseOnEnd(ctxt);\n+\tbreak;\n+    }\n \n-\t    /*\n-\t     * Last case, text. Note that References are handled directly.\n-\t     */\n-\t    else {\n-\t\thtmlParseCharData(ctxt);\n-\t    }\n+    /*\n+     * Last case, text. Note that References are handled directly.\n+// FIXME: Crash CWE-125: Out-of-bounds Read\n+     */\n+    else if (ctxt->input != NULL && ctxt->input->cur < ctxt->input->end) {\n+\thtmlParseCharData(ctxt);\n+    }\n \n-\t    if (cons == ctxt->nbChars) {\n-\t\tif (ctxt->node != NULL) {\n-\t\t    htmlParseErr(ctxt, XML_ERR_INTERNAL_ERROR,\n-\t\t                 \"detected an error in element content\\n\",\n-\t\t\t\t NULL, NULL);\n-\t\t}\n-\t\tbreak;\n-\t    }\n+    if (cons == ctxt->nbChars) {\n+\tif (ctxt->node != NULL) {\n+\t    htmlParseErr(ctxt, XML_ERR_INTERNAL_ERROR,\n+\t                 \"detected an error in element content\\n\",\n+\t\t\t NULL, NULL);\n \t}\n+\tbreak;\n+    }\n+}\n         GROW;\n     }\n     if (currentNode != NULL) xmlFree(currentNode);\n"}]