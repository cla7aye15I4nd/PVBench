[{"patch": "diff --git a/xpath.c b/xpath.c\nindex 5e3bb9ff..bc25f518 100644\n--- a/xpath.c\n+++ b/xpath.c\n@@ -9157,7 +9157,8 @@ xmlXPathSubstringFunction(xmlXPathParserContextPtr ctxt, int nargs) {\n \n     CAST_TO_NUMBER;\n     CHECK_TYPE(XPATH_NUMBER);\n-    start = valuePop(ctxt);\n+// FIXME: Crash CWE-681: Incorrect Conversion between Numeric Types\n+     start = valuePop(ctxt);\n     in = start->floatval;\n     xmlXPathReleaseObject(ctxt->context, start);\n     CAST_TO_STRING;\n@@ -9187,33 +9188,43 @@ xmlXPathSubstringFunction(xmlXPathParserContextPtr ctxt, int nargs) {\n          * First we go to integer form, rounding up\n \t * and checking for special cases\n          */\n-        i = (int) in;\n-        if (((double)i)+0.5 <= in) i++;\n+        /* Validate numeric ranges before conversion to prevent overflow */\n+        if (in <= (double)INT_MIN || in >= (double)INT_MAX) {\n+            ret = NULL;\n+        } else {\n+            i = (int) in;\n+            if (((double)i)+0.5 <= in) i++;\n \n-\tif (xmlXPathIsInf(le) == 1) {\n-\t    l = m;\n-\t    if (i < 1)\n-\t\ti = 1;\n-\t}\n-\telse if (xmlXPathIsInf(le) == -1 || le < 0.0)\n-\t    l = 0;\n-\telse {\n-\t    l = (int) le;\n-\t    if (((double)l)+0.5 <= le) l++;\n-\t}\n+            if (xmlXPathIsInf(le) == 1) {\n+                l = m;\n+                if (i < 1)\n+                    i = 1;\n+            }\n+            else if (xmlXPathIsInf(le) == -1 || le < 0.0)\n+                l = 0;\n+            else {\n+                if (le <= (double)INT_MIN || le >= (double)INT_MAX) {\n+                    /* Use safe fallback for out-of-range length */\n+                    l = (le > 0) ? m : 0;\n+                } else {\n+                    l = (int) le;\n+                    if (((double)l)+0.5 <= le) l++;\n+                }\n+            }\n \n-\t/* Now we normalize inidices */\n-        i -= 1;\n-        l += i;\n-        if (i < 0)\n-            i = 0;\n-        if (l > m)\n-            l = m;\n+            /* Now we normalize inidices */\n+            i -= 1;\n+            l += i;\n+            if (i < 0)\n+                i = 0;\n+            if (l > m)\n+                l = m;\n \n-        /* number of chars to copy */\n-        l -= i;\n+            /* number of chars to copy */\n+            l -= i;\n \n-        ret = xmlUTF8Strsub(str->stringval, i, l);\n+            ret = xmlUTF8Strsub(str->stringval, i, l);\n+        }\n     }\n     else {\n         ret = NULL;\n"}]