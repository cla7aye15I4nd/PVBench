[{"patch": "diff --git a/valid.c b/valid.c\nindex 19f84b82..80d8df03 100644\n--- a/valid.c\n+++ b/valid.c\n@@ -1259,66 +1259,80 @@ xmlSnprintfElementContent(char *buf, int size, xmlElementContentPtr content, int\n     }\n     if (englob) strcat(buf, \"(\");\n     switch (content->type) {\n-        case XML_ELEMENT_CONTENT_PCDATA:\n-            strcat(buf, \"#PCDATA\");\n-\t    break;\n-\tcase XML_ELEMENT_CONTENT_ELEMENT:\n-\t    if (content->prefix != NULL) {\n-\t\tif (size - len < xmlStrlen(content->prefix) + 10) {\n-\t\t    strcat(buf, \" ...\");\n-\t\t    return;\n-\t\t}\n-\t\tstrcat(buf, (char *) content->prefix);\n-\t\tstrcat(buf, \":\");\n-\t    }\n-\t    if (size - len < xmlStrlen(content->name) + 10) {\n-\t\tstrcat(buf, \" ...\");\n-\t\treturn;\n-\t    }\n-\t    if (content->name != NULL)\n-\t\tstrcat(buf, (char *) content->name);\n-\t    break;\n-\tcase XML_ELEMENT_CONTENT_SEQ:\n-\t    if ((content->c1->type == XML_ELEMENT_CONTENT_OR) ||\n-\t        (content->c1->type == XML_ELEMENT_CONTENT_SEQ))\n-\t\txmlSnprintfElementContent(buf, size, content->c1, 1);\n-\t    else\n-\t\txmlSnprintfElementContent(buf, size, content->c1, 0);\n-\t    len = strlen(buf);\n-\t    if (size - len < 50) {\n-\t\tif ((size - len > 4) && (buf[len - 1] != '.'))\n-\t\t    strcat(buf, \" ...\");\n-\t\treturn;\n-\t    }\n-            strcat(buf, \" , \");\n-\t    if (((content->c2->type == XML_ELEMENT_CONTENT_OR) ||\n-\t\t (content->c2->ocur != XML_ELEMENT_CONTENT_ONCE)) &&\n-\t\t(content->c2->type != XML_ELEMENT_CONTENT_ELEMENT))\n-\t\txmlSnprintfElementContent(buf, size, content->c2, 1);\n-\t    else\n-\t\txmlSnprintfElementContent(buf, size, content->c2, 0);\n-\t    break;\n-\tcase XML_ELEMENT_CONTENT_OR:\n-\t    if ((content->c1->type == XML_ELEMENT_CONTENT_OR) ||\n-\t        (content->c1->type == XML_ELEMENT_CONTENT_SEQ))\n-\t\txmlSnprintfElementContent(buf, size, content->c1, 1);\n-\t    else\n-\t\txmlSnprintfElementContent(buf, size, content->c1, 0);\n-\t    len = strlen(buf);\n-\t    if (size - len < 50) {\n-\t\tif ((size - len > 4) && (buf[len - 1] != '.'))\n-\t\t    strcat(buf, \" ...\");\n-\t\treturn;\n-\t    }\n-            strcat(buf, \" | \");\n-\t    if (((content->c2->type == XML_ELEMENT_CONTENT_SEQ) ||\n-\t\t (content->c2->ocur != XML_ELEMENT_CONTENT_ONCE)) &&\n-\t\t(content->c2->type != XML_ELEMENT_CONTENT_ELEMENT))\n-\t\txmlSnprintfElementContent(buf, size, content->c2, 1);\n-\t    else\n-\t\txmlSnprintfElementContent(buf, size, content->c2, 0);\n-\t    break;\n-    }\n+        case XML_ELEMENT_CONTENT_PCDATA: {\n+            size_t len = strlen(buf);\n+            if ((size_t)(size - len) > strlen(\"#PCDATA\")) {\n+                strncat(buf, \"#PCDATA\", size - len - 1);\n+            } else {\n+                // Can't append, truncate\n+                if (size - len > 4) strncat(buf, \" ...\", size - len - 1);\n+            }\n+            break;\n+        }\n+    case XML_ELEMENT_CONTENT_ELEMENT: {\n+        size_t len = strlen(buf);\n+        if (content->prefix != NULL) {\n+            size_t preflen = strlen((char *)content->prefix);\n+            if (size - len < preflen + 10) {\n+                if (size - len > 4) strncat(buf, \" ...\", size - len - 1);\n+                return;\n+            }\n+            strncat(buf, (char *) content->prefix, size - strlen(buf) - 1);\n+            strncat(buf, \":\", size - strlen(buf) - 1);\n+        }\n+        if (content->name != NULL) {\n+            size_t namelen = strlen((char *)content->name);\n+            len = strlen(buf);\n+            if (size - len < namelen + 10) {\n+                if (size - len > 4) strncat(buf, \" ...\", size - len - 1);\n+                return;\n+            }\n+            strncat(buf, (char *) content->name, size - strlen(buf) - 1);\n+        }\n+        break;\n+    }\n+    case XML_ELEMENT_CONTENT_SEQ:\n+        if ((content->c1->type == XML_ELEMENT_CONTENT_OR) ||\n+            (content->c1->type == XML_ELEMENT_CONTENT_SEQ))\n+            xmlSnprintfElementContent(buf, size, content->c1, 1);\n+        else\n+            xmlSnprintfElementContent(buf, size, content->c1, 0);\n+        len = strlen(buf);\n+        if (size - len < 50) {\n+            if ((size - len > 4) && (buf[len - 1] != '.'))\n+                strncat(buf, \" ...\", size - len - 1);\n+            return;\n+        }\n+        strncat(buf, \" , \", size - strlen(buf) - 1);\n+        if (((content->c2->type == XML_ELEMENT_CONTENT_OR) ||\n+             (content->c2->ocur != XML_ELEMENT_CONTENT_ONCE)) &&\n+            (content->c2->type != XML_ELEMENT_CONTENT_ELEMENT))\n+            xmlSnprintfElementContent(buf, size, content->c2, 1);\n+        else\n+            xmlSnprintfElementContent(buf, size, content->c2, 0);\n+        break;\n+    case XML_ELEMENT_CONTENT_OR:\n+        if ((content->c1->type == XML_ELEMENT_CONTENT_OR) ||\n+            (content->c1->type == XML_ELEMENT_CONTENT_SEQ))\n+            xmlSnprintfElementContent(buf, size, content->c1, 1);\n+        else\n+            xmlSnprintfElementContent(buf, size, content->c1, 0);\n+        len = strlen(buf);\n+        if (size - len < 50) {\n+            if ((size - len > 4) && (buf[len - 1] != '.'))\n+                strncat(buf, \" ...\", size - len - 1);\n+            return;\n+        }\n+        strncat(buf, \" | \", size - strlen(buf) - 1);\n+        if (((content->c2->type == XML_ELEMENT_CONTENT_SEQ) ||\n+             (content->c2->ocur != XML_ELEMENT_CONTENT_ONCE)) &&\n+            (content->c2->type != XML_ELEMENT_CONTENT_ELEMENT))\n+            xmlSnprintfElementContent(buf, size, content->c2, 1);\n+        else\n+            xmlSnprintfElementContent(buf, size, content->c2, 0);\n+        break;\n+}\n+\n     if (englob)\n         strcat(buf, \")\");\n     switch (content->ocur) {\n"}]